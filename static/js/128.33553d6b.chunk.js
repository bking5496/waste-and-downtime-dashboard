"use strict";(self.webpackChunkwaste_and_downtime_dashboard=self.webpackChunkwaste_and_downtime_dashboard||[]).push([[128],{6316:(e,t,a)=>{a.d(t,{$C:()=>S,KW:()=>l,WA:()=>c,b6:()=>u,dj:()=>f,fetchLiveSessionByMachine:()=>m,yw:()=>d});var n=a(7051),o=a(1737);const s=(e,t,a)=>"".concat(e,"_").concat(t,"_").concat(a);let r=new Map,i=0;const c=async e=>{const t=s(e.machineName,e.shift,e.date),a={id:t,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()};if(r.set(t,a),o.$G)try{const{error:a}=await o.ND.from("live_sessions").upsert({id:t,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()},{onConflict:"id"});return a?(console.error("Failed to upsert live session:",a.message),!1):(console.log("\u2705 Live session synced to Supabase:",t),!0)}catch(n){return console.error("Failed to upsert live session:",n),!1}return!0},l=async(e,t,a)=>{const n=s(e,t,a);if(r.delete(n),o.$G)try{const{error:e}=await o.ND.from("live_sessions").delete().eq("id",n);return!e||(console.error("Failed to delete live session:",e.message),!1)}catch(i){return console.error("Failed to delete live session:",i),!1}return!0},d=async()=>{const e=Date.now(),t=(new Date).toISOString().split("T")[0],a=e-i<3e4;if(o.$G)try{const{data:a,error:n}=await o.ND.from("live_sessions").select("*").eq("session_date",t).eq("is_locked",!0);return n?(console.error("Failed to fetch live sessions:",n.message),Array.from(r.values()).filter(e=>e.session_date===t&&e.is_locked)):(r.clear(),(a||[]).forEach(e=>{r.set(e.id,e)}),i=e,console.log("\ud83d\udccb Fetched active sessions from Supabase:",(a||[]).length,null===a||void 0===a?void 0:a.map(e=>e.machine_name)),a||[])}catch(n){return console.error("Failed to fetch live sessions:",n),Array.from(r.values()).filter(e=>e.session_date===t&&e.is_locked)}return a?Array.from(r.values()).filter(e=>e.session_date===t&&e.is_locked):[]},m=async(e,t,a)=>{const n=s(e,t,a);if(r.has(n))return r.get(n)||null;if(!o.$G)return null;try{const{data:t,error:a}=await o.ND.from("live_sessions").select("*").eq("id",n).eq("is_locked",!0).maybeSingle();return a?(console.error("Failed to fetch session:",a.message),null):(t&&(r.set(n,t),console.log("\ud83d\udccb Restored session from Supabase:",e)),t)}catch(i){return console.error("Failed to fetch session by machine:",i),null}},u=e=>{if(!o.$G)return()=>{};(new Date).toISOString().split("T")[0];const t=o.ND.channel("live-sessions-changes").on("postgres_changes",{event:"*",schema:"public",table:"live_sessions"},async t=>{console.log("\ud83d\udd04 Real-time session update received:",t.eventType);const a=await d();e(a)}).subscribe(e=>{console.log("\ud83d\udce1 Session subscription status:",e)});return()=>{o.ND.removeChannel(t)}};let h=[];let g=[];const f=e=>{const t=(0,n.A)((0,n.A)({},e),{},{id:"".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),timestamp:new Date});h=[t,...h].slice(0,50),g.forEach(e=>e([...h])),o.$G&&p(t)},p=async e=>{try{const t=o.ND.channel("activity-broadcast");await t.send({type:"broadcast",event:"activity",payload:(0,n.A)((0,n.A)({},e),{},{timestamp:e.timestamp.toISOString()})})}catch(t){}},S=e=>{g.push(e),e([...h]);let t=null;return o.$G&&(t=o.ND.channel("activity-broadcast").on("broadcast",{event:"activity"},e=>{const t=e.payload,a=(0,n.A)((0,n.A)({},t),{},{timestamp:new Date(t.timestamp)});h.some(e=>e.id===a.id)||(h=[a,...h].slice(0,50),g.forEach(e=>e([...h])))}).subscribe()),()=>{g=g.filter(t=>t!==e),t&&o.ND.removeChannel(t)}}},6451:(e,t,a)=>{a.d(t,{PY:()=>n,rE:()=>o,wK:()=>s});const n=[],o=["Start-up Waste","Changeover Waste","Defective Product","Material Spillage"],s=["Machine Breakdown","Scheduled Maintenance","Changeover","Material Shortage"]},8283:(e,t,a)=>{a.d(t,{Bh:()=>l,D$:()=>u,F$:()=>N,GF:()=>M,Hc:()=>_,IN:()=>D,LO:()=>v,Rg:()=>I,Rn:()=>C,Yn:()=>W,bR:()=>y,mg:()=>h,nN:()=>d,nt:()=>R,te:()=>E,zl:()=>A});var n=a(7051),o=a(6451),s=a(1737);const r="waste_downtime_history",i="machines_data",c="failed_submissions_queue",l=()=>{const e=localStorage.getItem(c);if(!e)return[];try{return JSON.parse(e)}catch(t){return[]}},d=(e,t)=>{const a=l(),n={id:"failed_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:(new Date).toISOString(),retryCount:0,maxRetries:3,data:e,error:t};a.push(n),localStorage.setItem(c,JSON.stringify(a))},m=e=>{const t=l().filter(t=>t.id!==e);localStorage.setItem(c,JSON.stringify(t))},u=async()=>{if(!s.$G)return{succeeded:0,failed:0,remaining:l().length};const e=l();let t=0,a=0;for(const r of e)if(r.retryCount>=r.maxRetries)a++;else try{await(0,s.jw)(r.data.shiftData,r.data.wasteEntries,r.data.downtimeEntries,r.data.speedEntries,r.data.sachetMassEntries,r.data.looseCasesEntries,r.data.palletScanEntries),m(r.id),t++}catch(o){const e=l().map(e=>e.id===r.id?(0,n.A)((0,n.A)({},e),{},{retryCount:e.retryCount+1,error:String(o)}):e);localStorage.setItem(c,JSON.stringify(e)),a++}return{succeeded:t,failed:a,remaining:l().length}},h=()=>{const e="last_storage_cleanup",t=localStorage.getItem(e),a=new Date;if(t){const e=new Date(t);if((a.getTime()-e.getTime())/36e5<24)return}const n=(()=>{const e=v(),t=new Date,a=new Date(t.getTime()-7776e6);let n=e.filter(e=>new Date(e.date)>=a);n.length>1e3&&(n=n.slice(0,1e3));const o=e.length-n.length;return o>0&&(localStorage.setItem(r,JSON.stringify(n)),console.log("Cleaned up ".concat(o," old history entries"))),{removed:o,remaining:n.length}})();localStorage.setItem(e,a.toISOString()),n.removed>0&&console.log("Storage cleanup: removed ".concat(n.removed," entries, ").concat(n.remaining," remaining"))};let g=!0,f=null,p=[];const S=e=>({id:e.id,name:e.name,status:e.status,currentOperator:e.current_operator,currentOrder:e.current_order,currentShift:e.current_shift,lastSubmission:e.last_submission,todayWaste:e.today_waste,todayDowntime:e.today_downtime,subMachineCount:e.sub_machine_count}),w=e=>({id:e.id,name:e.name,status:e.status,current_operator:e.currentOperator,current_order:e.currentOrder,current_shift:e.currentShift,last_submission:e.lastSubmission,today_waste:e.todayWaste,today_downtime:e.todayDowntime,sub_machine_count:e.subMachineCount}),y=async()=>{try{const e=await(0,s.Dn)();if(e.length>0)return f=e.map(S),localStorage.setItem(i,JSON.stringify(f)),localStorage.setItem("machines_last_sync",(new Date).toISOString()),f;{console.log("No machines in Supabase, syncing defaults...");const e=o.PY.map(w);return await(0,s.ri)(e),f=o.PY,localStorage.setItem(i,JSON.stringify(o.PY)),o.PY}}catch(e){return console.error("Failed to initialize from Supabase, using localStorage:",e),g=!1,b()}},_=e=>{p.push(e);const t=(0,s.RS)(e=>{f=e.map(S),localStorage.setItem(i,JSON.stringify(f)),p.forEach(e=>e(f))},()=>(f||b()).map(w));return()=>{p=p.filter(t=>t!==e),0===p.length&&t()}},b=()=>{const e=localStorage.getItem(i);if(!e)return localStorage.setItem(i,JSON.stringify(o.PY)),o.PY;try{return JSON.parse(e)}catch(t){return o.PY}},D=e=>{const t=v();t.unshift(e),localStorage.setItem(r,JSON.stringify(t)),O(e.machine,e.submittedAt.toISOString())},v=()=>{const e=localStorage.getItem(r);if(!e)return[];try{return JSON.parse(e).map(e=>(0,n.A)((0,n.A)({},e),{},{submittedAt:new Date(e.submittedAt),wasteEntries:e.wasteEntries.map(e=>(0,n.A)((0,n.A)({},e),{},{timestamp:new Date(e.timestamp)})),downtimeEntries:e.downtimeEntries.map(e=>(0,n.A)((0,n.A)({},e),{},{timestamp:new Date(e.timestamp)}))}))}catch(t){return[]}},N=()=>{const e=(new Date).toISOString().split("T")[0],t=v().filter(t=>t.date===e);return{totalWaste:t.reduce((e,t)=>e+t.totalWaste,0),totalDowntime:t.reduce((e,t)=>e+t.totalDowntime,0),submissionCount:t.length}},O=(e,t)=>{const a=I(),n=a.findIndex(t=>t.name===e);-1!==n&&(a[n].lastSubmission=J(new Date(t))),localStorage.setItem(i,JSON.stringify(a))},I=()=>f||b(),E=async(e,t)=>{const a=I(),o=a.findIndex(t=>t.id===e);if(-1!==o&&(a[o]=(0,n.A)((0,n.A)({},a[o]),t),f=a,localStorage.setItem(i,JSON.stringify(a)),g))try{await(0,s.hx)(w(a[o]))}catch(r){console.error("Failed to sync machine update to Supabase:",r)}},A=async e=>{const t=I();if(t.push(e),f=t,localStorage.setItem(i,JSON.stringify(t)),g)try{await(0,s.hx)(w(e))}catch(a){console.error("Failed to sync new machine to Supabase:",a)}},C=async e=>{const t=I().filter(t=>t.id!==e);if(f=t,localStorage.setItem(i,JSON.stringify(t)),g)try{await(0,s._T)(e)}catch(a){console.error("Failed to delete machine from Supabase:",a)}},J=e=>{const t=(new Date).getTime()-e.getTime(),a=Math.floor(t/6e4),n=Math.floor(a/60),o=Math.floor(n/24);return a<1?"Just now":a<60?"".concat(a," min ago"):n<24?"".concat(n," hour").concat(n>1?"s":""," ago"):"".concat(o," day").concat(o>1?"s":""," ago")},M=(e,t)=>{const a=[];e.forEach(e=>{const t=[e.date,e.shift,e.operatorName,e.machine,e.orderNumber,e.product,e.batchNumber],n=new Date(e.submittedAt).toLocaleString();e.wasteEntries&&e.wasteEntries.length>0&&e.wasteEntries.forEach(e=>{a.push([...t,"Waste",e.wasteType,e.waste.toFixed(2),"","",n])}),e.downtimeEntries&&e.downtimeEntries.length>0&&e.downtimeEntries.forEach(e=>{a.push([...t,"Downtime","","",e.downtimeReason,e.downtime.toString(),n])}),e.wasteEntries&&0!==e.wasteEntries.length||e.downtimeEntries&&0!==e.downtimeEntries.length||a.push([...t,"Summary","",e.totalWaste.toFixed(2),"",e.totalDowntime.toString(),n])});const n=[["Date","Shift","Operator","Machine","Order Number","Product","Batch Number","Entry Type","Waste Type","Waste (kg)","Downtime Reason","Downtime (min)","Submitted At"].join(","),...a.map(e=>e.map(e=>'"'.concat(e,'"')).join(","))].join("\n"),o=new Blob([n],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),r=URL.createObjectURL(o);s.setAttribute("href",r),s.setAttribute("download","".concat(t,".csv")),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)},k="line_speed_",F=e=>{const t=e.match(/^(.+?)\s*-\s*Machine\s*\d+$/i);return t?t[1].trim():e},P=(e,t,a)=>"".concat(k).concat(e,"_").concat(t,"_").concat(a),R=(e,t,a,n)=>{const o=F(e),s=P(o,t,a),r={speed:n,updatedAt:(new Date).toISOString(),updatedBy:e};localStorage.setItem(s,JSON.stringify(r)),console.log("\ud83d\udcbe Saved line speed ".concat(n," PPM for ").concat(o))},W=(e,t,a)=>{const n=F(e),o=P(n,t,a),s=localStorage.getItem(o);if(!s)return null;try{const e=JSON.parse(s);return console.log("\ud83d\udcd6 Loaded line speed ".concat(e.speed," PPM for ").concat(n," (set by ").concat(e.updatedBy,")")),e}catch(r){return null}}}}]);
//# sourceMappingURL=128.33553d6b.chunk.js.map