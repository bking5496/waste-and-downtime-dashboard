"use strict";(self.webpackChunkwaste_and_downtime_dashboard=self.webpackChunkwaste_and_downtime_dashboard||[]).push([[640],{2640:(e,s,a)=>{a.r(s),a.d(s,{default:()=>J});var t=a(7051),n=a(5043),i=a(8163),r=a(6446),c=a(9570),l=a(6820),o=a(3113),d=a(579);const m=e=>{let{operatorName:s,setOperatorName:a,machine:t,setMachine:n,orderNumber:i,setOrderNumber:r,product:c,setProduct:l,batchNumber:o,setBatchNumber:m,hideMachine:u=!1,disabled:h=!1}=e;return(0,d.jsxs)("div",{className:"main-form-fields",children:[(0,d.jsxs)("div",{className:"form-field",children:[(0,d.jsx)("label",{htmlFor:"operatorNumber",className:"form-label",children:"Operator Number"}),(0,d.jsx)("input",{type:"text",className:"form-input",id:"operatorNumber",value:s,onChange:e=>a(e.target.value),placeholder:"Enter operator number (e.g., 042)",disabled:h})]}),!u&&(0,d.jsxs)("div",{className:"form-field",children:[(0,d.jsx)("label",{htmlFor:"machine",className:"form-label",children:"Machine"}),(0,d.jsx)("input",{type:"text",className:"form-input",id:"machine",value:t,readOnly:!0,disabled:h})]}),(0,d.jsxs)("div",{className:"form-field",children:[(0,d.jsx)("label",{htmlFor:"orderNumber",className:"form-label",children:"Order Number"}),(0,d.jsx)("input",{type:"text",className:"form-input",id:"orderNumber",value:i,onChange:e=>r(e.target.value),placeholder:"Enter order number",disabled:h})]}),(0,d.jsxs)("div",{className:"form-field",children:[(0,d.jsx)("label",{htmlFor:"product",className:"form-label",children:"Product"}),(0,d.jsx)("input",{type:"text",className:"form-input",id:"product",value:c,onChange:e=>l(e.target.value),placeholder:"Enter product name",disabled:h})]}),(0,d.jsxs)("div",{className:"form-field",children:[(0,d.jsx)("label",{htmlFor:"batchNumber",className:"form-label",children:"Batch Number"}),(0,d.jsx)("input",{type:"text",className:"form-input",id:"batchNumber",value:o,onChange:e=>m(e.target.value),placeholder:"Enter batch number",disabled:h})]})]})};var u=a(108),h=a(2291),p=a(7734),N=a(2185),x=a(6026),b=a(6150),g=a(8643),j=a(163),v=a(4240),f=a(7869);const y=["#f87171","#fbbf24","#34d399","#60a5fa","#a78bfa","#f472b6"],w=e=>{let{message:s,icon:a}=e;return(0,d.jsxs)("div",{className:"chart-empty-state",children:[(0,d.jsx)("span",{className:"empty-icon",children:a}),(0,d.jsx)("span",{className:"empty-text",children:s})]})},S=e=>{let{wasteEntries:s,downtimeEntries:a}=e;const t=s.reduce((e,s)=>{const a=e.find(e=>e.name===s.wasteType);return a?a.value+=s.waste:e.push({name:s.wasteType,value:s.waste}),e},[]),n=a.reduce((e,s)=>{const a=e.find(e=>e.name===s.downtimeReason);return a?a.value+=s.downtime:e.push({name:s.downtimeReason,value:s.downtime}),e},[]);return(0,d.jsxs)("div",{className:"charts-grid",children:[(0,d.jsxs)("div",{className:"chart-container",children:[(0,d.jsx)("h4",{className:"chart-title",children:"Waste by Type"}),0===t.length?(0,d.jsx)(w,{message:"No waste entries yet",icon:"\ud83d\udcca"}):(0,d.jsx)("div",{className:"chart-wrapper",children:(0,d.jsx)(u.u,{width:"100%",height:180,children:(0,d.jsxs)(h.E,{data:t,margin:{top:10,right:10,left:-10,bottom:0},children:[(0,d.jsx)(p.d,{strokeDasharray:"3 3",stroke:"rgba(0,245,255,0.1)"}),(0,d.jsx)(N.W,{dataKey:"name",tick:{fill:"#00f5ff",fontSize:11},axisLine:{stroke:"rgba(0,245,255,0.2)"},tickLine:!1}),(0,d.jsx)(x.h,{tick:{fill:"#00f5ff",fontSize:11},axisLine:{stroke:"rgba(0,245,255,0.2)"},tickLine:!1}),(0,d.jsx)(b.m,{contentStyle:{background:"rgba(10,25,40,0.95)",border:"1px solid rgba(0,245,255,0.2)",borderRadius:"8px",color:"#f8fafc"}}),(0,d.jsx)(g.y,{dataKey:"value",fill:"#f87171",name:"Waste (kg)",radius:[4,4,0,0]})]})})})]}),(0,d.jsxs)("div",{className:"chart-container",children:[(0,d.jsx)("h4",{className:"chart-title",children:"Downtime by Reason"}),0===n.length?(0,d.jsx)(w,{message:"No downtime entries yet",icon:"\u23f1\ufe0f"}):(0,d.jsxs)("div",{className:"chart-wrapper",children:[(0,d.jsx)(u.u,{width:"100%",height:180,children:(0,d.jsxs)(j.r,{children:[(0,d.jsx)(v.F,{data:n,cx:"50%",cy:"50%",labelLine:!1,label:e=>{let{name:s,percent:a}=e;return a>.1?"".concat((100*a).toFixed(0),"%"):""},outerRadius:65,innerRadius:35,fill:"#8884d8",dataKey:"value",stroke:"rgba(15,23,42,0.5)",strokeWidth:2,children:n.map((e,s)=>(0,d.jsx)(f.f,{fill:y[s%y.length]},"cell-".concat(s)))}),(0,d.jsx)(b.m,{contentStyle:{background:"rgba(10,25,40,0.95)",border:"1px solid rgba(0,245,255,0.2)",borderRadius:"8px",color:"#f8fafc"},formatter:e=>["".concat(e," min"),"Duration"]})]})}),(0,d.jsx)("div",{className:"chart-legend",children:n.map((e,s)=>(0,d.jsxs)("div",{className:"legend-item",children:[(0,d.jsx)("span",{className:"legend-dot",style:{background:y[s%y.length]}}),(0,d.jsx)("span",{className:"legend-label",children:e.name})]},e.name))})]})]})]})};var C=a(6353),_=a(9355);const k=e=>{let{isOpen:s,onClose:a,onScan:t,recentScans:i=[]}=e;const[l,o]=(0,n.useState)(null),[,m]=(0,n.useState)(!1),[u,h]=(0,n.useState)(null),[p,N]=(0,n.useState)(!1),x=(0,n.useRef)(null),b=(0,n.useRef)(null),g=(0,n.useRef)(s);(0,n.useEffect)(()=>{g.current=s},[s]),(0,n.useEffect)(()=>{if(s&&b.current){const e=setTimeout(()=>{v()},100);return()=>clearTimeout(e)}return()=>{j()}},[s]);const j=async()=>{if(x.current){try{x.current.getState()===_.Qq.SCANNING&&await x.current.stop(),x.current.clear()}catch(e){console.error("Error stopping scanner:",e)}x.current=null}m(!1)},v=async()=>{x.current&&await j();try{o(null),m(!0);const e=new _.j9("qr-reader");x.current=e,await e.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250},aspectRatio:1},e=>{f(e)},()=>{})}catch(e){console.error("QR Scanner error:",e),m(!1),e.toString().includes("NotAllowedError")?o("Camera permission denied. Please allow camera access to scan QR codes."):e.toString().includes("NotFoundError")?o("No camera found. Please ensure your device has a camera."):o("Failed to start scanner: ".concat(e.message||e))}},f=async e=>{if(u!==e){if(i.includes(e))return o('Pallet "'.concat(e,'" was already scanned this session!')),void setTimeout(()=>o(null),3e3);h(e),N(!0),navigator.vibrate&&navigator.vibrate(200),await j(),t(e),setTimeout(()=>{N(!1),h(null),s&&v()},1500)}},y=()=>{j(),a()};return s?(0,d.jsx)(c.N,{children:(0,d.jsx)(r.P.div,{className:"qr-scanner-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:y,children:(0,d.jsxs)(r.P.div,{className:"qr-scanner-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("div",{className:"qr-scanner-header",children:[(0,d.jsxs)("h3",{children:[(0,d.jsx)("span",{className:"scanner-icon",children:"\ud83d\udcf7"}),"Scan Pallet QR Code"]}),(0,d.jsx)("button",{className:"qr-close-btn",onClick:y,children:"\u2715"})]}),(0,d.jsxs)("div",{className:"qr-scanner-body",ref:b,children:[(0,d.jsx)(c.N,{children:p&&(0,d.jsxs)(r.P.div,{className:"scan-success-overlay",initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},children:[(0,d.jsx)("div",{className:"success-checkmark",children:"\u2713"}),(0,d.jsx)("p",{children:"Pallet Scanned!"}),(0,d.jsx)("span",{className:"scanned-code",children:u})]})}),l&&(0,d.jsxs)("div",{className:"qr-error-message",children:[(0,d.jsx)("span",{className:"error-icon",children:"\u26a0\ufe0f"}),l]}),(0,d.jsx)("div",{id:"qr-reader",className:"qr-reader-container"}),(0,d.jsxs)("div",{className:"qr-instructions",children:[(0,d.jsx)("p",{children:"Position the QR code within the frame"}),i.length>0&&(0,d.jsxs)("span",{className:"scan-count",children:[i.length," pallets scanned this shift"]})]})]}),(0,d.jsx)("div",{className:"qr-scanner-footer",children:(0,d.jsx)("button",{className:"qr-cancel-btn",onClick:y,children:"Done Scanning"})})]})})}):null};var E=a(6451),R=a(1737),A=a(8283),T=a(6316),D=a(9216),P=a(1187),O=a(6886),M=a(3986);const I=["variant","size","icon","iconPosition","loading","fullWidth","disabled","children","className"],q=e=>{let{variant:s="primary",size:a="md",icon:n,iconPosition:i="left",loading:r=!1,fullWidth:c=!1,disabled:l,children:o,className:m=""}=e,u=(0,M.A)(e,I);const h=l||r;return(0,d.jsxs)("button",(0,t.A)((0,t.A)({className:"mc-btn mc-btn--".concat(s," mc-btn--").concat(a," ").concat(c?"mc-btn--full":""," ").concat(m),disabled:h},u),{},{children:[r&&(0,d.jsxs)("span",{className:"mc-btn__loader",children:[(0,d.jsx)("span",{className:"mc-btn__loader-dot"}),(0,d.jsx)("span",{className:"mc-btn__loader-dot"}),(0,d.jsx)("span",{className:"mc-btn__loader-dot"})]}),!r&&n&&"left"===i&&(0,d.jsx)("span",{className:"mc-btn__icon",children:n}),(0,d.jsx)("span",{className:"mc-btn__text",children:o}),!r&&n&&"right"===i&&(0,d.jsx)("span",{className:"mc-btn__icon",children:n})]}))},F=e=>{let{isOpen:s,onClose:a,title:t,subtitle:i,size:l="md",children:o,footer:m,closeOnOverlay:u=!0,showCloseButton:h=!0}=e;return(0,n.useEffect)(()=>(document.body.style.overflow=s?"hidden":"",()=>{document.body.style.overflow=""}),[s]),(0,n.useEffect)(()=>{const e=e=>{"Escape"===e.key&&s&&a()};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[s,a]),(0,d.jsx)(c.N,{children:s&&(0,d.jsxs)(r.P.div,{className:"mc-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},onClick:u?a:void 0,children:[(0,d.jsx)("div",{className:"mc-modal-scanlines"}),(0,d.jsxs)(r.P.div,{className:"mc-modal mc-modal--".concat(l),initial:{opacity:0,scale:.95,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:20},transition:{duration:.2,ease:[.4,0,.2,1]},onClick:e=>e.stopPropagation(),children:[(0,d.jsx)("div",{className:"mc-modal__corner mc-modal__corner--tl"}),(0,d.jsx)("div",{className:"mc-modal__corner mc-modal__corner--tr"}),(0,d.jsx)("div",{className:"mc-modal__corner mc-modal__corner--bl"}),(0,d.jsx)("div",{className:"mc-modal__corner mc-modal__corner--br"}),(t||h)&&(0,d.jsxs)("div",{className:"mc-modal__header",children:[(0,d.jsx)("div",{className:"mc-modal__header-content",children:t&&(0,d.jsxs)("div",{className:"mc-modal__title-group",children:[(0,d.jsx)("h2",{className:"mc-modal__title",children:t}),i&&(0,d.jsx)("p",{className:"mc-modal__subtitle",children:i})]})}),h&&(0,d.jsx)("button",{className:"mc-modal__close",onClick:a,"aria-label":"Close",children:(0,d.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,d.jsx)("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),(0,d.jsx)("div",{className:"mc-modal__body",children:o}),m&&(0,d.jsx)("div",{className:"mc-modal__footer",children:m})]})]})})},W=e=>{let{label:s,id:a,type:t="text",value:n,onChange:i,placeholder:r,disabled:c=!1,readOnly:l=!1,required:o=!1,error:m,hint:u,icon:h,className:p=""}=e;return(0,d.jsxs)("div",{className:"mc-field ".concat(m?"mc-field--error":""," ").concat(c?"mc-field--disabled":""," ").concat(p),children:[(0,d.jsxs)("label",{htmlFor:a,className:"mc-field__label",children:[s,o&&(0,d.jsx)("span",{className:"mc-field__required",children:"*"})]}),(0,d.jsxs)("div",{className:"mc-field__input-wrapper",children:[h&&(0,d.jsx)("span",{className:"mc-field__icon",children:h}),(0,d.jsx)("input",{type:t,id:a,className:"mc-field__input ".concat(h?"mc-field__input--with-icon":""),value:n,onChange:e=>i(e.target.value),placeholder:r,disabled:c,readOnly:l,required:o}),(0,d.jsx)("div",{className:"mc-field__glow"})]}),m&&(0,d.jsx)("span",{className:"mc-field__error",children:m}),u&&!m&&(0,d.jsx)("span",{className:"mc-field__hint",children:u})]})};const L=e=>{let{isOpen:s,onClose:a,machineId:t,machineName:i,onOrderAdded:r}=e;const[c,l]=(0,n.useState)(""),[o,m]=(0,n.useState)(""),[u,h]=(0,n.useState)(""),[p,N]=(0,n.useState)(!1),[x,b]=(0,n.useState)(""),g=()=>{l(""),m(""),h(""),b(""),a()};return(0,d.jsx)(F,{isOpen:s,onClose:g,title:"Add New Order",subtitle:i,size:"md",footer:(0,d.jsxs)("div",{className:"mc-add-order__actions",children:[(0,d.jsx)(q,{variant:"ghost",onClick:g,disabled:p,children:"Cancel"}),(0,d.jsx)(q,{variant:"success",onClick:async()=>{if(c.trim())if(o.trim()){N(!0),b("");try{await(0,R.z8)(t,c.trim(),o.trim(),u.trim()||""),r({orderNumber:c.trim(),product:o.trim(),batchNumber:u.trim()}),l(""),m(""),h(""),a()}catch(e){console.error("Failed to add order:",e),b("Failed to add order. Please try again.")}finally{N(!1)}}else b("Product is required");else b("Order number is required")},loading:p,children:"Add Order & Start"})]}),children:(0,d.jsxs)("div",{className:"mc-add-order",children:[(0,d.jsx)("p",{className:"mc-add-order__description",children:"Create a new order for this machine. The order will be added to the queue and automatically selected."}),x&&(0,d.jsxs)("div",{className:"mc-add-order__error",children:[(0,d.jsxs)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,d.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,d.jsx)("path",{d:"M12 8v4M12 16h.01"})]}),x]}),(0,d.jsxs)("div",{className:"mc-add-order__form",children:[(0,d.jsx)(W,{label:"Order Number",id:"order-number",value:c,onChange:l,placeholder:"e.g., ORD-2024-001",required:!0,disabled:p}),(0,d.jsx)(W,{label:"Product",id:"product",value:o,onChange:m,placeholder:"e.g., Product A",required:!0,disabled:p}),(0,d.jsx)(W,{label:"Batch Number",id:"batch-number",value:u,onChange:h,placeholder:"e.g., BATCH-001 (optional)",disabled:p})]}),(0,d.jsxs)("div",{className:"mc-add-order__hint",children:[(0,d.jsxs)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,d.jsx)("circle",{cx:"12",cy:"12",r:"10"}),(0,d.jsx)("path",{d:"M12 16v-4M12 8h.01"})]}),(0,d.jsx)("span",{children:"Orders can also be added in bulk from the Admin Console."})]})]})})},B=(e,s,a)=>"shift_session_".concat(e,"_").concat(s,"_").concat(a),J=()=>{const{machineId:e}=(0,i.g)(),s=(0,i.zy)(),u=(0,i.Zp)(),h=(()=>{var a;const t="capture_machine_name_".concat(e),n=null===(a=s.state)||void 0===a?void 0:a.machineName;if(n)return sessionStorage.setItem(t,n),n;const i=sessionStorage.getItem(t);return i||(e||"")})(),p=(()=>{var a;const t=null===(a=s.state)||void 0===a?void 0:a.parentMachineId;if(t)return sessionStorage.setItem("capture_parent_id_".concat(e),t),t;const n=sessionStorage.getItem("capture_parent_id_".concat(e));return n||(e&&e.includes("-sub-")?e.split("-sub-")[0]:e||"")})();(0,n.useEffect)(()=>(h&&localStorage.setItem("chat_current_machine",h),()=>{localStorage.removeItem("chat_current_machine")}),[h]);const[N,x]=(0,n.useState)(new Date),[b,g]=(0,n.useState)(""),[j,v]=(0,n.useState)(!1),[f,y]=(0,n.useState)(null),[w,_]=(0,n.useState)(!1),[M,I]=(0,n.useState)(""),[q,F]=(0,n.useState)(""),[W,J]=(0,n.useState)(""),[G,Y]=(0,n.useState)(""),[$,K]=(0,n.useState)(!1),[z,H]=(0,n.useState)(""),[Q,U]=(0,n.useState)(""),[X,V]=(0,n.useState)(""),[Z,ee]=(0,n.useState)(""),[se,ae]=(0,n.useState)([]),[te,ne]=(0,n.useState)([]),[ie,re]=(0,n.useState)([]),[ce,le]=(0,n.useState)([]),[oe,de]=(0,n.useState)([]),[me,ue]=(0,n.useState)([]),[he,pe]=(0,n.useState)(!1),[Ne,xe]=(0,n.useState)(!1),[be,ge]=(0,n.useState)(!1),[je,ve]=(0,n.useState)(!1),[fe,ye]=(0,n.useState)(!1),[we,Se]=(0,n.useState)(!1),[Ce,_e]=(0,n.useState)(""),[ke,Ee]=(0,n.useState)(""),[Re,Ae]=(0,n.useState)(""),[Te,De]=(0,n.useState)(""),[Pe,Oe]=(0,n.useState)(!1),[,Me]=(0,n.useState)(""),[Ie,qe]=(0,n.useState)([]),[Fe,We]=(0,n.useState)(!1),[Le,Be]=(0,n.useState)(!1),[Je,Ge]=(0,n.useState)(null),[Ye,$e]=(0,n.useState)(!1),[Ke,ze]=(0,n.useState)(""),[He,Qe]=(0,n.useState)(!1),[Ue,Xe]=(0,n.useState)(null),[Ve,Ze]=(0,n.useState)(null),[es,ss]=(0,n.useState)(!1),[as,ts]=(0,n.useState)(null),[ns,is]=(0,n.useState)("00:00"),[rs,cs]=(0,n.useState)({isRunning:!1,startTime:null,pausedAt:null,totalRunTimeMs:0,lastResumedAt:null}),[ls,os]=(0,n.useState)("00:00:00"),[ds,ms]=(0,n.useState)(!1),[us,hs]=(0,n.useState)(""),ps=(e,s)=>{y({message:e,type:s}),setTimeout(()=>y(null),4e3)},[Ns,xs]=(0,n.useState)(null),bs=(0,n.useRef)(null),gs=(0,n.useRef)(null),js=(0,n.useCallback)(e=>{const s=(0,D.hJ)(e);Oe(s.isInWindow),Me(s.isInWindow?"":s.timeToWindow)},[]),vs=(0,n.useCallback)(async()=>{const e=(new Date).toISOString().split("T")[0],s=(0,D.Se)(),t=B(h,s,e),{hasConflict:n,activeSession:i}=await(0,P.mU)(h,s,e);n&&i&&(xs("Machine in use by ".concat(i.operator_name," since ").concat(new Date(i.started_at).toLocaleTimeString())),(0,O.I9)("This machine is currently being used by ".concat(i.operator_name)));const r=await(0,P.Bd)(h,s,e);r&&(cs({isRunning:r.isRunning,startTime:r.startTime?new Date(r.startTime):null,pausedAt:r.pausedAt?new Date(r.pausedAt):null,totalRunTimeMs:r.totalRunTimeMs,lastResumedAt:r.lastResumedAt?new Date(r.lastResumedAt):null}),(r.isRunning||r.totalRunTimeMs>0)&&os((0,P.cI)((0,P.Qt)(r))));const c=localStorage.getItem(t);if(c)try{const a=JSON.parse(c);if(a.locked){if(I(a.operatorName),F(a.orderNumber),J(a.product),Y(a.batchNumber),K(!0),a.wasteEntries&&ae(a.wasteEntries),a.downtimeEntries&&ne(a.downtimeEntries),a.speedEntries&&a.speedEntries.length>0)re(a.speedEntries);else{const a=(0,A.Yn)(h,s,e);if(a){const e={id:(0,l.A)(),speed:a.speed,timestamp:new Date(a.updatedAt)};re([e]),console.log("\ud83d\udce1 Loaded shared speed ".concat(a.speed," PPM from ").concat(a.updatedBy))}}return a.sachetMassEntries&&le(a.sachetMassEntries),a.looseCasesEntries&&de(a.looseCasesEntries),void(a.palletScanEntries&&ue(a.palletScanEntries))}}catch(d){console.error("Failed to load session:",d)}try{const{fetchLiveSessionByMachine:n}=await Promise.resolve().then(a.bind(a,6316)),i=await n(h,s,e);if(i&&i.is_locked){I(i.operator_name),F(i.order_number),J(i.product),Y(i.batch_number),K(!0);let a=[],n=[],r=[],c=[],o=[],d=[];const m=await(0,T.Fd)(h,s,e);if(m){const e=(0,T.CJ)(m);a=e.wasteEntries,n=e.downtimeEntries,r=e.speedEntries,c=e.sachetMassEntries,o=e.looseCasesEntries,d=e.palletScanEntries,a.length>0&&ae(a),n.length>0&&ne(n),r.length>0&&re(r),c.length>0&&le(c),o.length>0&&de(o),d.length>0&&ue(d),console.log("\ud83d\udce6 Entries restored from Supabase:",{waste:a.length,downtime:n.length,speed:r.length,sachet:c.length,loose:o.length,pallets:d.length})}if(0===r.length){const a=(0,A.Yn)(h,s,e);if(a){r=[{id:(0,l.A)(),speed:a.speed,timestamp:new Date(a.updatedAt)}],re(r),console.log("\ud83d\udce1 Loaded shared speed ".concat(a.speed," PPM from ").concat(a.updatedBy))}}const u={machineName:i.machine_name,operatorName:i.operator_name,orderNumber:i.order_number,product:i.product,batchNumber:i.batch_number,shift:i.shift,date:i.session_date,locked:!0,wasteEntries:a,downtimeEntries:n,speedEntries:r,sachetMassEntries:c,looseCasesEntries:o,palletScanEntries:d};return localStorage.setItem(t,JSON.stringify(u)),void console.log("\ud83d\udccb Session restored from Supabase:",h)}}catch(d){console.error("Failed to restore session from Supabase:",d)}try{const e=await(0,T.rC)(h);if(e)return F(e.order_number),J(e.product),Y(e.batch_number),void console.log("\ud83d\udccb Order pre-filled from current machine order:",e.order_number)}catch(d){console.error("Failed to load current machine order:",d)}try{const{fetchActiveOrderDetails:e}=await Promise.resolve().then(a.bind(a,1737)),s=await e();if(s)return F(s.order_number),J(s.product),void Y(s.batch_number)}catch(d){console.error("Failed to load from database:",d)}const o=localStorage.getItem("admin_order_details");if(o)try{const e=JSON.parse(o);e.orderNumber&&F(e.orderNumber),e.product&&J(e.product),e.batchNumber&&Y(e.batchNumber)}catch(d){console.error("Failed to load admin order details:",d)}},[h]),fs=(0,n.useCallback)(async function(){let s=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!M||!q||!W||!G)return;const a=(new Date).toISOString().split("T")[0],t=(0,D.Se)(),n=B(h,t,a),i=await(0,P.gS)(h,M,t,a);if(!i.success)return void(0,O.Qg)(i.error||"Failed to acquire session lock");bs.current&&bs.current(),bs.current=(0,P.BO)(h,t,a,e=>{xs("Another user (".concat(e.operator_name,") is accessing this machine"))});const r={machineName:h,operatorName:M,orderNumber:q,product:W,batchNumber:G,shift:t,date:a,locked:!0,wasteEntries:se,downtimeEntries:te,speedEntries:ie,sachetMassEntries:ce,looseCasesEntries:oe,palletScanEntries:me};localStorage.setItem(n,JSON.stringify(r));const c=se.reduce((e,s)=>e+s.waste,0),l=te.reduce((e,s)=>e+s.downtime,0);if((0,T.WA)({machineName:h,operatorName:M,orderNumber:q,product:W,batchNumber:G,shift:t,date:a,locked:!0,totalWaste:c,totalDowntime:l}),!$){K(!0);const n=new Date;cs({isRunning:!0,startTime:n,pausedAt:null,totalRunTimeMs:0,lastResumedAt:n}),os("00:00:00");const i={isRunning:!0,startTime:n.toISOString(),pausedAt:null,totalRunTimeMs:0,lastResumedAt:n.toISOString(),pauseHistory:[]};(0,P.Af)(h,t,a,i),e&&(0,R.LY)(e,"running",M,q,t),s&&ps("Session locked - Production timer started","success")}},[h,M,q,W,G,se,te,ie,ce,oe,me,$,e]);(0,n.useEffect)(()=>{vs()},[vs]);const ys=(0,n.useRef)(rs);(0,n.useEffect)(()=>{ys.current=rs},[rs]),(0,n.useEffect)(()=>{if(!rs.isRunning||!$)return;const e=setInterval(()=>{var e,s,a;const t=(new Date).toISOString().split("T")[0],n=(0,D.Se)(),i={isRunning:rs.isRunning,startTime:(null===(e=rs.startTime)||void 0===e?void 0:e.toISOString())||null,pausedAt:(null===(s=rs.pausedAt)||void 0===s?void 0:s.toISOString())||null,totalRunTimeMs:rs.totalRunTimeMs,lastResumedAt:(null===(a=rs.lastResumedAt)||void 0===a?void 0:a.toISOString())||null,pauseHistory:[]};(0,P.Af)(h,n,t,i)},3e4);return()=>clearInterval(e)},[rs.isRunning,rs.lastResumedAt,rs.totalRunTimeMs,$,h]),(0,n.useEffect)(()=>()=>{const e=(new Date).toISOString().split("T")[0],s=(0,D.Se)(),a=ys.current;if(a.isRunning||a.totalRunTimeMs>0){var t,n,i;const r={isRunning:a.isRunning,startTime:(null===(t=a.startTime)||void 0===t?void 0:t.toISOString())||null,pausedAt:(null===(n=a.pausedAt)||void 0===n?void 0:n.toISOString())||null,totalRunTimeMs:a.totalRunTimeMs,lastResumedAt:(null===(i=a.lastResumedAt)||void 0===i?void 0:i.toISOString())||null,pauseHistory:[]};(0,P.Af)(h,s,e,r)}(0,P.BA)(h,s,e),bs.current&&bs.current()},[h]),(0,n.useEffect)(()=>{(async()=>{if(p)try{const e=await(0,R.Vw)(p);qe(e)}catch(e){console.error("Failed to load machine orders:",e)}})()},[p]),(0,n.useEffect)(()=>{if($&&M&&q&&W&&G){const e=(new Date).toISOString().split("T")[0],s=(0,D.Se)(),a=B(h,s,e),t={machineName:h,operatorName:M,orderNumber:q,product:W,batchNumber:G,shift:s,date:e,locked:!0,wasteEntries:se,downtimeEntries:te,speedEntries:ie,sachetMassEntries:ce,looseCasesEntries:oe,palletScanEntries:me};localStorage.setItem(a,JSON.stringify(t));const n=setTimeout(()=>{const a=(0,T.RU)(se,te,ie,ce,oe,me);(0,T.PX)(h,s,e,a)},500);return()=>clearTimeout(n)}},[se,te,ie,ce,oe,me,$,h,M,q,W,G]),(0,n.useEffect)(()=>{if(!$)return void(gs.current&&(gs.current(),gs.current=null));const e=(new Date).toISOString().split("T")[0],s=(0,D.Se)(),a=(0,T.ZX)(h,s,e,e=>{const s=(0,T.CJ)(e);ae(e=>JSON.stringify(e.map(e=>e.id))!==JSON.stringify(s.wasteEntries.map(e=>e.id))?s.wasteEntries:e),ne(e=>JSON.stringify(e.map(e=>e.id))!==JSON.stringify(s.downtimeEntries.map(e=>e.id))?s.downtimeEntries:e),re(e=>JSON.stringify(e.map(e=>e.id))!==JSON.stringify(s.speedEntries.map(e=>e.id))?s.speedEntries:e),le(e=>JSON.stringify(e.map(e=>e.id))!==JSON.stringify(s.sachetMassEntries.map(e=>e.id))?s.sachetMassEntries:e),de(e=>JSON.stringify(e.map(e=>e.id))!==JSON.stringify(s.looseCasesEntries.map(e=>e.id))?s.looseCasesEntries:e),ue(e=>JSON.stringify(e.map(e=>e.id))!==JSON.stringify(s.palletScanEntries.map(e=>e.id))?s.palletScanEntries:e)});return gs.current=a,()=>{gs.current&&(gs.current(),gs.current=null)}},[$,h]),(0,n.useEffect)(()=>{const e=setInterval(()=>{const e=new Date;x(e),js(e)},1e3),s=(0,D.Se)();return null!==Je&&Je!==s&&$&&$e(!0),g(s),Ge(s),()=>clearInterval(e)},[N,D.hJ,Je,$]),(0,n.useEffect)(()=>{if(!es||!as)return void is("00:00");const e=()=>{const e=(new Date).getTime()-as.getTime(),s=Math.floor(e/6e4),a=Math.floor(e%6e4/1e3);is("".concat(s.toString().padStart(2,"0"),":").concat(a.toString().padStart(2,"0")))};e();const s=setInterval(e,1e3);return()=>clearInterval(s)},[es,as]),(0,n.useEffect)(()=>{if(!rs.isRunning||!rs.lastResumedAt)return;const e=setInterval(()=>{const e=Date.now()-rs.lastResumedAt.getTime(),s=rs.totalRunTimeMs+e,a=Math.floor(s/1e3),t=Math.floor(a/3600),n=Math.floor(a%3600/60),i=a%60;os("".concat(t.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0"),":").concat(i.toString().padStart(2,"0")))},1e3);return()=>clearInterval(e)},[rs.isRunning,rs.lastResumedAt,rs.totalRunTimeMs]),(0,n.useEffect)(()=>{if(!$)return;const e=(new Date).toISOString().split("T")[0],s=(0,D.Se)(),a=se.reduce((e,s)=>e+s.waste,0),t=te.reduce((e,s)=>e+s.downtime,0);(0,T.WA)({machineName:h,operatorName:M,orderNumber:q,product:W,batchNumber:G,shift:s,date:e,locked:!0,totalWaste:a,totalDowntime:t}),console.log("\ud83d\udcca Synced entry totals to Supabase:",{totalWaste:a,totalDowntime:t})},[se,te,$,h,M,q,W,G]);const ws=(0,n.useCallback)(e=>{var s,a,t;const n=(new Date).toISOString().split("T")[0],i=(0,D.Se)(),r={isRunning:e.isRunning,startTime:(null===(s=e.startTime)||void 0===s?void 0:s.toISOString())||null,pausedAt:(null===(a=e.pausedAt)||void 0===a?void 0:a.toISOString())||null,totalRunTimeMs:e.totalRunTimeMs,lastResumedAt:(null===(t=e.lastResumedAt)||void 0===t?void 0:t.toISOString())||null,pauseHistory:[]};(0,P.Af)(h,i,n,r)},[h]),Ss=(0,n.useCallback)(()=>{const e=new Date,s={isRunning:!0,startTime:e,pausedAt:null,totalRunTimeMs:0,lastResumedAt:e};cs(s),os("00:00:00"),ws(s)},[ws]),Cs=(0,n.useCallback)(()=>{if(!rs.isRunning)return;const e=new Date,s=rs.lastResumedAt?e.getTime()-rs.lastResumedAt.getTime():0,a=(0,t.A)((0,t.A)({},rs),{},{isRunning:!1,pausedAt:e,totalRunTimeMs:rs.totalRunTimeMs+s});cs(a),ws(a),ps("Production paused - timer stopped","success")},[rs,ws,ps]),_s=(0,n.useCallback)(()=>{if(!us)return void ps("Please select a downtime reason","error");if(!rs.pausedAt)return;const e=new Date,s=e.getTime()-rs.pausedAt.getTime(),a=Math.ceil(s/6e4),n={id:(0,l.A)(),downtime:a,downtimeReason:us,notes:"Auto-recorded from production pause",timestamp:rs.pausedAt};ne(e=>[...e,n]);const i=(0,t.A)((0,t.A)({},rs),{},{isRunning:!0,pausedAt:null,lastResumedAt:e});cs(i),ws(i),ms(!1),hs(""),ps("Production resumed. ".concat(a," min downtime recorded."),"success")},[us,rs,ws,ps]),ks=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),Es=se.reduce((e,s)=>e+s.waste,0),Rs=te.reduce((e,s)=>e+s.downtime,0);return(0,d.jsxs)(r.P.div,{className:"capture-screen-v2",initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},children:[j&&(0,d.jsxs)("div",{className:"spinner-overlay-v2",children:[(0,d.jsx)("div",{className:"spinner-v2"}),(0,d.jsx)("p",{children:"Submitting shift data..."})]}),f&&(0,d.jsx)(r.P.div,{className:"toast-container-v2",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},children:(0,d.jsxs)("div",{className:"toast-message-v2 ".concat(f.type),children:[(0,d.jsx)("span",{className:"toast-icon",children:"success"===f.type?"\u2713":"!"}),f.message]})}),(0,d.jsxs)("header",{className:"capture-header-v2",children:[(0,d.jsxs)("button",{className:"back-btn-v2",onClick:()=>{(se.length>0||te.length>0||ie.length>0||ce.length>0||oe.length>0||me.length>0)&&!$?window.confirm("You have entries that are not saved to a session. Are you sure you want to go back? Lock your shift details first to save entries.")&&u("/"):u("/")},children:[(0,d.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,d.jsx)("path",{d:"M19 12H5M12 19l-7-7 7-7"})}),"Back"]}),(0,d.jsxs)("div",{className:"capture-title-v2",children:[(0,d.jsx)("h1",{children:h}),(0,d.jsx)("span",{className:"capture-subtitle",children:"Recording Waste & Downtime"})]}),(0,d.jsxs)("div",{className:"shift-badge-v2 ".concat(b.toLowerCase()),children:[(0,d.jsx)("span",{className:"shift-icon",children:"Day"===b?"\u25d0":"\u25d1"}),b," Shift"]})]}),(0,d.jsxs)("main",{className:"capture-main",children:[(0,d.jsxs)("div",{className:"capture-form-column",children:[(0,d.jsxs)("section",{className:"form-section",children:[(0,d.jsxs)("h2",{className:"section-heading",children:["Shift Details",$&&(0,d.jsx)("span",{className:"locked-badge",children:"\ud83d\udd12 Locked"})]}),!$&&(0,d.jsxs)("div",{className:"order-queue-select",children:[(0,d.jsxs)("div",{className:"order-buttons-row",children:[(0,d.jsxs)("button",{className:"select-order-btn add-new",onClick:()=>Be(!0),children:[(0,d.jsx)("span",{className:"btn-icon",children:"+"}),"Add New Order"]}),(0,d.jsxs)("button",{className:"select-order-btn existing",onClick:()=>We(!0),disabled:0===Ie.length,children:[(0,d.jsx)("span",{className:"btn-icon",children:"\ud83d\udccb"}),"Select Existing",Ie.length>0?" (".concat(Ie.length,")"):""]})]}),q&&(0,d.jsxs)("span",{className:"current-order-badge",children:["Current: ",q]})]}),(0,d.jsxs)("div",{className:"form-grid",children:[(0,d.jsx)(m,{operatorName:M,setOperatorName:$?()=>{}:I,machine:h,setMachine:()=>{},orderNumber:q,setOrderNumber:$?()=>{}:F,product:W,setProduct:$?()=>{}:J,batchNumber:G,setBatchNumber:$?()=>{}:Y,hideMachine:!0,disabled:$}),(0,d.jsx)(o.A,{dateTime:N,shift:b})]}),(0,d.jsxs)("div",{className:"speed-setting",children:[(0,d.jsxs)("div",{className:"speed-display",children:[(0,d.jsx)("span",{className:"speed-label",children:"\u26a1 Machine Speed"}),(0,d.jsx)("span",{className:"speed-value",children:ie.length>0?"".concat(ie[ie.length-1].speed," PPM"):"Not Set"}),ie.length>1&&(0,d.jsxs)("span",{className:"speed-history-count",title:"Speed change history",children:["(",ie.length," changes)"]})]}),(0,d.jsx)("button",{className:"speed-change-btn",onClick:()=>pe(!0),children:ie.length>0?"Change":"Set Speed"})]}),!$&&M&&q&&W&&G&&(ie.length>0?(0,d.jsx)("button",{className:"lock-session-btn",onClick:()=>{fs(!0),Ss()},children:"\ud83d\udd12 Lock Shift Details & Start Production"}):(0,d.jsx)("button",{className:"lock-session-btn disabled",onClick:()=>pe(!0),title:"Set machine speed to continue",children:"\u26a1 Set Machine Speed to Start"}))]}),$&&(0,d.jsxs)("section",{className:"form-section machine-details-section",children:[(0,d.jsxs)("h2",{className:"section-heading",children:[(0,d.jsx)("span",{className:"section-icon",children:"\u2699\ufe0f"}),"Machine Details",(0,d.jsx)("span",{className:"production-status-badge ".concat(rs.isRunning?"running":"paused"),children:rs.isRunning?"\u25cf Running":"\u25c9 Paused"})]}),(0,d.jsxs)("div",{className:"machine-details-grid",children:[(0,d.jsxs)("div",{className:"detail-card",children:[(0,d.jsx)("span",{className:"detail-label",children:"Production Started"}),(0,d.jsx)("span",{className:"detail-value",children:rs.startTime?rs.startTime.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"--:--"})]}),(0,d.jsxs)("div",{className:"detail-card timer-card",children:[(0,d.jsx)("span",{className:"detail-label",children:"Run Time"}),(0,d.jsx)("span",{className:"detail-value timer-value",children:ls})]}),(0,d.jsx)("div",{className:"detail-card action-card",children:rs.isRunning?(0,d.jsxs)("button",{className:"pause-continue-btn pause",onClick:Cs,children:[(0,d.jsx)("span",{className:"btn-icon",children:"\u23f8"}),"Pause Production"]}):(0,d.jsxs)("button",{className:"pause-continue-btn continue",onClick:()=>ms(!0),children:[(0,d.jsx)("span",{className:"btn-icon",children:"\u25b6"}),"Continue Production"]})})]}),rs.pausedAt&&(0,d.jsxs)("div",{className:"pause-duration-display",children:[(0,d.jsx)("span",{className:"pause-icon",children:"\u23f1\ufe0f"}),"Paused since ",rs.pausedAt.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]}),(0,d.jsxs)("section",{className:"form-section capture-section compact-capture waste-section",children:[(0,d.jsxs)("h2",{className:"section-heading",children:[(0,d.jsx)("span",{className:"section-icon",children:"\ud83d\uddd1\ufe0f"}),"Record Waste",se.length>0&&(0,d.jsx)("span",{className:"entry-count-badge waste-badge",children:se.length})]}),(0,d.jsxs)("div",{className:"capture-section-content",children:[(0,d.jsxs)("button",{className:"capture-add-btn waste-btn",onClick:()=>ye(!0),children:[(0,d.jsx)("span",{className:"btn-icon",children:"+"}),"Record Waste"]}),se.length>0&&(0,d.jsx)("div",{className:"capture-entries-list",children:se.slice().reverse().map((e,s)=>(0,d.jsxs)("div",{className:"capture-entry-item waste-entry ".concat(0===s?"latest":""),children:[(0,d.jsxs)("div",{className:"entry-main",children:[(0,d.jsx)("span",{className:"entry-value",children:e.waste}),(0,d.jsx)("span",{className:"entry-unit",children:"kg"})]}),(0,d.jsx)("span",{className:"entry-type",children:e.wasteType}),(0,d.jsx)("span",{className:"entry-time",children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),(0,d.jsx)("button",{className:"entry-delete-btn",onClick:()=>{return s=e.id,ae(se.filter(e=>e.id!==s)),void ps("Entry removed","success");var s},title:"Delete this entry",children:"\u2715"})]},e.id))}),se.length>0&&(0,d.jsxs)("div",{className:"section-total",children:[(0,d.jsx)("span",{children:"Total Waste:"}),(0,d.jsxs)("strong",{children:[se.reduce((e,s)=>e+s.waste,0).toFixed(1)," kg"]})]})]})]}),(0,d.jsxs)("section",{className:"form-section capture-section compact-capture downtime-section",children:[(0,d.jsxs)("h2",{className:"section-heading",children:[(0,d.jsx)("span",{className:"section-icon",children:"\u23f1\ufe0f"}),"Record Downtime",te.length>0&&(0,d.jsx)("span",{className:"entry-count-badge downtime-badge",children:te.length})]}),(0,d.jsxs)("div",{className:"capture-section-content",children:[(0,d.jsxs)("button",{className:"capture-add-btn downtime-btn",onClick:()=>Se(!0),children:[(0,d.jsx)("span",{className:"btn-icon",children:"+"}),"Record Downtime"]}),te.length>0&&(0,d.jsx)("div",{className:"capture-entries-list",children:te.slice().reverse().map((e,s)=>(0,d.jsxs)("div",{className:"capture-entry-item downtime-entry ".concat(0===s?"latest":""),children:[(0,d.jsxs)("div",{className:"entry-main",children:[(0,d.jsx)("span",{className:"entry-value",children:e.downtime}),(0,d.jsx)("span",{className:"entry-unit",children:"min"})]}),(0,d.jsx)("span",{className:"entry-reason",children:e.downtimeReason}),(0,d.jsx)("span",{className:"entry-time",children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),(0,d.jsx)("button",{className:"entry-delete-btn",onClick:()=>{return s=e.id,ne(te.filter(e=>e.id!==s)),void ps("Entry removed","success");var s},title:"Delete this entry",children:"\u2715"})]},e.id))}),te.length>0&&(0,d.jsxs)("div",{className:"section-total",children:[(0,d.jsx)("span",{children:"Total Downtime:"}),(0,d.jsxs)("strong",{children:[Math.floor(te.reduce((e,s)=>e+s.downtime,0)/60),"h ",te.reduce((e,s)=>e+s.downtime,0)%60,"m"]})]})]})]}),(0,d.jsxs)("section",{className:"form-section capture-section compact-capture",children:[(0,d.jsxs)("h2",{className:"section-heading",children:[(0,d.jsx)("span",{className:"section-icon",children:"\u2696\ufe0f"}),"Sachet Mass"]}),(0,d.jsxs)("div",{className:"capture-section-content",children:[(0,d.jsxs)("button",{className:"capture-add-btn",onClick:()=>xe(!0),children:[(0,d.jsx)("span",{className:"btn-icon",children:"+"}),"Record"]}),ce.length>0&&(0,d.jsx)("div",{className:"capture-entries-list",children:ce.map(e=>(0,d.jsxs)("div",{className:"capture-entry-item ".concat(e.ignored?"ignored":""),children:[(0,d.jsxs)("div",{className:"entry-main",children:[(0,d.jsx)("span",{className:"entry-value",children:e.mass}),(0,d.jsx)("span",{className:"entry-unit",children:"g"})]}),(0,d.jsx)("span",{className:"entry-time",children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),(0,d.jsx)("button",{className:"entry-ignore-btn ".concat(e.ignored?"ignored":""),onClick:()=>{return s=e.id,void le(ce.map(e=>e.id===s?(0,t.A)((0,t.A)({},e),{},{ignored:!e.ignored}):e));var s},title:e.ignored?"Include this entry":"Ignore this entry",children:e.ignored?"\u21a9":"\u2298"})]},e.id))})]})]}),(0,d.jsxs)("section",{className:"form-section capture-section product-confirmation-section",children:[(0,d.jsxs)("h2",{className:"section-heading",children:[(0,d.jsx)("span",{className:"section-icon",children:"\ud83d\udce6"}),"Product Confirmation",(me.length>0||oe.length>0)&&(0,d.jsxs)("span",{className:"entry-count-badge",children:[me.filter(e=>!e.ignored).reduce((e,s)=>e+s.casesCount,0)+oe.filter(e=>!e.ignored).reduce((e,s)=>e+s.cases,0)," cases"]})]}),(0,d.jsxs)("div",{className:"product-action-buttons",children:[(0,d.jsxs)("button",{className:"capture-add-btn scan-btn",onClick:()=>ve(!0),children:[(0,d.jsx)("span",{className:"btn-icon",children:"\ud83d\udcf7"}),"Scan Pallet"]}),(0,d.jsxs)("button",{className:"capture-add-btn loose-cases-btn",onClick:()=>ge(!0),children:[(0,d.jsx)("span",{className:"btn-icon",children:"+"}),"Add Loose Cases"]})]}),me.length>0&&(0,d.jsxs)("div",{className:"product-entries-section",children:[(0,d.jsxs)("h4",{className:"entries-subheading",children:["Scanned Pallets (",me.filter(e=>!e.ignored).length,")"]}),(0,d.jsx)("div",{className:"capture-entries-list pallet-list",children:me.slice().reverse().map((e,s)=>(0,d.jsxs)("div",{className:"capture-entry-item pallet-entry ".concat(e.ignored?"ignored":""," ").concat(0===s?"latest":""),children:[(0,d.jsxs)("div",{className:"entry-main",children:[(0,d.jsxs)("span",{className:"pallet-badge",children:["P",e.palletNumber]}),(0,d.jsxs)("div",{className:"pallet-details",children:[(0,d.jsxs)("span",{className:"pallet-batch",children:["Batch: ",e.batchNumber]}),(0,d.jsxs)("span",{className:"pallet-cases",children:[e.casesCount," cases"]})]})]}),(0,d.jsx)("span",{className:"entry-time",children:ks(e.timestamp)}),(0,d.jsx)("button",{className:"entry-ignore-btn ".concat(e.ignored?"ignored":""),onClick:()=>{return s=e.id,void ue(me.map(e=>e.id===s?(0,t.A)((0,t.A)({},e),{},{ignored:!e.ignored}):e));var s},title:e.ignored?"Include this pallet":"Ignore this pallet",children:e.ignored?"\u21a9":"\u2298"})]},e.id))})]}),oe.length>0&&(0,d.jsxs)("div",{className:"product-entries-section",children:[(0,d.jsxs)("h4",{className:"entries-subheading",children:["Loose Cases (",oe.filter(e=>!e.ignored).length,")"]}),(0,d.jsx)("div",{className:"capture-entries-list loose-cases-list",children:oe.slice().reverse().map((e,s)=>(0,d.jsxs)("div",{className:"capture-entry-item loose-entry ".concat(e.ignored?"ignored":""),children:[(0,d.jsxs)("div",{className:"entry-main",children:[(0,d.jsx)("span",{className:"loose-badge",children:"LC"}),(0,d.jsxs)("div",{className:"loose-details",children:[(0,d.jsxs)("span",{className:"loose-batch",children:["Batch: ",e.batchNumber]}),(0,d.jsxs)("span",{className:"loose-cases",children:[e.cases," cases"]})]})]}),(0,d.jsx)("span",{className:"entry-time",children:ks(e.timestamp)}),(0,d.jsx)("button",{className:"entry-ignore-btn ".concat(e.ignored?"ignored":""),onClick:()=>{return s=e.id,void de(oe.map(e=>e.id===s?(0,t.A)((0,t.A)({},e),{},{ignored:!e.ignored}):e));var s},title:e.ignored?"Include this entry":"Ignore this entry",children:e.ignored?"\u21a9":"\u2298"})]},e.id))})]}),(me.length>0||oe.length>0)&&(0,d.jsxs)("div",{className:"product-summary",children:[(0,d.jsxs)("div",{className:"summary-item",children:[(0,d.jsx)("span",{className:"summary-label",children:"Total Pallets:"}),(0,d.jsx)("span",{className:"summary-value",children:me.filter(e=>!e.ignored).length})]}),(0,d.jsxs)("div",{className:"summary-item",children:[(0,d.jsx)("span",{className:"summary-label",children:"Total Cases:"}),(0,d.jsx)("span",{className:"summary-value",children:me.filter(e=>!e.ignored).reduce((e,s)=>e+s.casesCount,0)+oe.filter(e=>!e.ignored).reduce((e,s)=>e+s.cases,0)})]})]})]})]}),(0,d.jsxs)("div",{className:"capture-summary-column",children:[(0,d.jsxs)("div",{className:"live-stats-card",children:[(0,d.jsx)("h3",{children:"Session Totals"}),(0,d.jsxs)("div",{className:"stats-grid",children:[(0,d.jsxs)("div",{className:"stat-box waste",children:[(0,d.jsx)("span",{className:"stat-number",children:Es.toFixed(1)}),(0,d.jsx)("span",{className:"stat-unit",children:"kg waste"})]}),(0,d.jsxs)("div",{className:"stat-box downtime",children:[(0,d.jsx)("span",{className:"stat-number",children:Rs}),(0,d.jsx)("span",{className:"stat-unit",children:"min downtime"})]}),(0,d.jsxs)("div",{className:"stat-box cases",children:[(0,d.jsx)("span",{className:"stat-number",children:me.filter(e=>!e.ignored).reduce((e,s)=>e+s.casesCount,0)+oe.filter(e=>!e.ignored).reduce((e,s)=>e+s.cases,0)}),(0,d.jsx)("span",{className:"stat-unit",children:"cases"})]}),(0,d.jsxs)("div",{className:"stat-box pallets",children:[(0,d.jsx)("span",{className:"stat-number",children:me.filter(e=>!e.ignored).length}),(0,d.jsx)("span",{className:"stat-unit",children:"pallets"})]})]})]}),(0,d.jsxs)("div",{className:"charts-card",children:[(0,d.jsx)("h3",{children:"Visual Summary"}),(0,d.jsx)(S,{wasteEntries:se,downtimeEntries:te})]}),es&&(0,d.jsxs)(r.P.div,{className:"submission-card changeover-mode-card",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},children:[(0,d.jsxs)("div",{className:"changeover-header",children:[(0,d.jsx)("h3",{children:"\ud83d\udd04 Changeover Mode"}),(0,d.jsxs)("div",{className:"changeover-timer",children:[(0,d.jsx)("span",{className:"timer-label",children:"Elapsed:"}),(0,d.jsx)("span",{className:"timer-value",children:ns})]})]}),(0,d.jsx)("p",{className:"changeover-instructions",children:"Select your new order and enter machine speed to start production."}),(0,d.jsx)("div",{className:"changeover-order-section",children:q?(0,d.jsxs)("div",{className:"selected-order-display",children:[(0,d.jsx)("span",{className:"label",children:"Selected Order:"}),(0,d.jsx)("strong",{children:q}),(0,d.jsxs)("span",{className:"product-name",children:["(",W,")"]}),(0,d.jsx)("button",{className:"change-order-btn",onClick:()=>We(!0),children:"Change"})]}):(0,d.jsxs)("button",{className:"capture-add-btn select-order-btn",onClick:()=>We(!0),children:[(0,d.jsx)("span",{className:"btn-icon",children:"\ud83d\udccb"}),"Select Order"]})}),(0,d.jsx)("div",{className:"changeover-speed-section",children:ie.length>0?(0,d.jsxs)("div",{className:"speed-display",children:[(0,d.jsx)("span",{className:"label",children:"Machine Speed:"}),(0,d.jsxs)("strong",{children:[ie[ie.length-1].speed," PPM"]}),(0,d.jsx)("button",{className:"change-speed-btn",onClick:()=>pe(!0),children:"Change"})]}):(0,d.jsxs)("button",{className:"capture-add-btn enter-speed-btn",onClick:()=>pe(!0),children:[(0,d.jsx)("span",{className:"btn-icon",children:"\u26a1"}),"Enter Machine Speed"]})}),(0,d.jsx)("button",{className:"start-production-btn",onClick:async()=>{if(!q||!W||!G)return void ps("Please select an order first","error");if(0===ie.length)return void ps("Please enter the machine speed","error");let e=0;if(as){const s=new Date;e=Math.round((s.getTime()-as.getTime())/6e4);const a={id:(0,l.A)(),downtime:e,downtimeReason:"Changeover",timestamp:as};ne(e=>[...e,a]),console.log("\ud83d\udcca Changeover completed in ".concat(e," minutes"))}await(0,T.Cf)(h,q,W,G),ss(!1),ts(null);const s=new Date;cs({isRunning:!0,startTime:s,pausedAt:null,totalRunTimeMs:0,lastResumedAt:s}),fs(!1),ps("Production started! Changeover took ".concat(e," min"),"success")},disabled:!q||!W||!G||0===ie.length,children:"\u25b6\ufe0f Start Production"}),as&&(0,d.jsxs)("p",{className:"changeover-time",children:["Changeover started: ",as.toLocaleTimeString()]})]}),$&&!es&&(0,d.jsxs)(r.P.div,{className:"submission-card changeover-card",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},children:[(0,d.jsxs)("div",{className:"live-status",children:[(0,d.jsx)("span",{className:"live-indicator"}),(0,d.jsx)("span",{children:"Data syncing live"})]}),(0,d.jsxs)("div",{className:"session-summary",children:[(0,d.jsxs)("div",{className:"detail-row",children:[(0,d.jsx)("span",{children:"Order"}),(0,d.jsx)("strong",{children:q||"\u2014"})]}),(0,d.jsxs)("div",{className:"detail-row highlight waste",children:[(0,d.jsx)("span",{children:"Total Waste"}),(0,d.jsxs)("strong",{children:[Es.toFixed(1)," kg"]})]}),(0,d.jsxs)("div",{className:"detail-row highlight downtime",children:[(0,d.jsx)("span",{children:"Total Downtime"}),(0,d.jsxs)("strong",{children:[Math.floor(Rs/60),"h ",Rs%60,"m"]})]})]}),(0,d.jsxs)("div",{className:"shift-action-buttons",children:[(0,d.jsx)("button",{className:"changeover-btn",onClick:()=>{Xe(null),Ze(null),Qe(!0)},children:"\ud83d\udd04 Changeover"}),(0,d.jsx)("button",{className:"finish-shift-btn",onClick:async()=>{await(0,T.Cf)(h,q,W,G),rs.isRunning&&cs(e=>(0,t.A)((0,t.A)({},e),{},{isRunning:!1,pausedAt:new Date})),e&&(0,R.LY)(e,"idle"),K(!1);const s=(new Date).toISOString().split("T")[0],a=(0,D.Se)(),n=B(h,a,s);localStorage.removeItem(n),(0,T.KW)(h,a,s),I(""),ps("Shift completed! Order saved for next shift operator.","success")},children:"\u2705 Finish Shift"})]})]})]})]}),(0,d.jsx)(C.A,{isOpen:w,title:"Confirm Submission",message:"You are about to submit ".concat(se.length," waste entries and ").concat(te.length," downtime entries for ").concat(h,".").concat(null!==Ue?" Changeover: ".concat(Ue?"Yes":"No",". Maintenance/Cleaning: ").concat(Ve?"Yes":"No","."):""," This action cannot be undone."),confirmText:"Submit",cancelText:"Review",type:"success",onConfirm:async()=>{_(!1),v(!0);const s=se.reduce((e,s)=>e+s.waste,0),a=te.reduce((e,s)=>e+s.downtime,0),t={id:(0,l.A)(),operatorName:M,machine:h,orderNumber:q,product:W,batchNumber:G,shift:b,date:N.toISOString().split("T")[0],wasteEntries:se,downtimeEntries:te,speedEntries:ie,sachetMassEntries:ce,looseCasesEntries:oe,palletScanEntries:me,totalWaste:s,totalDowntime:a,submittedAt:new Date},n={shiftData:{operator_name:M,machine:h,order_number:q,product:W,batch_number:G,shift:b,submission_date:N.toISOString().split("T")[0],is_early_submission:!Pe,will_changeover:null!==Ue&&void 0!==Ue?Ue:void 0,will_maintenance_cleaning:null!==Ve&&void 0!==Ve?Ve:void 0},wasteEntries:se.map(e=>({waste:e.waste,wasteType:e.wasteType,timestamp:e.timestamp})),downtimeEntries:te.map(e=>({downtime:e.downtime,downtimeReason:e.downtimeReason,timestamp:e.timestamp})),speedEntries:ie.map(e=>({speed:e.speed,timestamp:e.timestamp})),sachetMassEntries:ce.map(e=>({mass:e.mass,timestamp:e.timestamp})),looseCasesEntries:oe.map(e=>({batchNumber:e.batchNumber,cases:e.cases,timestamp:e.timestamp})),palletScanEntries:me.map(e=>({qrCode:e.qrCode,batchNumber:e.batchNumber,palletNumber:e.palletNumber,casesCount:e.casesCount,timestamp:e.timestamp}))};try{(0,A.IN)(t);const s=await(0,R.jw)(n.shiftData,n.wasteEntries,n.downtimeEntries,n.speedEntries,n.sachetMassEntries,n.looseCasesEntries,n.palletScanEntries);s.warnings.length>0?ps("Submitted with warnings: ".concat(s.warnings.join(", ")),"success"):ps("Shift data submitted successfully","success"),K(!1),e&&(0,R.LY)(e,"idle"),ae([]),ne([]),re([]),le([]),de([]),ue([]),Xe(null),Ze(!1),sessionStorage.removeItem("session_".concat(e));const a=(new Date).toISOString().split("T")[0],i=B(h,b,a);localStorage.removeItem(i),(0,T.KW)(h,b,a),!1===Ue?(await(0,T.Cf)(h,q,W,G),console.log("\ud83d\udccb Order saved for next shift:",q)):!0===Ue&&(await(0,T.ii)(h),console.log("\ud83d\udccb Current order cleared (changeover)")),F(""),J(""),Y("")}catch(i){console.error("Submission error:",i),(0,A.nN)(n,String(i)),ps("Saved locally. Will retry sync automatically.","error"),K(!1),e&&(0,R.LY)(e,"idle");const s=(new Date).toISOString().split("T")[0],a=B(h,b,s);localStorage.removeItem(a),(0,T.KW)(h,b,s),!1===Ue?await(0,T.Cf)(h,q,W,G):!0===Ue&&await(0,T.ii)(h),ae([]),ne([]),re([]),le([]),de([]),ue([]),Xe(null),Ze(!1),F(""),J(""),Y("")}finally{v(!1)}},onCancel:()=>_(!1)}),(0,d.jsx)(c.N,{children:He&&(0,d.jsx)(r.P.div,{className:"capture-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:(0,d.jsxs)(r.P.div,{className:"capture-modal changeover-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("h3",{className:"modal-title",children:[(0,d.jsx)("span",{className:"modal-icon",children:"\u26a0\ufe0f"}),"Early Submission"]}),(0,d.jsx)("p",{className:"changeover-intro",children:"You are submitting before the end of shift window. Please answer the following:"}),(0,d.jsxs)("div",{className:"changeover-question",children:[(0,d.jsx)("label",{className:"question-label",children:"Will there be a changeover to a new product and order?"}),(0,d.jsxs)("div",{className:"question-options",children:[(0,d.jsx)("button",{className:"option-btn ".concat(!0===Ue?"selected yes":""),onClick:()=>Xe(!0),children:"\u2713 Yes"}),(0,d.jsx)("button",{className:"option-btn ".concat(!1===Ue?"selected no":""),onClick:()=>Xe(!1),children:"\u2717 No"})]})]}),(0,d.jsxs)("div",{className:"changeover-question",children:[(0,d.jsx)("label",{className:"question-label",children:"Will there be maintenance or cleaning before next production start?"}),(0,d.jsxs)("div",{className:"question-options",children:[(0,d.jsx)("button",{className:"option-btn ".concat(!0===Ve?"selected yes":""),onClick:()=>Ze(!0),children:"\u2713 Yes"}),(0,d.jsx)("button",{className:"option-btn ".concat(!1===Ve?"selected no":""),onClick:()=>Ze(!1),children:"\u2717 No"})]})]}),(0,d.jsxs)("div",{className:"modal-actions",children:[(0,d.jsx)("button",{className:"modal-btn cancel",onClick:()=>Qe(!1),children:"Cancel"}),(0,d.jsx)("button",{className:"modal-btn confirm",onClick:async()=>{null!==Ue&&null!==Ve?(Qe(!1),Ue?(ts(new Date),ss(!0),await(0,T.ii)(h),F(""),J(""),Y(""),rs.isRunning&&cs(e=>(0,t.A)((0,t.A)({},e),{},{isRunning:!1,pausedAt:new Date})),ps("Select your new order and enter machine speed to start production","success")):ps(Ve?"Maintenance/cleaning noted. Production continues with same order.":"Continuing with same order","success")):ps("Please answer both questions","error")},disabled:null===Ue||null===Ve,children:"Continue to Submit"})]})]})})}),(0,d.jsx)(c.N,{children:Ye&&(0,d.jsx)(r.P.div,{className:"capture-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:(0,d.jsxs)(r.P.div,{className:"capture-modal shift-change-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("h3",{className:"modal-title",children:[(0,d.jsx)("span",{className:"modal-icon",children:"\ud83d\udd04"}),"Shift Change Detected"]}),(0,d.jsxs)("p",{className:"modal-description",children:["The shift has changed to ",(0,d.jsx)("strong",{children:b})," shift. Please enter the new operator's name or number."]}),(0,d.jsxs)("div",{className:"modal-form",children:[(0,d.jsx)("label",{className:"modal-label",children:"New Operator Name/Number"}),(0,d.jsx)("input",{type:"text",className:"modal-input",placeholder:"Enter operator name or number...",value:Ke,onChange:e=>ze(e.target.value),autoFocus:!0})]}),(0,d.jsxs)("div",{className:"shift-change-info",children:[(0,d.jsxs)("p",{children:[(0,d.jsx)("strong",{children:"Current Order:"})," ",q]}),(0,d.jsxs)("p",{children:[(0,d.jsx)("strong",{children:"Previous Operator:"})," ",M]})]}),(0,d.jsx)("div",{className:"modal-actions",children:(0,d.jsx)("button",{className:"modal-btn confirm",onClick:()=>{if(!Ke.trim())return void ps("Please enter the new operator name/number","error");I(Ke.trim()),$e(!1),ze(""),e&&(0,R.LY)(e,"running",Ke.trim(),q,b);const s=(new Date).toISOString().split("T")[0],a=B(h,b,s),t={machineName:h,operatorName:Ke.trim(),orderNumber:q,product:W,batchNumber:G,shift:b,date:s,locked:!0,wasteEntries:se,downtimeEntries:te,speedEntries:ie,sachetMassEntries:ce,looseCasesEntries:oe,palletScanEntries:me};localStorage.setItem(a,JSON.stringify(t)),ps("Operator changed to ".concat(Ke.trim()," for ").concat(b," shift"),"success")},disabled:!Ke.trim(),children:"Confirm Operator Change"})})]})})}),(0,d.jsx)(c.N,{children:he&&(0,d.jsx)(r.P.div,{className:"capture-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>pe(!1),children:(0,d.jsxs)(r.P.div,{className:"capture-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("h3",{className:"modal-title",children:[(0,d.jsx)("span",{className:"modal-icon",children:"\u26a1"}),"Record Machine Speed"]}),(0,d.jsxs)("div",{className:"modal-form",children:[(0,d.jsx)("label",{className:"modal-label",children:"Speed (PPM - Packs Per Minute)"}),(0,d.jsx)("input",{type:"number",className:"modal-input",placeholder:"Enter speed...",value:Ce,onChange:e=>_e(e.target.value?Number(e.target.value):""),autoFocus:!0})]}),(0,d.jsxs)("div",{className:"modal-actions",children:[(0,d.jsx)("button",{className:"modal-btn cancel",onClick:()=>{pe(!1),_e("")},children:"Cancel"}),(0,d.jsx)("button",{className:"modal-btn confirm",onClick:()=>{if(Ce&&Ce>0){const e={id:(0,l.A)(),speed:Number(Ce),timestamp:new Date};re([...ie,e]),_e(""),pe(!1),ps("Machine speed recorded","success");const s=(new Date).toISOString().split("T")[0],a=(0,D.Se)();(0,A.nt)(h,a,s,Number(Ce))}},disabled:!Ce||Ce<=0,children:"Confirm"})]})]})})}),(0,d.jsx)(c.N,{children:Ne&&(0,d.jsx)(r.P.div,{className:"capture-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>xe(!1),children:(0,d.jsxs)(r.P.div,{className:"capture-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("h3",{className:"modal-title",children:[(0,d.jsx)("span",{className:"modal-icon",children:"\u2696\ufe0f"}),"Record Sachet Mass"]}),(0,d.jsxs)("div",{className:"modal-form",children:[(0,d.jsx)("label",{className:"modal-label",children:"Mass (grams)"}),(0,d.jsx)("input",{type:"number",step:"0.1",className:"modal-input",placeholder:"Enter mass in grams...",value:ke,onChange:e=>Ee(e.target.value?Number(e.target.value):""),autoFocus:!0})]}),(0,d.jsxs)("div",{className:"modal-actions",children:[(0,d.jsx)("button",{className:"modal-btn cancel",onClick:()=>{xe(!1),Ee("")},children:"Cancel"}),(0,d.jsx)("button",{className:"modal-btn confirm",onClick:()=>{if(ke&&ke>0){const e={id:(0,l.A)(),mass:Number(ke),timestamp:new Date};le([...ce,e]),Ee(""),xe(!1),ps("Sachet mass recorded","success")}},disabled:!ke||ke<=0,children:"Confirm"})]})]})})}),(0,d.jsx)(c.N,{children:fe&&(0,d.jsx)(r.P.div,{className:"capture-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>ye(!1),children:(0,d.jsxs)(r.P.div,{className:"capture-modal waste-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("h3",{className:"modal-title",children:[(0,d.jsx)("span",{className:"modal-icon",children:"\ud83d\uddd1\ufe0f"}),"Record Waste"]}),(0,d.jsxs)("div",{className:"modal-form",children:[(0,d.jsxs)("div",{className:"form-row",children:[(0,d.jsx)("label",{className:"modal-label",children:"Waste Type"}),(0,d.jsxs)("select",{className:"modal-select",value:Q,onChange:e=>U(e.target.value),children:[(0,d.jsx)("option",{value:"",children:"Select waste type..."}),E.rE.map(e=>(0,d.jsx)("option",{value:e,children:e},e))]})]}),(0,d.jsxs)("div",{className:"form-row",children:[(0,d.jsx)("label",{className:"modal-label",children:"Weight (kg)"}),(0,d.jsx)("input",{type:"number",step:"0.1",className:"modal-input",placeholder:"Enter weight in kg...",value:z,onChange:e=>H(e.target.value?Number(e.target.value):""),min:0})]})]}),(0,d.jsxs)("div",{className:"modal-actions",children:[(0,d.jsx)("button",{className:"modal-btn cancel",onClick:()=>{ye(!1),H(""),U("")},children:"Cancel"}),(0,d.jsx)("button",{className:"modal-btn confirm waste-confirm",onClick:()=>{if(z&&Q){const e={id:(0,l.A)(),waste:Number(z),wasteType:Q,timestamp:new Date};ae([...se,e]),H(""),U(""),ye(!1),ps("Waste entry added","success")}},disabled:!z||z<=0||!Q,children:"Add Waste Entry"})]})]})})}),(0,d.jsx)(c.N,{children:we&&(0,d.jsx)(r.P.div,{className:"capture-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>Se(!1),children:(0,d.jsxs)(r.P.div,{className:"capture-modal downtime-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("h3",{className:"modal-title",children:[(0,d.jsx)("span",{className:"modal-icon",children:"\u23f1\ufe0f"}),"Record Downtime"]}),(0,d.jsxs)("div",{className:"modal-form",children:[(0,d.jsxs)("div",{className:"form-row",children:[(0,d.jsx)("label",{className:"modal-label",children:"Downtime Reason"}),(0,d.jsxs)("select",{className:"modal-select",value:Z,onChange:e=>ee(e.target.value),children:[(0,d.jsx)("option",{value:"",children:"Select reason..."}),E.wK.map(e=>(0,d.jsx)("option",{value:e,children:e},e))]})]}),(0,d.jsxs)("div",{className:"form-row",children:[(0,d.jsx)("label",{className:"modal-label",children:"Duration (minutes)"}),(0,d.jsx)("input",{type:"number",className:"modal-input",placeholder:"Enter minutes...",value:X,onChange:e=>V(e.target.value?Number(e.target.value):""),min:1})]})]}),(0,d.jsxs)("div",{className:"modal-actions",children:[(0,d.jsx)("button",{className:"modal-btn cancel",onClick:()=>{Se(!1),V(""),ee("")},children:"Cancel"}),(0,d.jsx)("button",{className:"modal-btn confirm downtime-confirm",onClick:()=>{if(X&&Z){const e={id:(0,l.A)(),downtime:Number(X),downtimeReason:Z,notes:void 0,timestamp:new Date};ne([...te,e]),V(""),ee(""),Se(!1),ps("Downtime entry added","success")}},disabled:!X||X<=0||!Z,children:"Add Downtime Entry"})]})]})})}),(0,d.jsx)(c.N,{children:ds&&(0,d.jsx)(r.P.div,{className:"capture-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>ms(!1),children:(0,d.jsxs)(r.P.div,{className:"capture-modal continue-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("h3",{className:"modal-title",children:[(0,d.jsx)("span",{className:"modal-icon",children:"\u25b6"}),"Continue Production"]}),(0,d.jsxs)("div",{className:"modal-form",children:[(0,d.jsxs)("div",{className:"pause-info",children:[(0,d.jsx)("span",{className:"pause-duration-label",children:"Paused Duration:"}),(0,d.jsx)("span",{className:"pause-duration-value",children:rs.pausedAt?"".concat(Math.ceil((Date.now()-rs.pausedAt.getTime())/6e4)," minutes"):"0 minutes"})]}),(0,d.jsxs)("div",{className:"form-row",children:[(0,d.jsx)("label",{className:"modal-label",children:"What was the reason for this downtime?"}),(0,d.jsxs)("select",{className:"modal-select",value:us,onChange:e=>hs(e.target.value),autoFocus:!0,children:[(0,d.jsx)("option",{value:"",children:"Select reason..."}),E.wK.map(e=>(0,d.jsx)("option",{value:e,children:e},e))]})]})]}),(0,d.jsxs)("div",{className:"modal-actions",children:[(0,d.jsx)("button",{className:"modal-btn cancel",onClick:()=>{ms(!1),hs("")},children:"Cancel"}),(0,d.jsx)("button",{className:"modal-btn confirm continue-confirm",onClick:_s,disabled:!us,children:"Record & Continue"})]})]})})}),(0,d.jsx)(c.N,{children:be&&(0,d.jsx)(r.P.div,{className:"capture-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>ge(!1),children:(0,d.jsxs)(r.P.div,{className:"capture-modal loose-cases-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("h3",{className:"modal-title",children:[(0,d.jsx)("span",{className:"modal-icon",children:"\ud83d\udce6"}),"Add Loose Cases"]}),(0,d.jsx)("p",{className:"modal-description",children:"Enter cases that are not part of a full pallet scan"}),(0,d.jsxs)("div",{className:"modal-form",children:[(0,d.jsxs)("div",{className:"form-row",children:[(0,d.jsx)("label",{className:"modal-label",children:"Batch Number (5 digits)"}),(0,d.jsx)("input",{type:"text",className:"modal-input",placeholder:"e.g., 12345",value:Re,onChange:e=>{const s=e.target.value.replace(/\D/g,"").slice(0,5);Ae(s)},maxLength:5,autoFocus:!0})]}),(0,d.jsxs)("div",{className:"form-row",children:[(0,d.jsx)("label",{className:"modal-label",children:"Number of Cases"}),(0,d.jsx)("input",{type:"number",className:"modal-input",placeholder:"Enter quantity...",value:Te,onChange:e=>De(e.target.value?Number(e.target.value):""),min:1})]})]}),(0,d.jsxs)("div",{className:"modal-actions",children:[(0,d.jsx)("button",{className:"modal-btn cancel",onClick:()=>{ge(!1),Ae(""),De("")},children:"Cancel"}),(0,d.jsx)("button",{className:"modal-btn confirm",onClick:()=>{if(Re&&5===Re.length&&Te&&Te>0){const e={id:(0,l.A)(),batchNumber:Re,cases:Number(Te),timestamp:new Date};de([...oe,e]),Ae(""),De(""),ge(!1),ps("Loose cases recorded","success")}else 5!==Re.length&&ps("Batch number must be 5 digits","error")},disabled:5!==Re.length||!Te||Te<=0,children:"Add Cases"})]})]})})}),(0,d.jsx)(k,{isOpen:je,onClose:()=>ve(!1),onScan:e=>{const s=(e=>{const s=e.trim();if(!/^\d{13}$/.test(s))return null;const a=parseInt(s.substring(9,13),10);return Number.isNaN(a)?null:{batchNumber:s.substring(0,5),palletNumber:s.substring(5,9),casesCount:a}})(e);if(!s)return void ps("Invalid QR code format. Expected 13 digits: BBBBBPPPPCCCC","error");if(me.some(s=>s.qrCode===e))return void ps("Pallet ".concat(s.palletNumber," has already been scanned!"),"error");const a={id:(0,l.A)(),qrCode:e,batchNumber:s.batchNumber,palletNumber:s.palletNumber,casesCount:s.casesCount,timestamp:new Date};ue([...me,a]),ps("Pallet ".concat(s.palletNumber," scanned (").concat(s.casesCount," cases)"),"success")},recentScans:me.map(e=>e.qrCode)}),(0,d.jsx)(c.N,{children:Fe&&(0,d.jsx)(r.P.div,{className:"capture-modal-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:()=>We(!1),children:(0,d.jsxs)(r.P.div,{className:"capture-modal order-select-modal",initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:e=>e.stopPropagation(),children:[(0,d.jsxs)("h3",{className:"modal-title",children:[(0,d.jsx)("span",{className:"modal-icon",children:"\ud83d\udccb"}),"Select Order"]}),(0,d.jsx)("p",{className:"modal-description",children:"Choose an order from the queue (sorted by priority)"}),(0,d.jsx)("div",{className:"order-queue-list",children:Ie.map((e,s)=>(0,d.jsxs)("button",{className:"order-queue-item ".concat(q===e.order_number?"selected":""),onClick:()=>(e=>{F(e.order_number),J(e.product),Y(e.batch_number),We(!1),ps("Selected order: ".concat(e.order_number),"success")})(e),children:[(0,d.jsxs)("span",{className:"order-priority",children:["#",s+1]}),(0,d.jsxs)("div",{className:"order-details",children:[(0,d.jsx)("span",{className:"order-number",children:e.order_number}),(0,d.jsx)("span",{className:"order-product",children:e.product}),(0,d.jsxs)("span",{className:"order-batch",children:["Batch: ",e.batch_number]})]}),q===e.order_number&&(0,d.jsx)("span",{className:"order-selected-badge",children:"\u2713"})]},e.id))}),(0,d.jsxs)("div",{className:"modal-actions",children:[(0,d.jsx)("button",{className:"modal-btn add-order",onClick:()=>{We(!1),Be(!0)},children:"+ Add New Order"}),(0,d.jsx)("button",{className:"modal-btn cancel",onClick:()=>We(!1),children:"Cancel"})]})]})})}),(0,d.jsx)(L,{isOpen:Le,onClose:()=>Be(!1),machineId:e||"",machineName:h,onOrderAdded:e=>{F(e.orderNumber),J(e.product),Y(e.batchNumber),We(!1),ps("Created and selected order: ".concat(e.orderNumber),"success"),(0,R.Vw)(p||"").then(e=>qe(e)).catch(console.error)}})]})}},3113:(e,s,a)=>{a.d(s,{A:()=>i});a(5043);var t=a(9908),n=a(579);const i=e=>{let{dateTime:s,shift:a}=e;return(0,n.jsxs)("div",{className:"shift-info-card",children:[(0,n.jsxs)("div",{className:"shift-info-header",children:[(0,n.jsx)("span",{className:"info-label",children:"Current Date"}),(0,n.jsx)("span",{className:"info-value date",children:(0,t.GP)(s,"EEEE,")}),(0,n.jsx)("span",{className:"info-value",children:(0,t.GP)(s,"MMM d, yyyy")})]}),(0,n.jsxs)("div",{className:"shift-info-time",children:[(0,n.jsx)("span",{className:"info-label",children:"Current Time"}),(0,n.jsx)("span",{className:"time-display",children:(0,t.GP)(s,"HH:mm:ss")})]})]})}},6316:(e,s,a)=>{a.d(s,{$C:()=>N,CJ:()=>f,Cf:()=>y,Fd:()=>b,KW:()=>o,PX:()=>x,RU:()=>v,WA:()=>l,ZX:()=>g,b6:()=>u,fetchLiveSessionByMachine:()=>m,ii:()=>S,rC:()=>w,yw:()=>d});var t=a(7051),n=a(1737);const i=(e,s,a)=>"".concat(e,"_").concat(s,"_").concat(a);let r=new Map,c=0;const l=async e=>{const s=i(e.machineName,e.shift,e.date),a={id:s,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()};if(r.set(s,a),n.$G)try{const{error:a}=await n.ND.from("live_sessions").upsert({id:s,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()},{onConflict:"id"});return a?(console.error("Failed to upsert live session:",a.message),!1):(console.log("\u2705 Live session synced to Supabase:",s),!0)}catch(t){return console.error("Failed to upsert live session:",t),!1}return!0},o=async(e,s,a)=>{const t=i(e,s,a);if(r.delete(t),n.$G)try{const{error:e}=await n.ND.from("live_sessions").delete().eq("id",t);return!e||(console.error("Failed to delete live session:",e.message),!1)}catch(c){return console.error("Failed to delete live session:",c),!1}return!0},d=async()=>{const e=Date.now(),s=(new Date).toISOString().split("T")[0],a=e-c<3e4;if(n.$G)try{const{data:a,error:t}=await n.ND.from("live_sessions").select("*").eq("session_date",s).eq("is_locked",!0);return t?(console.error("Failed to fetch live sessions:",t.message),Array.from(r.values()).filter(e=>e.session_date===s&&e.is_locked)):(r.clear(),(a||[]).forEach(e=>{r.set(e.id,e)}),c=e,console.log("\ud83d\udccb Fetched active sessions from Supabase:",(a||[]).length,null===a||void 0===a?void 0:a.map(e=>e.machine_name)),a||[])}catch(t){return console.error("Failed to fetch live sessions:",t),Array.from(r.values()).filter(e=>e.session_date===s&&e.is_locked)}return a?Array.from(r.values()).filter(e=>e.session_date===s&&e.is_locked):[]},m=async(e,s,a)=>{const t=i(e,s,a);if(r.has(t))return r.get(t)||null;if(!n.$G)return null;try{const{data:s,error:a}=await n.ND.from("live_sessions").select("*").eq("id",t).eq("is_locked",!0).maybeSingle();return a?(console.error("Failed to fetch session:",a.message),null):(s&&(r.set(t,s),console.log("\ud83d\udccb Restored session from Supabase:",e)),s)}catch(c){return console.error("Failed to fetch session by machine:",c),null}},u=e=>{if(!n.$G)return()=>{};(new Date).toISOString().split("T")[0];const s=n.ND.channel("live-sessions-changes").on("postgres_changes",{event:"*",schema:"public",table:"live_sessions"},async s=>{console.log("\ud83d\udd04 Real-time session update received:",s.eventType);const a=await d();e(a)}).subscribe(e=>{console.log("\ud83d\udce1 Session subscription status:",e)});return()=>{n.ND.removeChannel(s)}};let h=[];let p=[];const N=e=>{p.push(e),e([...h]);let s=null;return n.$G&&(s=n.ND.channel("activity-broadcast").on("broadcast",{event:"activity"},e=>{const s=e.payload,a=(0,t.A)((0,t.A)({},s),{},{timestamp:new Date(s.timestamp)});h.some(e=>e.id===a.id)||(h=[a,...h].slice(0,50),p.forEach(e=>e([...h])))}).subscribe()),()=>{p=p.filter(s=>s!==e),s&&n.ND.removeChannel(s)}},x=async(e,s,a,t)=>{if(!n.$G)return!1;const r=i(e,s,a),c=JSON.stringify(t);try{const{error:e}=await n.ND.from("live_sessions").update({entries_json:c,updated_at:(new Date).toISOString()}).eq("id",r);return e?(e.message.includes("entries_json")||e.message.includes("column")||console.error("Failed to sync entries:",e.message),!1):(console.log("\ud83d\udce6 Entries synced to Supabase:",r),!0)}catch(l){return!1}},b=async(e,s,a)=>{if(!n.$G)return null;const t=i(e,s,a);try{const{data:e,error:s}=await n.ND.from("live_sessions").select("entries_json").eq("id",t).maybeSingle();if(s)return s.message.includes("entries_json")||s.message.includes("column")||console.error("Failed to fetch entries:",s.message),null;if(null!==e&&void 0!==e&&e.entries_json){const s=JSON.parse(e.entries_json);return console.log("\ud83d\udce6 Entries restored from Supabase:",t),s}return null}catch(r){return null}},g=(e,s,a,t)=>{if(!n.$G)return()=>{};const r=i(e,s,a),c=n.ND.channel("entries-".concat(r)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"live_sessions",filter:"id=eq.".concat(r)},e=>{const s=e.new;if(s.entries_json)try{const e=JSON.parse(s.entries_json);console.log("\ud83d\udd04 Real-time entries update received:",r),t(e)}catch(a){console.error("Failed to parse entries update:",a)}}).subscribe(e=>{console.log("\ud83d\udce1 Entry sync subscription status:",e,r)});return()=>{n.ND.removeChannel(c)}},j=e=>"string"===typeof e?e:e instanceof Date?e.toISOString():new Date(e).toISOString(),v=(e,s,a,t,n,i)=>({wasteEntries:e.map(e=>({id:e.id,waste:e.waste,wasteType:e.wasteType,timestamp:j(e.timestamp)})),downtimeEntries:s.map(e=>({id:e.id,downtime:e.downtime,downtimeReason:e.downtimeReason,timestamp:j(e.timestamp)})),speedEntries:a.map(e=>({id:e.id,speed:e.speed,timestamp:j(e.timestamp)})),sachetMassEntries:t.map(e=>({id:e.id,mass:e.mass,timestamp:j(e.timestamp)})),looseCasesEntries:n.map(e=>({id:e.id,batchNumber:e.batchNumber,cases:e.cases,timestamp:j(e.timestamp)})),palletScanEntries:i.map(e=>({id:e.id,qrCode:e.qrCode,batchNumber:e.batchNumber,palletNumber:e.palletNumber,casesCount:e.casesCount,timestamp:j(e.timestamp),ignored:e.ignored}))}),f=e=>({wasteEntries:e.wasteEntries.map(e=>({id:e.id,waste:e.waste,wasteType:e.wasteType,timestamp:new Date(e.timestamp)})),downtimeEntries:e.downtimeEntries.map(e=>({id:e.id,downtime:e.downtime,downtimeReason:e.downtimeReason,timestamp:new Date(e.timestamp)})),speedEntries:e.speedEntries.map(e=>({id:e.id,speed:e.speed,timestamp:new Date(e.timestamp)})),sachetMassEntries:e.sachetMassEntries.map(e=>({id:e.id,mass:e.mass,timestamp:new Date(e.timestamp)})),looseCasesEntries:e.looseCasesEntries.map(e=>({id:e.id,batchNumber:e.batchNumber,cases:e.cases,timestamp:new Date(e.timestamp)})),palletScanEntries:e.palletScanEntries.map(e=>({id:e.id,qrCode:e.qrCode,batchNumber:e.batchNumber,palletNumber:e.palletNumber,casesCount:e.casesCount,timestamp:new Date(e.timestamp),ignored:e.ignored}))}),y=async(e,s,a,t)=>{const i="current_machine_order_".concat(e),r={machine_name:e,order_number:s,product:a,batch_number:t,updated_at:(new Date).toISOString()};if(localStorage.setItem(i,JSON.stringify(r)),n.$G)try{const{error:i}=await n.ND.from("current_machine_orders").upsert({machine_name:e,order_number:s,product:a,batch_number:t,updated_at:(new Date).toISOString()},{onConflict:"machine_name"});if(i)return console.log("Current order saved to localStorage (Supabase table may not exist)"),!0;console.log("\u2705 Current machine order synced to Supabase:",e)}catch(c){}return!0},w=async e=>{if(n.$G)try{const{data:s,error:a}=await n.ND.from("current_machine_orders").select("*").eq("machine_name",e).maybeSingle();if(!a&&s)return console.log("\ud83d\udccb Current machine order loaded from Supabase:",e),s}catch(t){}const s="current_machine_order_".concat(e),a=localStorage.getItem(s);if(a)try{const s=JSON.parse(a);return console.log("\ud83d\udccb Current machine order loaded from localStorage:",e),s}catch(t){}return null},S=async e=>{const s="current_machine_order_".concat(e);if(localStorage.removeItem(s),n.$G)try{await n.ND.from("current_machine_orders").delete().eq("machine_name",e)}catch(a){}}},6353:(e,s,a)=>{a.d(s,{A:()=>r});a(5043);var t=a(9570),n=a(6446),i=a(579);const r=e=>{let{isOpen:s,title:a,message:r,confirmText:c="Confirm",cancelText:l="Cancel",onConfirm:o,onCancel:d,type:m="default"}=e;return(0,i.jsx)(t.N,{children:s&&(0,i.jsx)(n.P.div,{className:"confirm-dialog-overlay",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:d,children:(0,i.jsxs)(n.P.div,{className:"confirm-dialog",initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},onClick:e=>e.stopPropagation(),children:[(0,i.jsx)("div",{className:"confirm-dialog-header",children:(0,i.jsx)("h3",{children:a})}),(0,i.jsx)("div",{className:"confirm-dialog-body",children:(0,i.jsx)("p",{children:r})}),(0,i.jsxs)("div",{className:"confirm-dialog-footer",children:[(0,i.jsx)("button",{className:"btn btn-outline-secondary",onClick:d,children:l}),(0,i.jsx)("button",{className:"btn ".concat((()=>{switch(m){case"danger":return"btn-danger";case"success":return"btn-success";default:return"btn-primary"}})()),onClick:o,children:c})]})]})})})}}}]);
//# sourceMappingURL=640.4bc32c09.chunk.js.map