"use strict";(self.webpackChunkwaste_and_downtime_dashboard=self.webpackChunkwaste_and_downtime_dashboard||[]).push([[283],{6451:(t,e,a)=>{a.d(e,{PY:()=>n,rE:()=>s,wK:()=>o});const n=[],s=["Start-up Waste","Changeover Waste","Defective Product","Material Spillage"],o=["Machine Breakdown","Scheduled Maintenance","Changeover","Material Shortage"]},8283:(t,e,a)=>{a.d(e,{Bh:()=>l,D$:()=>u,F$:()=>O,GF:()=>A,Hc:()=>E,IN:()=>_,LO:()=>D,Rg:()=>N,Rn:()=>P,Yn:()=>W,bR:()=>y,mg:()=>g,nN:()=>m,nt:()=>T,te:()=>C,zl:()=>M});var n=a(7051),s=a(6451),o=a(1737);const r="waste_downtime_history",i="machines_data",c="failed_submissions_queue",l=()=>{const t=localStorage.getItem(c);if(!t)return[];try{return JSON.parse(t)}catch(e){return[]}},m=(t,e)=>{const a=l(),n={id:"failed_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:(new Date).toISOString(),retryCount:0,maxRetries:3,data:t,error:e};a.push(n),localStorage.setItem(c,JSON.stringify(a))},d=t=>{const e=l().filter(e=>e.id!==t);localStorage.setItem(c,JSON.stringify(e))},u=async()=>{if(!o.$G)return{succeeded:0,failed:0,remaining:l().length};const t=l();let e=0,a=0;for(const r of t)if(r.retryCount>=r.maxRetries)a++;else try{await(0,o.jw)(r.data.shiftData,r.data.wasteEntries,r.data.downtimeEntries,r.data.speedEntries,r.data.sachetMassEntries,r.data.looseCasesEntries,r.data.palletScanEntries),d(r.id),e++}catch(s){const t=l().map(t=>t.id===r.id?(0,n.A)((0,n.A)({},t),{},{retryCount:t.retryCount+1,error:String(s)}):t);localStorage.setItem(c,JSON.stringify(t)),a++}return{succeeded:e,failed:a,remaining:l().length}},g=()=>{const t="last_storage_cleanup",e=localStorage.getItem(t),a=new Date;if(e){const t=new Date(e);if((a.getTime()-t.getTime())/36e5<24)return}const n=(()=>{const t=D(),e=new Date,a=new Date(e.getTime()-7776e6);let n=t.filter(t=>new Date(t.date)>=a);n.length>1e3&&(n=n.slice(0,1e3));const s=t.length-n.length;return s>0&&(localStorage.setItem(r,JSON.stringify(n)),console.log("Cleaned up ".concat(s," old history entries"))),{removed:s,remaining:n.length}})();localStorage.setItem(t,a.toISOString()),n.removed>0&&console.log("Storage cleanup: removed ".concat(n.removed," entries, ").concat(n.remaining," remaining"))};let h=!0,S=null,p=[];const w=t=>({id:t.id,name:t.name,status:t.status,currentOperator:t.current_operator,currentOrder:t.current_order,currentShift:t.current_shift,lastSubmission:t.last_submission,todayWaste:t.today_waste,todayDowntime:t.today_downtime,subMachineCount:t.sub_machine_count}),f=t=>({id:t.id,name:t.name,status:t.status,current_operator:t.currentOperator,current_order:t.currentOrder,current_shift:t.currentShift,last_submission:t.lastSubmission,today_waste:t.todayWaste,today_downtime:t.todayDowntime,sub_machine_count:t.subMachineCount}),y=async()=>{try{const t=await(0,o.Dn)();if(t.length>0)return S=t.map(w),localStorage.setItem(i,JSON.stringify(S)),localStorage.setItem("machines_last_sync",(new Date).toISOString()),S;{console.log("No machines in Supabase, syncing defaults...");const t=s.PY.map(f);return await(0,o.ri)(t),S=s.PY,localStorage.setItem(i,JSON.stringify(s.PY)),s.PY}}catch(t){return console.error("Failed to initialize from Supabase, using localStorage:",t),h=!1,b()}},E=t=>{p.push(t);const e=(0,o.RS)(t=>{S=t.map(w),localStorage.setItem(i,JSON.stringify(S)),p.forEach(t=>t(S))},()=>(S||b()).map(f));return()=>{p=p.filter(e=>e!==t),0===p.length&&e()}},b=()=>{const t=localStorage.getItem(i);if(!t)return localStorage.setItem(i,JSON.stringify(s.PY)),s.PY;try{return JSON.parse(t)}catch(e){return s.PY}},_=t=>{const e=D();e.unshift(t),localStorage.setItem(r,JSON.stringify(e)),I(t.machine,t.submittedAt.toISOString())},D=()=>{const t=localStorage.getItem(r);if(!t)return[];try{return JSON.parse(t).map(t=>(0,n.A)((0,n.A)({},t),{},{submittedAt:new Date(t.submittedAt),wasteEntries:t.wasteEntries.map(t=>(0,n.A)((0,n.A)({},t),{},{timestamp:new Date(t.timestamp)})),downtimeEntries:t.downtimeEntries.map(t=>(0,n.A)((0,n.A)({},t),{},{timestamp:new Date(t.timestamp)}))}))}catch(e){return[]}},O=()=>{const t=(new Date).toISOString().split("T")[0],e=D().filter(e=>e.date===t);return{totalWaste:e.reduce((t,e)=>t+e.totalWaste,0),totalDowntime:e.reduce((t,e)=>t+e.totalDowntime,0),submissionCount:e.length}},I=(t,e)=>{const a=N(),n=a.findIndex(e=>e.name===t);-1!==n&&(a[n].lastSubmission=v(new Date(e))),localStorage.setItem(i,JSON.stringify(a))},N=()=>S||b(),C=async(t,e)=>{const a=N(),s=a.findIndex(e=>e.id===t);if(-1!==s&&(a[s]=(0,n.A)((0,n.A)({},a[s]),e),S=a,localStorage.setItem(i,JSON.stringify(a)),h))try{await(0,o.hx)(f(a[s]))}catch(r){console.error("Failed to sync machine update to Supabase:",r)}},M=async t=>{const e=N();if(e.push(t),S=e,localStorage.setItem(i,JSON.stringify(e)),h)try{await(0,o.hx)(f(t))}catch(a){console.error("Failed to sync new machine to Supabase:",a)}},P=async t=>{const e=N().filter(e=>e.id!==t);if(S=e,localStorage.setItem(i,JSON.stringify(e)),h)try{await(0,o._T)(t)}catch(a){console.error("Failed to delete machine from Supabase:",a)}},v=t=>{const e=(new Date).getTime()-t.getTime(),a=Math.floor(e/6e4),n=Math.floor(a/60),s=Math.floor(n/24);return a<1?"Just now":a<60?"".concat(a," min ago"):n<24?"".concat(n," hour").concat(n>1?"s":""," ago"):"".concat(s," day").concat(s>1?"s":""," ago")},A=(t,e)=>{const a=[];t.forEach(t=>{const e=[t.date,t.shift,t.operatorName,t.machine,t.orderNumber,t.product,t.batchNumber],n=t.submittedAt?new Date(t.submittedAt).toLocaleString():"";t.wasteEntries&&t.wasteEntries.length>0&&t.wasteEntries.forEach(t=>{const s=t.timestamp?new Date(t.timestamp).toLocaleString():"";a.push([...e,"Waste",s,t.wasteType,t.waste.toFixed(2),"","","","","","","","","","",n])}),t.downtimeEntries&&t.downtimeEntries.length>0&&t.downtimeEntries.forEach(t=>{const s=t.timestamp?new Date(t.timestamp).toLocaleString():"";a.push([...e,"Downtime",s,"","",t.downtimeReason,t.downtime.toString(),"","","","","","","","",n])}),t.speedEntries&&t.speedEntries.length>0&&t.speedEntries.forEach(t=>{const s=t.timestamp?new Date(t.timestamp).toLocaleString():"";a.push([...e,"Speed",s,"","","","",t.speed.toString(),"","","","","","","",n])}),t.sachetMassEntries&&t.sachetMassEntries.length>0&&t.sachetMassEntries.forEach(t=>{const s=t.timestamp?new Date(t.timestamp).toLocaleString():"";a.push([...e,"Sachet Mass",s,"","","","","",t.mass.toString(),"","","","","","",n])}),t.looseCasesEntries&&t.looseCasesEntries.length>0&&t.looseCasesEntries.forEach(t=>{const s=t.timestamp?new Date(t.timestamp).toLocaleString():"";a.push([...e,"Loose Cases",s,"","","","","","",t.batchNumber,t.cases.toString(),"","","","",n])}),t.palletScanEntries&&t.palletScanEntries.length>0&&t.palletScanEntries.forEach(t=>{var s,o;const r=t.timestamp?new Date(t.timestamp).toLocaleString():"";a.push([...e,"Pallet Scan",r,"","","","","","","","",t.qrCode||"",t.batchNumber||"",(null===(s=t.palletNumber)||void 0===s?void 0:s.toString())||"",(null===(o=t.casesCount)||void 0===o?void 0:o.toString())||"",n])});(!t.wasteEntries||0===t.wasteEntries.length)&&(!t.downtimeEntries||0===t.downtimeEntries.length)&&(!t.speedEntries||0===t.speedEntries.length)&&(!t.sachetMassEntries||0===t.sachetMassEntries.length)&&(!t.looseCasesEntries||0===t.looseCasesEntries.length)&&(!t.palletScanEntries||0===t.palletScanEntries.length)&&a.push([...e,"Summary","","",(t.totalWaste||0).toFixed(2),"",(t.totalDowntime||0).toString(),"","","","","","","","",n])});const n=[["Date","Shift","Operator","Machine","Order Number","Product","Batch Number","Entry Type","Entry Timestamp","Waste Type","Waste (kg)","Downtime Reason","Downtime (min)","Speed (PPM)","Sachet Mass (g)","Loose Cases Batch","Loose Cases Count","Pallet QR Code","Pallet Batch","Pallet Number","Pallet Cases","Submitted At"].join(","),...a.map(t=>t.map(t=>'"'.concat(t,'"')).join(","))].join("\n"),s=new Blob([n],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),r=URL.createObjectURL(s);o.setAttribute("href",r),o.setAttribute("download","".concat(e,".csv")),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)},J="line_speed_",L=t=>{const e=t.match(/^(.+?)\s*-\s*Machine\s*\d+$/i);return e?e[1].trim():t},R=(t,e,a)=>"".concat(J).concat(t,"_").concat(e,"_").concat(a),T=(t,e,a,n)=>{const s=L(t),o=R(s,e,a),r={speed:n,updatedAt:(new Date).toISOString(),updatedBy:t};localStorage.setItem(o,JSON.stringify(r)),console.log("\ud83d\udcbe Saved line speed ".concat(n," PPM for ").concat(s))},W=(t,e,a)=>{const n=L(t),s=R(n,e,a),o=localStorage.getItem(s);if(!o)return null;try{const t=JSON.parse(o);return console.log("\ud83d\udcd6 Loaded line speed ".concat(t.speed," PPM for ").concat(n," (set by ").concat(t.updatedBy,")")),t}catch(r){return null}}}}]);
//# sourceMappingURL=283.4ffc7c30.chunk.js.map