"use strict";(self.webpackChunkwaste_and_downtime_dashboard=self.webpackChunkwaste_and_downtime_dashboard||[]).push([[155],{2155:(e,a,t)=>{t.r(a),t.d(a,{default:()=>h});var s=t(5043),n=t(1737),c=t(579);const r="chat_user_name",l="chat_client_id",o=500,i=e=>{if(!e)return"";const a=new Date(e);return Number.isNaN(a.getTime())?"":a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},h=e=>{let{operatorName:a,machineName:t}=e;const[h,d]=(0,s.useState)(!1),[m,u]=(0,s.useState)([]),[g,p]=(0,s.useState)(""),[v,f]=(0,s.useState)(""),[N,x]=(0,s.useState)([]),[j,S]=(0,s.useState)(null),[b,_]=(0,s.useState)(!1),[w,y]=(0,s.useState)(0),[E,C]=(0,s.useState)(!1),k=(0,s.useRef)(null),D=(0,s.useRef)(null),A=(0,s.useRef)(null);(0,s.useEffect)(()=>{const e=localStorage.getItem(r)||"",t=(a||e).trim();f(t)},[a]),(0,s.useEffect)(()=>{localStorage.setItem(r,v)},[v]);const I=(0,s.useCallback)(()=>{const e=v.trim()||"Operator",a=t||localStorage.getItem("chat_current_machine")||"";if(a){const t=a.split(" - "),s=t.length>1?"".concat(t[0]," M").concat(t[1].replace("Machine ","")):a;return"".concat(e," @ ").concat(s)}return e},[v,t]);(0,s.useEffect)(()=>{var e;if(!n.$G)return;const a=localStorage.getItem(l),t=globalThis.crypto,s=a||(null===t||void 0===t||null===(e=t.randomUUID)||void 0===e?void 0:e.call(t))||"".concat(Date.now(),"-").concat(Math.random());a||localStorage.setItem(l,s);const c=n.ND.channel("team-chat-presence",{config:{presence:{key:s}}});D.current=c;const r=()=>{const e=c.presenceState(),a=[];Object.values(e).forEach(e=>{e.forEach(e=>{const t=(null===e||void 0===e?void 0:e.user_name)||"";t.trim()&&a.push(t.trim())})});const t=Array.from(new Set(a));x(t)};return c.on("presence",{event:"sync"},r).on("presence",{event:"join"},r).on("presence",{event:"leave"},r),c.subscribe(async e=>{"SUBSCRIBED"===e&&await c.track({user_name:(v||"Operator").trim(),online_at:(new Date).toISOString()})}),()=>{D.current=null,n.ND.removeChannel(c)}},[]),(0,s.useEffect)(()=>{if(!n.$G)return;const e=D.current;e&&e.track({user_name:(v||"Operator").trim(),online_at:(new Date).toISOString()})},[v]);const O=(0,s.useMemo)(()=>h?0:m.length>0?1:0,[h,m.length]);(0,s.useEffect)(()=>{let e=!0;(async()=>{try{S(null);const a=await(0,n.qH)(100);if(!e)return;u(a)}catch(a){if(!e)return;S(a instanceof Error?a.message:"Failed to load chat messages.")}})();const a=(0,n.r5)(e=>{u(a=>e.id&&a.some(a=>a.id===e.id)?a:[...a,e])});return()=>{e=!1,a()}},[]),(0,s.useEffect)(()=>{var e;h&&(null===(e=k.current)||void 0===e||e.scrollIntoView({behavior:"smooth"}))},[h,m]),(0,s.useEffect)(()=>{h&&A.current&&A.current.focus()},[h]);const T=(0,s.useCallback)(()=>Date.now()-w>=2e3,[w]),P=async()=>{if(!T())return C(!0),void setTimeout(()=>C(!1),2e3);try{if(!n.$G)return void S("Chat is not configured. Set REACT_APP_SUPABASE_URL and REACT_APP_SUPABASE_ANON_KEY and redeploy.");const e=g.trim();if(!e)return;if(e.length>o)return void S("Message too long. Max ".concat(o," characters."));S(null),_(!0),y(Date.now());const a=await(0,n.gJ)(I(),e);u(e=>a.id&&e.some(e=>e.id===a.id)?e:[...e,a]),p("")}catch(e){S(e instanceof Error?e.message:"Failed to send message.")}finally{_(!1)}},R=o-g.length,M=R<=50;return(0,c.jsxs)("div",{className:"chat-widget",children:[(0,c.jsxs)("button",{type:"button",className:"chat-toggle",onClick:()=>d(e=>!e),"aria-expanded":h,"aria-label":"Open chat",children:["\ud83d\udcac Chat",O?" \u2022":""]}),h&&(0,c.jsxs)("div",{className:"chat-panel",role:"dialog","aria-label":"Chat",children:[(0,c.jsxs)("div",{className:"chat-header",children:[(0,c.jsx)("div",{className:"chat-title",children:"Team Chat"}),(0,c.jsxs)("div",{className:"chat-online",children:[(0,c.jsx)("span",{className:"online-dot"}),N.length," online"]}),(0,c.jsx)("button",{type:"button",className:"chat-close",onClick:()=>d(!1),"aria-label":"Close chat",children:"\u2715"})]}),(0,c.jsx)("div",{className:"chat-presence","aria-label":"Online operators",children:0===N.length?(0,c.jsx)("span",{className:"chat-presence-empty",children:"No one online"}):(0,c.jsx)("span",{className:"chat-presence-list",children:N.join(", ")})}),(0,c.jsx)("div",{className:"chat-name-row",children:(0,c.jsxs)("label",{className:"chat-name-label",children:["Your Name",(0,c.jsx)("input",{className:"chat-name-input",value:v,onChange:e=>f(e.target.value),placeholder:"Enter your name",maxLength:50})]})}),(0,c.jsxs)("div",{className:"chat-messages","aria-live":"polite",children:[0===m.length&&(0,c.jsx)("div",{className:"chat-empty-state",children:"No messages yet. Start the conversation!"}),m.map(e=>{var a;return(0,c.jsxs)("div",{className:"chat-message",children:[(0,c.jsxs)("div",{className:"chat-message-meta",children:[(0,c.jsx)("span",{className:"chat-message-name",children:e.user_name}),(0,c.jsx)("span",{className:"chat-message-time",children:i(e.created_at)})]}),(0,c.jsx)("div",{className:"chat-message-body",children:e.content})]},null!==(a=e.id)&&void 0!==a?a:"".concat(e.user_name,"-").concat(e.created_at,"-").concat(e.content))}),(0,c.jsx)("div",{ref:k})]}),j&&(0,c.jsx)("div",{className:"chat-error",role:"alert",children:j}),E&&(0,c.jsx)("div",{className:"chat-rate-limit",role:"alert",children:"Please wait before sending another message."}),(0,c.jsxs)("div",{className:"chat-compose",children:[(0,c.jsxs)("div",{className:"chat-compose-wrapper",children:[(0,c.jsx)("input",{ref:A,className:"chat-compose-input",value:g,onChange:e=>{const a=e.target.value;a.length<=o&&p(a)},placeholder:"Type a message\u2026",maxLength:o,disabled:b,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),P())}}),g.length>0&&(0,c.jsx)("span",{className:"chat-char-count ".concat(M?"warning":""),children:R})]}),(0,c.jsx)("button",{type:"button",className:"chat-send",onClick:P,disabled:b||!g.trim()||!v.trim(),"aria-label":"Send message",children:b?"...":"Send"})]})]})]})}}}]);
//# sourceMappingURL=155.e46da119.chunk.js.map