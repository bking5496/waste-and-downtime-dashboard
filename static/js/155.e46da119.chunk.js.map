{"version":3,"file":"static/js/155.e46da119.chunk.js","mappings":"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","sources":["components/ChatWidget.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useRef, useState, useCallback } from 'react';\r\nimport {\r\n  ChatMessageRecord,\r\n  fetchRecentChatMessages,\r\n  isSupabaseConfigured,\r\n  supabase,\r\n  sendChatMessage,\r\n  subscribeChatMessages,\r\n} from '../lib/supabase';\r\n\r\ntype ChatWidgetProps = {\r\n  operatorName?: string;\r\n  machineName?: string; // Current machine location (e.g., \"Canline - Machine 1\")\r\n};\r\n\r\nconst STORAGE_KEY = 'chat_user_name';\r\nconst CLIENT_ID_KEY = 'chat_client_id';\r\nconst CURRENT_MACHINE_KEY = 'chat_current_machine'; // Tracks what machine user is currently on\r\nconst MAX_MESSAGE_LENGTH = 500;\r\nconst RATE_LIMIT_MS = 2000; // 2 seconds between messages\r\n\r\nconst formatTime = (iso?: string) => {\r\n  if (!iso) return '';\r\n  const d = new Date(iso);\r\n  if (Number.isNaN(d.getTime())) return '';\r\n  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n};\r\n\r\nconst ChatWidget: React.FC<ChatWidgetProps> = ({ operatorName, machineName }) => {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [messages, setMessages] = useState<ChatMessageRecord[]>([]);\r\n  const [draft, setDraft] = useState('');\r\n  const [userName, setUserName] = useState('');\r\n  const [onlineUsers, setOnlineUsers] = useState<string[]>([]);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [isSending, setIsSending] = useState(false);\r\n  const [lastSentTime, setLastSentTime] = useState(0);\r\n  const [rateLimitWarning, setRateLimitWarning] = useState(false);\r\n\r\n  const messagesEndRef = useRef<HTMLDivElement | null>(null);\r\n  const presenceChannelRef = useRef<any>(null);\r\n  const inputRef = useRef<HTMLInputElement | null>(null);\r\n\r\n  // Resolve a kiosk-friendly name: operatorName from form > localStorage > empty\r\n  useEffect(() => {\r\n    const fromStorage = localStorage.getItem(STORAGE_KEY) || '';\r\n    const initial = (operatorName || fromStorage).trim();\r\n    setUserName(initial);\r\n  }, [operatorName]);\r\n\r\n  useEffect(() => {\r\n    localStorage.setItem(STORAGE_KEY, userName);\r\n  }, [userName]);\r\n\r\n  // Format display name with machine location for sending\r\n  const getDisplayNameForSending = useCallback(() => {\r\n    const baseName = userName.trim() || 'Operator';\r\n    // Use prop first, then fall back to localStorage\r\n    const currentMachine = machineName || localStorage.getItem(CURRENT_MACHINE_KEY) || '';\r\n    if (currentMachine) {\r\n      // Extract just the machine identity for brevity (e.g., \"Canline M1\" from \"Canline - Machine 1\")\r\n      const parts = currentMachine.split(' - ');\r\n      const shortMachine = parts.length > 1\r\n        ? `${parts[0]} M${parts[1].replace('Machine ', '')}`\r\n        : currentMachine;\r\n      return `${baseName} @ ${shortMachine}`;\r\n    }\r\n    return baseName;\r\n  }, [userName, machineName]);\r\n\r\n  // Presence: who is online right now.\r\n  useEffect(() => {\r\n    if (!isSupabaseConfigured) return;\r\n\r\n    const existingClientId = localStorage.getItem(CLIENT_ID_KEY);\r\n    const cryptoObj = (globalThis as unknown as { crypto?: Crypto }).crypto;\r\n    const clientId = existingClientId || cryptoObj?.randomUUID?.() || `${Date.now()}-${Math.random()}`;\r\n    if (!existingClientId) localStorage.setItem(CLIENT_ID_KEY, clientId);\r\n\r\n    const channel = supabase.channel('team-chat-presence', {\r\n      config: {\r\n        presence: { key: clientId },\r\n      },\r\n    });\r\n\r\n    presenceChannelRef.current = channel;\r\n\r\n    const computeOnline = () => {\r\n      const state = channel.presenceState();\r\n      const names: string[] = [];\r\n\r\n      Object.values(state).forEach((metas) => {\r\n        // metas is an array of presence payloads\r\n        (metas as Array<Record<string, unknown>>).forEach((meta) => {\r\n          const name = (meta?.user_name as string | undefined) || '';\r\n          if (name.trim()) names.push(name.trim());\r\n        });\r\n      });\r\n\r\n      // Deduplicate but keep stable ordering.\r\n      const unique = Array.from(new Set(names));\r\n      setOnlineUsers(unique);\r\n    };\r\n\r\n    channel\r\n      .on('presence', { event: 'sync' }, computeOnline)\r\n      .on('presence', { event: 'join' }, computeOnline)\r\n      .on('presence', { event: 'leave' }, computeOnline);\r\n\r\n    channel.subscribe(async (status) => {\r\n      if (status !== 'SUBSCRIBED') return;\r\n      await channel.track({\r\n        user_name: (userName || 'Operator').trim(),\r\n        online_at: new Date().toISOString(),\r\n      });\r\n    });\r\n\r\n    return () => {\r\n      presenceChannelRef.current = null;\r\n      supabase.removeChannel(channel);\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  // Re-track when the operator name changes.\r\n  useEffect(() => {\r\n    if (!isSupabaseConfigured) return;\r\n    const channel = presenceChannelRef.current;\r\n    if (!channel) return;\r\n    channel.track({\r\n      user_name: (userName || 'Operator').trim(),\r\n      online_at: new Date().toISOString(),\r\n    });\r\n  }, [userName]);\r\n\r\n  const unreadCount = useMemo(() => {\r\n    if (isOpen) return 0;\r\n    // simplest: show a dot if there are messages\r\n    return messages.length > 0 ? 1 : 0;\r\n  }, [isOpen, messages.length]);\r\n\r\n  useEffect(() => {\r\n    let isMounted = true;\r\n\r\n    const load = async () => {\r\n      try {\r\n        setError(null);\r\n        const data = await fetchRecentChatMessages(100);\r\n        if (!isMounted) return;\r\n        setMessages(data);\r\n      } catch (e) {\r\n        if (!isMounted) return;\r\n        setError(e instanceof Error ? e.message : 'Failed to load chat messages.');\r\n      }\r\n    };\r\n\r\n    load();\r\n\r\n    const unsubscribe = subscribeChatMessages((message) => {\r\n      setMessages((prev) => {\r\n        // avoid duplicates (reconnects / optimistic inserts)\r\n        if (message.id && prev.some((m) => m.id === message.id)) return prev;\r\n        return [...prev, message];\r\n      });\r\n    });\r\n\r\n    return () => {\r\n      isMounted = false;\r\n      unsubscribe();\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!isOpen) return;\r\n    // Scroll to bottom when opened or messages update while open\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [isOpen, messages]);\r\n\r\n  // Focus input when chat opens\r\n  useEffect(() => {\r\n    if (isOpen && inputRef.current) {\r\n      inputRef.current.focus();\r\n    }\r\n  }, [isOpen]);\r\n\r\n  // Check rate limit\r\n  const canSend = useCallback(() => {\r\n    const now = Date.now();\r\n    const timeSinceLastSend = now - lastSentTime;\r\n    return timeSinceLastSend >= RATE_LIMIT_MS;\r\n  }, [lastSentTime]);\r\n\r\n  const handleSend = async () => {\r\n    // Check rate limit\r\n    if (!canSend()) {\r\n      setRateLimitWarning(true);\r\n      setTimeout(() => setRateLimitWarning(false), 2000);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (!isSupabaseConfigured) {\r\n        setError('Chat is not configured. Set REACT_APP_SUPABASE_URL and REACT_APP_SUPABASE_ANON_KEY and redeploy.');\r\n        return;\r\n      }\r\n\r\n      const trimmedDraft = draft.trim();\r\n      if (!trimmedDraft) return;\r\n      if (trimmedDraft.length > MAX_MESSAGE_LENGTH) {\r\n        setError(`Message too long. Max ${MAX_MESSAGE_LENGTH} characters.`);\r\n        return;\r\n      }\r\n\r\n      setError(null);\r\n      setIsSending(true);\r\n      setLastSentTime(Date.now());\r\n\r\n      const sent = await sendChatMessage(getDisplayNameForSending(), trimmedDraft);\r\n\r\n      // Optimistic UI: show the message immediately for the sender.\r\n      // This also covers cases where Realtime is not enabled (subscription won't fire).\r\n      setMessages((prev) => {\r\n        if (sent.id && prev.some((m) => m.id === sent.id)) return prev;\r\n        return [...prev, sent];\r\n      });\r\n\r\n      setDraft('');\r\n    } catch (e) {\r\n      setError(e instanceof Error ? e.message : 'Failed to send message.');\r\n    } finally {\r\n      setIsSending(false);\r\n    }\r\n  };\r\n\r\n  const handleDraftChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const value = e.target.value;\r\n    // Allow typing but enforce max length\r\n    if (value.length <= MAX_MESSAGE_LENGTH) {\r\n      setDraft(value);\r\n    }\r\n  };\r\n\r\n  const charsRemaining = MAX_MESSAGE_LENGTH - draft.length;\r\n  const showCharWarning = charsRemaining <= 50;\r\n\r\n  return (\r\n    <div className=\"chat-widget\">\r\n      <button\r\n        type=\"button\"\r\n        className=\"chat-toggle\"\r\n        onClick={() => setIsOpen((v) => !v)}\r\n        aria-expanded={isOpen}\r\n        aria-label=\"Open chat\"\r\n      >\r\n        ðŸ’¬ Chat{unreadCount ? ' â€¢' : ''}\r\n      </button>\r\n\r\n      {isOpen && (\r\n        <div className=\"chat-panel\" role=\"dialog\" aria-label=\"Chat\">\r\n          <div className=\"chat-header\">\r\n            <div className=\"chat-title\">Team Chat</div>\r\n            <div className=\"chat-online\">\r\n              <span className=\"online-dot\"></span>\r\n              {onlineUsers.length} online\r\n            </div>\r\n            <button type=\"button\" className=\"chat-close\" onClick={() => setIsOpen(false)} aria-label=\"Close chat\">\r\n              âœ•\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"chat-presence\" aria-label=\"Online operators\">\r\n            {onlineUsers.length === 0 ? (\r\n              <span className=\"chat-presence-empty\">No one online</span>\r\n            ) : (\r\n              <span className=\"chat-presence-list\">{onlineUsers.join(', ')}</span>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"chat-name-row\">\r\n            <label className=\"chat-name-label\">\r\n              Your Name\r\n              <input\r\n                className=\"chat-name-input\"\r\n                value={userName}\r\n                onChange={(e) => setUserName(e.target.value)}\r\n                placeholder=\"Enter your name\"\r\n                maxLength={50}\r\n              />\r\n            </label>\r\n          </div>\r\n\r\n          <div className=\"chat-messages\" aria-live=\"polite\">\r\n            {messages.length === 0 && (\r\n              <div className=\"chat-empty-state\">\r\n                No messages yet. Start the conversation!\r\n              </div>\r\n            )}\r\n            {messages.map((m) => (\r\n              <div key={m.id ?? `${m.user_name}-${m.created_at}-${m.content}`} className=\"chat-message\">\r\n                <div className=\"chat-message-meta\">\r\n                  <span className=\"chat-message-name\">{m.user_name}</span>\r\n                  <span className=\"chat-message-time\">{formatTime(m.created_at)}</span>\r\n                </div>\r\n                <div className=\"chat-message-body\">{m.content}</div>\r\n              </div>\r\n            ))}\r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n\r\n          {error && <div className=\"chat-error\" role=\"alert\">{error}</div>}\r\n          {rateLimitWarning && (\r\n            <div className=\"chat-rate-limit\" role=\"alert\">\r\n              Please wait before sending another message.\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"chat-compose\">\r\n            <div className=\"chat-compose-wrapper\">\r\n              <input\r\n                ref={inputRef}\r\n                className=\"chat-compose-input\"\r\n                value={draft}\r\n                onChange={handleDraftChange}\r\n                placeholder=\"Type a messageâ€¦\"\r\n                maxLength={MAX_MESSAGE_LENGTH}\r\n                disabled={isSending}\r\n                onKeyDown={(e) => {\r\n                  if (e.key === 'Enter' && !e.shiftKey) {\r\n                    e.preventDefault();\r\n                    handleSend();\r\n                  }\r\n                }}\r\n              />\r\n              {draft.length > 0 && (\r\n                <span className={`chat-char-count ${showCharWarning ? 'warning' : ''}`}>\r\n                  {charsRemaining}\r\n                </span>\r\n              )}\r\n            </div>\r\n            <button\r\n              type=\"button\"\r\n              className=\"chat-send\"\r\n              onClick={handleSend}\r\n              disabled={isSending || !draft.trim() || !userName.trim()}\r\n              aria-label=\"Send message\"\r\n            >\r\n              {isSending ? '...' : 'Send'}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ChatWidget;\r\n"],"names":["STORAGE_KEY","CLIENT_ID_KEY","MAX_MESSAGE_LENGTH","formatTime","iso","d","Date","Number","isNaN","getTime","toLocaleTimeString","hour","minute","_ref","operatorName","machineName","isOpen","setIsOpen","useState","messages","setMessages","draft","setDraft","userName","setUserName","onlineUsers","setOnlineUsers","error","setError","isSending","setIsSending","lastSentTime","setLastSentTime","rateLimitWarning","setRateLimitWarning","messagesEndRef","useRef","presenceChannelRef","inputRef","useEffect","fromStorage","localStorage","getItem","initial","trim","setItem","getDisplayNameForSending","useCallback","baseName","currentMachine","parts","split","shortMachine","length","concat","replace","_cryptoObj$randomUUID","isSupabaseConfigured","existingClientId","cryptoObj","globalThis","crypto","clientId","randomUUID","call","now","Math","random","channel","supabase","config","presence","key","current","computeOnline","state","presenceState","names","Object","values","forEach","metas","meta","name","user_name","push","unique","Array","from","Set","on","event","subscribe","async","status","track","online_at","toISOString","removeChannel","unreadCount","useMemo","isMounted","data","fetchRecentChatMessages","e","Error","message","load","unsubscribe","subscribeChatMessages","prev","id","some","m","_messagesEndRef$curre","scrollIntoView","behavior","focus","canSend","handleSend","setTimeout","trimmedDraft","sent","sendChatMessage","charsRemaining","showCharWarning","_jsxs","className","children","type","onClick","v","role","_jsx","join","value","onChange","target","placeholder","maxLength","map","_m$id","created_at","content","ref","disabled","onKeyDown","shiftKey","preventDefault"],"ignoreList":[],"sourceRoot":""}