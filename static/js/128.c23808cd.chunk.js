"use strict";(self.webpackChunkwaste_and_downtime_dashboard=self.webpackChunkwaste_and_downtime_dashboard||[]).push([[128],{6316:(e,t,s)=>{s.d(t,{$C:()=>f,CJ:()=>D,Fd:()=>y,KW:()=>l,PX:()=>S,RU:()=>N,WA:()=>c,ZX:()=>b,b6:()=>u,dj:()=>g,fetchLiveSessionByMachine:()=>d,yw:()=>m});var a=s(7051),n=s(1737);const o=(e,t,s)=>"".concat(e,"_").concat(t,"_").concat(s);let r=new Map,i=0;const c=async e=>{const t=o(e.machineName,e.shift,e.date),s={id:t,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()};if(r.set(t,s),n.$G)try{const{error:s}=await n.ND.from("live_sessions").upsert({id:t,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()},{onConflict:"id"});return s?(console.error("Failed to upsert live session:",s.message),!1):(console.log("\u2705 Live session synced to Supabase:",t),!0)}catch(a){return console.error("Failed to upsert live session:",a),!1}return!0},l=async(e,t,s)=>{const a=o(e,t,s);if(r.delete(a),n.$G)try{const{error:e}=await n.ND.from("live_sessions").delete().eq("id",a);return!e||(console.error("Failed to delete live session:",e.message),!1)}catch(i){return console.error("Failed to delete live session:",i),!1}return!0},m=async()=>{const e=Date.now(),t=(new Date).toISOString().split("T")[0],s=e-i<3e4;if(n.$G)try{const{data:s,error:a}=await n.ND.from("live_sessions").select("*").eq("session_date",t).eq("is_locked",!0);return a?(console.error("Failed to fetch live sessions:",a.message),Array.from(r.values()).filter(e=>e.session_date===t&&e.is_locked)):(r.clear(),(s||[]).forEach(e=>{r.set(e.id,e)}),i=e,console.log("\ud83d\udccb Fetched active sessions from Supabase:",(s||[]).length,null===s||void 0===s?void 0:s.map(e=>e.machine_name)),s||[])}catch(a){return console.error("Failed to fetch live sessions:",a),Array.from(r.values()).filter(e=>e.session_date===t&&e.is_locked)}return s?Array.from(r.values()).filter(e=>e.session_date===t&&e.is_locked):[]},d=async(e,t,s)=>{const a=o(e,t,s);if(r.has(a))return r.get(a)||null;if(!n.$G)return null;try{const{data:t,error:s}=await n.ND.from("live_sessions").select("*").eq("id",a).eq("is_locked",!0).maybeSingle();return s?(console.error("Failed to fetch session:",s.message),null):(t&&(r.set(a,t),console.log("\ud83d\udccb Restored session from Supabase:",e)),t)}catch(i){return console.error("Failed to fetch session by machine:",i),null}},u=e=>{if(!n.$G)return()=>{};(new Date).toISOString().split("T")[0];const t=n.ND.channel("live-sessions-changes").on("postgres_changes",{event:"*",schema:"public",table:"live_sessions"},async t=>{console.log("\ud83d\udd04 Real-time session update received:",t.eventType);const s=await m();e(s)}).subscribe(e=>{console.log("\ud83d\udce1 Session subscription status:",e)});return()=>{n.ND.removeChannel(t)}};let p=[];let h=[];const g=e=>{const t=(0,a.A)((0,a.A)({},e),{},{id:"".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),timestamp:new Date});p=[t,...p].slice(0,50),h.forEach(e=>e([...p])),n.$G&&w(t)},w=async e=>{try{const t=n.ND.channel("activity-broadcast");await t.send({type:"broadcast",event:"activity",payload:(0,a.A)((0,a.A)({},e),{},{timestamp:e.timestamp.toISOString()})})}catch(t){}},f=e=>{h.push(e),e([...p]);let t=null;return n.$G&&(t=n.ND.channel("activity-broadcast").on("broadcast",{event:"activity"},e=>{const t=e.payload,s=(0,a.A)((0,a.A)({},t),{},{timestamp:new Date(t.timestamp)});p.some(e=>e.id===s.id)||(p=[s,...p].slice(0,50),h.forEach(e=>e([...p])))}).subscribe()),()=>{h=h.filter(t=>t!==e),t&&n.ND.removeChannel(t)}},S=async(e,t,s,a)=>{if(!n.$G)return!1;const r=o(e,t,s),i=JSON.stringify(a);try{const{error:e}=await n.ND.from("live_sessions").update({entries_json:i,updated_at:(new Date).toISOString()}).eq("id",r);return e?(e.message.includes("entries_json")||e.message.includes("column")||console.error("Failed to sync entries:",e.message),!1):(console.log("\ud83d\udce6 Entries synced to Supabase:",r),!0)}catch(c){return!1}},y=async(e,t,s)=>{if(!n.$G)return null;const a=o(e,t,s);try{const{data:e,error:t}=await n.ND.from("live_sessions").select("entries_json").eq("id",a).maybeSingle();if(t)return t.message.includes("entries_json")||t.message.includes("column")||console.error("Failed to fetch entries:",t.message),null;if(null!==e&&void 0!==e&&e.entries_json){const t=JSON.parse(e.entries_json);return console.log("\ud83d\udce6 Entries restored from Supabase:",a),t}return null}catch(r){return null}},b=(e,t,s,a)=>{if(!n.$G)return()=>{};const r=o(e,t,s),i=n.ND.channel("entries-".concat(r)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"live_sessions",filter:"id=eq.".concat(r)},e=>{const t=e.new;if(t.entries_json)try{const e=JSON.parse(t.entries_json);console.log("\ud83d\udd04 Real-time entries update received:",r),a(e)}catch(s){console.error("Failed to parse entries update:",s)}}).subscribe(e=>{console.log("\ud83d\udce1 Entry sync subscription status:",e,r)});return()=>{n.ND.removeChannel(i)}},_=e=>"string"===typeof e?e:e instanceof Date?e.toISOString():new Date(e).toISOString(),N=(e,t,s,a,n,o)=>({wasteEntries:e.map(e=>({id:e.id,waste:e.waste,wasteType:e.wasteType,timestamp:_(e.timestamp)})),downtimeEntries:t.map(e=>({id:e.id,downtime:e.downtime,downtimeReason:e.downtimeReason,timestamp:_(e.timestamp)})),speedEntries:s.map(e=>({id:e.id,speed:e.speed,timestamp:_(e.timestamp)})),sachetMassEntries:a.map(e=>({id:e.id,mass:e.mass,timestamp:_(e.timestamp)})),looseCasesEntries:n.map(e=>({id:e.id,batchNumber:e.batchNumber,cases:e.cases,timestamp:_(e.timestamp)})),palletScanEntries:o.map(e=>({id:e.id,qrCode:e.qrCode,batchNumber:e.batchNumber,palletNumber:e.palletNumber,casesCount:e.casesCount,timestamp:_(e.timestamp),ignored:e.ignored}))}),D=e=>({wasteEntries:e.wasteEntries.map(e=>({id:e.id,waste:e.waste,wasteType:e.wasteType,timestamp:new Date(e.timestamp)})),downtimeEntries:e.downtimeEntries.map(e=>({id:e.id,downtime:e.downtime,downtimeReason:e.downtimeReason,timestamp:new Date(e.timestamp)})),speedEntries:e.speedEntries.map(e=>({id:e.id,speed:e.speed,timestamp:new Date(e.timestamp)})),sachetMassEntries:e.sachetMassEntries.map(e=>({id:e.id,mass:e.mass,timestamp:new Date(e.timestamp)})),looseCasesEntries:e.looseCasesEntries.map(e=>({id:e.id,batchNumber:e.batchNumber,cases:e.cases,timestamp:new Date(e.timestamp)})),palletScanEntries:e.palletScanEntries.map(e=>({id:e.id,qrCode:e.qrCode,batchNumber:e.batchNumber,palletNumber:e.palletNumber,casesCount:e.casesCount,timestamp:new Date(e.timestamp),ignored:e.ignored}))})},6451:(e,t,s)=>{s.d(t,{PY:()=>a,rE:()=>n,wK:()=>o});const a=[],n=["Start-up Waste","Changeover Waste","Defective Product","Material Spillage"],o=["Machine Breakdown","Scheduled Maintenance","Changeover","Material Shortage"]},8283:(e,t,s)=>{s.d(t,{Bh:()=>l,D$:()=>u,F$:()=>v,GF:()=>F,Hc:()=>b,IN:()=>N,LO:()=>D,Rg:()=>O,Rn:()=>A,Yn:()=>P,bR:()=>y,mg:()=>p,nN:()=>m,nt:()=>k,te:()=>I,zl:()=>C});var a=s(7051),n=s(6451),o=s(1737);const r="waste_downtime_history",i="machines_data",c="failed_submissions_queue",l=()=>{const e=localStorage.getItem(c);if(!e)return[];try{return JSON.parse(e)}catch(t){return[]}},m=(e,t)=>{const s=l(),a={id:"failed_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:(new Date).toISOString(),retryCount:0,maxRetries:3,data:e,error:t};s.push(a),localStorage.setItem(c,JSON.stringify(s))},d=e=>{const t=l().filter(t=>t.id!==e);localStorage.setItem(c,JSON.stringify(t))},u=async()=>{if(!o.$G)return{succeeded:0,failed:0,remaining:l().length};const e=l();let t=0,s=0;for(const r of e)if(r.retryCount>=r.maxRetries)s++;else try{await(0,o.jw)(r.data.shiftData,r.data.wasteEntries,r.data.downtimeEntries,r.data.speedEntries,r.data.sachetMassEntries,r.data.looseCasesEntries,r.data.palletScanEntries),d(r.id),t++}catch(n){const e=l().map(e=>e.id===r.id?(0,a.A)((0,a.A)({},e),{},{retryCount:e.retryCount+1,error:String(n)}):e);localStorage.setItem(c,JSON.stringify(e)),s++}return{succeeded:t,failed:s,remaining:l().length}},p=()=>{const e="last_storage_cleanup",t=localStorage.getItem(e),s=new Date;if(t){const e=new Date(t);if((s.getTime()-e.getTime())/36e5<24)return}const a=(()=>{const e=D(),t=new Date,s=new Date(t.getTime()-7776e6);let a=e.filter(e=>new Date(e.date)>=s);a.length>1e3&&(a=a.slice(0,1e3));const n=e.length-a.length;return n>0&&(localStorage.setItem(r,JSON.stringify(a)),console.log("Cleaned up ".concat(n," old history entries"))),{removed:n,remaining:a.length}})();localStorage.setItem(e,s.toISOString()),a.removed>0&&console.log("Storage cleanup: removed ".concat(a.removed," entries, ").concat(a.remaining," remaining"))};let h=!0,g=null,w=[];const f=e=>({id:e.id,name:e.name,status:e.status,currentOperator:e.current_operator,currentOrder:e.current_order,currentShift:e.current_shift,lastSubmission:e.last_submission,todayWaste:e.today_waste,todayDowntime:e.today_downtime,subMachineCount:e.sub_machine_count}),S=e=>({id:e.id,name:e.name,status:e.status,current_operator:e.currentOperator,current_order:e.currentOrder,current_shift:e.currentShift,last_submission:e.lastSubmission,today_waste:e.todayWaste,today_downtime:e.todayDowntime,sub_machine_count:e.subMachineCount}),y=async()=>{try{const e=await(0,o.Dn)();if(e.length>0)return g=e.map(f),localStorage.setItem(i,JSON.stringify(g)),localStorage.setItem("machines_last_sync",(new Date).toISOString()),g;{console.log("No machines in Supabase, syncing defaults...");const e=n.PY.map(S);return await(0,o.ri)(e),g=n.PY,localStorage.setItem(i,JSON.stringify(n.PY)),n.PY}}catch(e){return console.error("Failed to initialize from Supabase, using localStorage:",e),h=!1,_()}},b=e=>{w.push(e);const t=(0,o.RS)(e=>{g=e.map(f),localStorage.setItem(i,JSON.stringify(g)),w.forEach(e=>e(g))},()=>(g||_()).map(S));return()=>{w=w.filter(t=>t!==e),0===w.length&&t()}},_=()=>{const e=localStorage.getItem(i);if(!e)return localStorage.setItem(i,JSON.stringify(n.PY)),n.PY;try{return JSON.parse(e)}catch(t){return n.PY}},N=e=>{const t=D();t.unshift(e),localStorage.setItem(r,JSON.stringify(t)),E(e.machine,e.submittedAt.toISOString())},D=()=>{const e=localStorage.getItem(r);if(!e)return[];try{return JSON.parse(e).map(e=>(0,a.A)((0,a.A)({},e),{},{submittedAt:new Date(e.submittedAt),wasteEntries:e.wasteEntries.map(e=>(0,a.A)((0,a.A)({},e),{},{timestamp:new Date(e.timestamp)})),downtimeEntries:e.downtimeEntries.map(e=>(0,a.A)((0,a.A)({},e),{},{timestamp:new Date(e.timestamp)}))}))}catch(t){return[]}},v=()=>{const e=(new Date).toISOString().split("T")[0],t=D().filter(t=>t.date===e);return{totalWaste:t.reduce((e,t)=>e+t.totalWaste,0),totalDowntime:t.reduce((e,t)=>e+t.totalDowntime,0),submissionCount:t.length}},E=(e,t)=>{const s=O(),a=s.findIndex(t=>t.name===e);-1!==a&&(s[a].lastSubmission=J(new Date(t))),localStorage.setItem(i,JSON.stringify(s))},O=()=>g||_(),I=async(e,t)=>{const s=O(),n=s.findIndex(t=>t.id===e);if(-1!==n&&(s[n]=(0,a.A)((0,a.A)({},s[n]),t),g=s,localStorage.setItem(i,JSON.stringify(s)),h))try{await(0,o.hx)(S(s[n]))}catch(r){console.error("Failed to sync machine update to Supabase:",r)}},C=async e=>{const t=O();if(t.push(e),g=t,localStorage.setItem(i,JSON.stringify(t)),h)try{await(0,o.hx)(S(e))}catch(s){console.error("Failed to sync new machine to Supabase:",s)}},A=async e=>{const t=O().filter(t=>t.id!==e);if(g=t,localStorage.setItem(i,JSON.stringify(t)),h)try{await(0,o._T)(e)}catch(s){console.error("Failed to delete machine from Supabase:",s)}},J=e=>{const t=(new Date).getTime()-e.getTime(),s=Math.floor(t/6e4),a=Math.floor(s/60),n=Math.floor(a/24);return s<1?"Just now":s<60?"".concat(s," min ago"):a<24?"".concat(a," hour").concat(a>1?"s":""," ago"):"".concat(n," day").concat(n>1?"s":""," ago")},F=(e,t)=>{const s=[];e.forEach(e=>{const t=[e.date,e.shift,e.operatorName,e.machine,e.orderNumber,e.product,e.batchNumber],a=new Date(e.submittedAt).toLocaleString();e.wasteEntries&&e.wasteEntries.length>0&&e.wasteEntries.forEach(e=>{s.push([...t,"Waste",e.wasteType,e.waste.toFixed(2),"","",a])}),e.downtimeEntries&&e.downtimeEntries.length>0&&e.downtimeEntries.forEach(e=>{s.push([...t,"Downtime","","",e.downtimeReason,e.downtime.toString(),a])}),e.wasteEntries&&0!==e.wasteEntries.length||e.downtimeEntries&&0!==e.downtimeEntries.length||s.push([...t,"Summary","",e.totalWaste.toFixed(2),"",e.totalDowntime.toString(),a])});const a=[["Date","Shift","Operator","Machine","Order Number","Product","Batch Number","Entry Type","Waste Type","Waste (kg)","Downtime Reason","Downtime (min)","Submitted At"].join(","),...s.map(e=>e.map(e=>'"'.concat(e,'"')).join(","))].join("\n"),n=new Blob([a],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),r=URL.createObjectURL(n);o.setAttribute("href",r),o.setAttribute("download","".concat(t,".csv")),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)},M="line_speed_",R=e=>{const t=e.match(/^(.+?)\s*-\s*Machine\s*\d+$/i);return t?t[1].trim():e},T=(e,t,s)=>"".concat(M).concat(e,"_").concat(t,"_").concat(s),k=(e,t,s,a)=>{const n=R(e),o=T(n,t,s),r={speed:a,updatedAt:(new Date).toISOString(),updatedBy:e};localStorage.setItem(o,JSON.stringify(r)),console.log("\ud83d\udcbe Saved line speed ".concat(a," PPM for ").concat(n))},P=(e,t,s)=>{const a=R(e),n=T(a,t,s),o=localStorage.getItem(n);if(!o)return null;try{const e=JSON.parse(o);return console.log("\ud83d\udcd6 Loaded line speed ".concat(e.speed," PPM for ").concat(a," (set by ").concat(e.updatedBy,")")),e}catch(r){return null}}}}]);
//# sourceMappingURL=128.c23808cd.chunk.js.map