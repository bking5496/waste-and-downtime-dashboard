"use strict";(self.webpackChunkwaste_and_downtime_dashboard=self.webpackChunkwaste_and_downtime_dashboard||[]).push([[128],{6316:(e,t,a)=>{a.d(t,{KW:()=>c,WA:()=>i,b6:()=>m,fetchLiveSessionByMachine:()=>d,yw:()=>l});var n=a(1737);const o=(e,t,a)=>"".concat(e,"_").concat(t,"_").concat(a);let s=new Map,r=0;const i=async e=>{const t=o(e.machineName,e.shift,e.date),a={id:t,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()};if(s.set(t,a),n.$G)try{const{error:a}=await n.ND.from("live_sessions").upsert({id:t,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()},{onConflict:"id"});return a?(console.error("Failed to upsert live session:",a.message),!1):(console.log("\u2705 Live session synced to Supabase:",t),!0)}catch(r){return console.error("Failed to upsert live session:",r),!1}return!0},c=async(e,t,a)=>{const r=o(e,t,a);if(s.delete(r),n.$G)try{const{error:e}=await n.ND.from("live_sessions").delete().eq("id",r);return!e||(console.error("Failed to delete live session:",e.message),!1)}catch(i){return console.error("Failed to delete live session:",i),!1}return!0},l=async()=>{const e=Date.now(),t=(new Date).toISOString().split("T")[0],a=e-r<3e4;if(n.$G)try{const{data:a,error:o}=await n.ND.from("live_sessions").select("*").eq("session_date",t).eq("is_locked",!0);return o?(console.error("Failed to fetch live sessions:",o.message),Array.from(s.values()).filter(e=>e.session_date===t&&e.is_locked)):(s.clear(),(a||[]).forEach(e=>{s.set(e.id,e)}),r=e,console.log("\ud83d\udccb Fetched active sessions from Supabase:",(a||[]).length,null===a||void 0===a?void 0:a.map(e=>e.machine_name)),a||[])}catch(o){return console.error("Failed to fetch live sessions:",o),Array.from(s.values()).filter(e=>e.session_date===t&&e.is_locked)}return a?Array.from(s.values()).filter(e=>e.session_date===t&&e.is_locked):[]},d=async(e,t,a)=>{const r=o(e,t,a);if(s.has(r))return s.get(r)||null;if(!n.$G)return null;try{const{data:t,error:a}=await n.ND.from("live_sessions").select("*").eq("id",r).eq("is_locked",!0).maybeSingle();return a?(console.error("Failed to fetch session:",a.message),null):(t&&(s.set(r,t),console.log("\ud83d\udccb Restored session from Supabase:",e)),t)}catch(i){return console.error("Failed to fetch session by machine:",i),null}},m=e=>{if(!n.$G)return()=>{};(new Date).toISOString().split("T")[0];const t=n.ND.channel("live-sessions-changes").on("postgres_changes",{event:"*",schema:"public",table:"live_sessions"},async t=>{console.log("\ud83d\udd04 Real-time session update received:",t.eventType);const a=await l();e(a)}).subscribe(e=>{console.log("\ud83d\udce1 Session subscription status:",e)});return()=>{n.ND.removeChannel(t)}}},6451:(e,t,a)=>{a.d(t,{PY:()=>n,rE:()=>o,wK:()=>s});const n=[],o=["Start-up Waste","Changeover Waste","Defective Product","Material Spillage"],s=["Machine Breakdown","Scheduled Maintenance","Changeover","Material Shortage"]},8283:(e,t,a)=>{a.d(t,{Bh:()=>l,D$:()=>u,F$:()=>v,GF:()=>C,Hc:()=>_,IN:()=>D,LO:()=>N,Rg:()=>I,Rn:()=>J,Yn:()=>W,bR:()=>y,mg:()=>h,nN:()=>d,nt:()=>R,te:()=>E,zl:()=>A});var n=a(7051),o=a(6451),s=a(1737);const r="waste_downtime_history",i="machines_data",c="failed_submissions_queue",l=()=>{const e=localStorage.getItem(c);if(!e)return[];try{return JSON.parse(e)}catch(t){return[]}},d=(e,t)=>{const a=l(),n={id:"failed_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:(new Date).toISOString(),retryCount:0,maxRetries:3,data:e,error:t};a.push(n),localStorage.setItem(c,JSON.stringify(a))},m=e=>{const t=l().filter(t=>t.id!==e);localStorage.setItem(c,JSON.stringify(t))},u=async()=>{if(!s.$G)return{succeeded:0,failed:0,remaining:l().length};const e=l();let t=0,a=0;for(const r of e)if(r.retryCount>=r.maxRetries)a++;else try{await(0,s.jw)(r.data.shiftData,r.data.wasteEntries,r.data.downtimeEntries,r.data.speedEntries,r.data.sachetMassEntries,r.data.looseCasesEntries,r.data.palletScanEntries),m(r.id),t++}catch(o){const e=l().map(e=>e.id===r.id?(0,n.A)((0,n.A)({},e),{},{retryCount:e.retryCount+1,error:String(o)}):e);localStorage.setItem(c,JSON.stringify(e)),a++}return{succeeded:t,failed:a,remaining:l().length}},h=()=>{const e="last_storage_cleanup",t=localStorage.getItem(e),a=new Date;if(t){const e=new Date(t);if((a.getTime()-e.getTime())/36e5<24)return}const n=(()=>{const e=N(),t=new Date,a=new Date(t.getTime()-7776e6);let n=e.filter(e=>new Date(e.date)>=a);n.length>1e3&&(n=n.slice(0,1e3));const o=e.length-n.length;return o>0&&(localStorage.setItem(r,JSON.stringify(n)),console.log("Cleaned up ".concat(o," old history entries"))),{removed:o,remaining:n.length}})();localStorage.setItem(e,a.toISOString()),n.removed>0&&console.log("Storage cleanup: removed ".concat(n.removed," entries, ").concat(n.remaining," remaining"))};let g=!0,f=null,S=[];const p=e=>({id:e.id,name:e.name,status:e.status,currentOperator:e.current_operator,currentOrder:e.current_order,currentShift:e.current_shift,lastSubmission:e.last_submission,todayWaste:e.today_waste,todayDowntime:e.today_downtime,subMachineCount:e.sub_machine_count}),w=e=>({id:e.id,name:e.name,status:e.status,current_operator:e.currentOperator,current_order:e.currentOrder,current_shift:e.currentShift,last_submission:e.lastSubmission,today_waste:e.todayWaste,today_downtime:e.todayDowntime,sub_machine_count:e.subMachineCount}),y=async()=>{try{const e=await(0,s.Dn)();if(e.length>0)return f=e.map(p),localStorage.setItem(i,JSON.stringify(f)),localStorage.setItem("machines_last_sync",(new Date).toISOString()),f;{console.log("No machines in Supabase, syncing defaults...");const e=o.PY.map(w);return await(0,s.ri)(e),f=o.PY,localStorage.setItem(i,JSON.stringify(o.PY)),o.PY}}catch(e){return console.error("Failed to initialize from Supabase, using localStorage:",e),g=!1,b()}},_=e=>{S.push(e);const t=(0,s.RS)(e=>{f=e.map(p),localStorage.setItem(i,JSON.stringify(f)),S.forEach(e=>e(f))},()=>(f||b()).map(w));return()=>{S=S.filter(t=>t!==e),0===S.length&&t()}},b=()=>{const e=localStorage.getItem(i);if(!e)return localStorage.setItem(i,JSON.stringify(o.PY)),o.PY;try{return JSON.parse(e)}catch(t){return o.PY}},D=e=>{const t=N();t.unshift(e),localStorage.setItem(r,JSON.stringify(t)),O(e.machine,e.submittedAt.toISOString())},N=()=>{const e=localStorage.getItem(r);if(!e)return[];try{return JSON.parse(e).map(e=>(0,n.A)((0,n.A)({},e),{},{submittedAt:new Date(e.submittedAt),wasteEntries:e.wasteEntries.map(e=>(0,n.A)((0,n.A)({},e),{},{timestamp:new Date(e.timestamp)})),downtimeEntries:e.downtimeEntries.map(e=>(0,n.A)((0,n.A)({},e),{},{timestamp:new Date(e.timestamp)}))}))}catch(t){return[]}},v=()=>{const e=(new Date).toISOString().split("T")[0],t=N().filter(t=>t.date===e);return{totalWaste:t.reduce((e,t)=>e+t.totalWaste,0),totalDowntime:t.reduce((e,t)=>e+t.totalDowntime,0),submissionCount:t.length}},O=(e,t)=>{const a=I(),n=a.findIndex(t=>t.name===e);-1!==n&&(a[n].lastSubmission=k(new Date(t))),localStorage.setItem(i,JSON.stringify(a))},I=()=>f||b(),E=async(e,t)=>{const a=I(),o=a.findIndex(t=>t.id===e);if(-1!==o&&(a[o]=(0,n.A)((0,n.A)({},a[o]),t),f=a,localStorage.setItem(i,JSON.stringify(a)),g))try{await(0,s.hx)(w(a[o]))}catch(r){console.error("Failed to sync machine update to Supabase:",r)}},A=async e=>{const t=I();if(t.push(e),f=t,localStorage.setItem(i,JSON.stringify(t)),g)try{await(0,s.hx)(w(e))}catch(a){console.error("Failed to sync new machine to Supabase:",a)}},J=async e=>{const t=I().filter(t=>t.id!==e);if(f=t,localStorage.setItem(i,JSON.stringify(t)),g)try{await(0,s._T)(e)}catch(a){console.error("Failed to delete machine from Supabase:",a)}},k=e=>{const t=(new Date).getTime()-e.getTime(),a=Math.floor(t/6e4),n=Math.floor(a/60),o=Math.floor(n/24);return a<1?"Just now":a<60?"".concat(a," min ago"):n<24?"".concat(n," hour").concat(n>1?"s":""," ago"):"".concat(o," day").concat(o>1?"s":""," ago")},C=(e,t)=>{const a=[];e.forEach(e=>{const t=[e.date,e.shift,e.operatorName,e.machine,e.orderNumber,e.product,e.batchNumber],n=new Date(e.submittedAt).toLocaleString();e.wasteEntries&&e.wasteEntries.length>0&&e.wasteEntries.forEach(e=>{a.push([...t,"Waste",e.wasteType,e.waste.toFixed(2),"","",n])}),e.downtimeEntries&&e.downtimeEntries.length>0&&e.downtimeEntries.forEach(e=>{a.push([...t,"Downtime","","",e.downtimeReason,e.downtime.toString(),n])}),e.wasteEntries&&0!==e.wasteEntries.length||e.downtimeEntries&&0!==e.downtimeEntries.length||a.push([...t,"Summary","",e.totalWaste.toFixed(2),"",e.totalDowntime.toString(),n])});const n=[["Date","Shift","Operator","Machine","Order Number","Product","Batch Number","Entry Type","Waste Type","Waste (kg)","Downtime Reason","Downtime (min)","Submitted At"].join(","),...a.map(e=>e.map(e=>'"'.concat(e,'"')).join(","))].join("\n"),o=new Blob([n],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),r=URL.createObjectURL(o);s.setAttribute("href",r),s.setAttribute("download","".concat(t,".csv")),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)},F="line_speed_",M=e=>{const t=e.match(/^(.+?)\s*-\s*Machine\s*\d+$/i);return t?t[1].trim():e},P=(e,t,a)=>"".concat(F).concat(e,"_").concat(t,"_").concat(a),R=(e,t,a,n)=>{const o=M(e),s=P(o,t,a),r={speed:n,updatedAt:(new Date).toISOString(),updatedBy:e};localStorage.setItem(s,JSON.stringify(r)),console.log("\ud83d\udcbe Saved line speed ".concat(n," PPM for ").concat(o))},W=(e,t,a)=>{const n=M(e),o=P(n,t,a),s=localStorage.getItem(o);if(!s)return null;try{const e=JSON.parse(s);return console.log("\ud83d\udcd6 Loaded line speed ".concat(e.speed," PPM for ").concat(n," (set by ").concat(e.updatedBy,")")),e}catch(r){return null}}}}]);
//# sourceMappingURL=128.baf64a29.chunk.js.map