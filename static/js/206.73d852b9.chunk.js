"use strict";(self.webpackChunkwaste_and_downtime_dashboard=self.webpackChunkwaste_and_downtime_dashboard||[]).push([[206],{6451:(e,t,a)=>{a.d(t,{PY:()=>s,rE:()=>n,wK:()=>r});const s=[],n=["Start-up Waste","Changeover Waste","Defective Product","Material Spillage"],r=["Machine Breakdown","Scheduled Maintenance","Changeover","Material Shortage"]},7206:(e,t,a)=>{a.r(t),a.d(t,{default:()=>w});var s=a(5043),n=a(8163),r=a(6691),o=a(9908),i=a(1176),c=a(5829),l=a(9570),d=a(6446),m=a(8931),h=a(7111),u=a(8283),g=a(1737),p=a(579);const w=()=>{const e=(0,n.Zp)(),[t,a]=(0,s.useState)([]),[w,S]=(0,s.useState)([{id:"submittedAt",desc:!0}]),[y,b]=(0,s.useState)(""),[x,f]=(0,s.useState)("all"),[v,N]=(0,s.useState)("database"),[j,D]=(0,s.useState)(!1),_=(0,s.useCallback)(e=>({id:e.id.toString(),operatorName:e.operator_name,machine:e.machine,orderNumber:e.order_number,product:e.product,batchNumber:e.batch_number,shift:e.shift,date:e.submission_date,wasteEntries:(e.waste_records||[]).map(e=>({id:e.id.toString(),waste:e.waste_amount,wasteType:e.waste_type,timestamp:new Date(e.recorded_at||e.created_at||Date.now())})),downtimeEntries:(e.downtime_records||[]).map(e=>({id:e.id.toString(),downtime:e.downtime_minutes,downtimeReason:e.downtime_reason,timestamp:new Date(e.recorded_at||e.created_at||Date.now())})),totalWaste:e.total_waste||0,totalDowntime:e.total_downtime||0,submittedAt:new Date(e.created_at)}),[]),C=(0,s.useCallback)(async()=>{D(!0);try{let e=[];if("database"===v){e=(await(0,g.h6)(100)).map(_)}else e=(0,u.LO)();const t=new Date;switch(x){case"today":const a=(0,i.o)(t),s=(0,r.D)(t);e=e.filter(e=>{const t=new Date(e.submittedAt);return t>=a&&t<=s});break;case"week":const n=(0,c.e)(t,7);e=e.filter(e=>new Date(e.submittedAt)>=n);break;case"month":const o=(0,c.e)(t,30);e=e.filter(e=>new Date(e.submittedAt)>=o)}a(e)}catch(e){console.error("Error loading data:",e),"database"===v&&N("local")}finally{D(!1)}},[v,x,_]);(0,s.useEffect)(()=>{C()},[C]);const M=(0,s.useMemo)(()=>[{accessorKey:"date",header:"Date",cell:e=>(0,o.GP)(new Date(e.getValue()),"MMM dd, yyyy")},{accessorKey:"shift",header:"Shift",cell:e=>(0,p.jsx)("span",{className:"shift-tag ".concat(e.getValue().toLowerCase()),children:e.getValue()})},{accessorKey:"operatorName",header:"Operator"},{accessorKey:"machine",header:"Machine"},{accessorKey:"orderNumber",header:"Order"},{accessorKey:"totalWaste",header:"Waste (kg)",cell:e=>(0,p.jsx)("span",{className:"waste-value",children:e.getValue().toFixed(1)})},{accessorKey:"totalDowntime",header:"Downtime",cell:e=>{const t=e.getValue(),a=Math.floor(t/60),s=t%60;return(0,p.jsxs)("span",{className:"downtime-value",children:[a>0?"".concat(a,"h "):"",s,"m"]})}},{accessorKey:"submittedAt",header:"Submitted",cell:e=>(0,o.GP)(new Date(e.getValue()),"HH:mm")}],[]),k=(0,m.N4)({data:t,columns:M,state:{sorting:w,globalFilter:y},onSortingChange:S,onGlobalFilterChange:b,getCoreRowModel:(0,h.HT)(),getSortedRowModel:(0,h.h5)(),getFilteredRowModel:(0,h.hM)(),getPaginationRowModel:(0,h.kW)(),initialState:{pagination:{pageSize:10}}}),O=(0,s.useMemo)(()=>{const e=t.reduce((e,t)=>e+t.totalWaste,0),a=t.reduce((e,t)=>e+t.totalDowntime,0);return{totalWaste:e,totalDowntime:a,avgWaste:t.length>0?e/t.length:0,avgDowntime:t.length>0?a/t.length:0,count:t.length}},[t]);return(0,p.jsxs)(d.P.div,{className:"history-page-v2",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[(0,p.jsxs)("header",{className:"history-header-v2",children:[(0,p.jsxs)("div",{className:"header-left-v2",children:[(0,p.jsxs)("button",{className:"back-btn-v2",onClick:()=>e("/"),children:[(0,p.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,p.jsx)("path",{d:"M19 12H5M12 19l-7-7 7-7"})}),"Back"]}),(0,p.jsxs)("div",{className:"header-titles",children:[(0,p.jsx)("h1",{children:"Submission History"}),(0,p.jsx)("span",{className:"header-subtitle",children:j?"Loading...":"".concat(t.length," records from ").concat("database"===v?"Supabase":"Local Storage")})]})]}),(0,p.jsx)("div",{className:"header-actions-v2",children:(0,p.jsxs)("button",{className:"export-btn-v2",onClick:()=>{const e="shift_history_".concat((0,o.GP)(new Date,"yyyy-MM-dd"));(0,u.GF)(t,e)},disabled:0===t.length,children:[(0,p.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,p.jsx)("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"})}),"Export CSV"]})})]}),(0,p.jsxs)("main",{className:"history-main",children:[(0,p.jsxs)("div",{className:"history-filters-v2",children:[(0,p.jsxs)("div",{className:"filter-group-v2",children:[(0,p.jsx)("label",{children:"Data Source"}),(0,p.jsxs)("div",{className:"filter-pills",children:[(0,p.jsx)("button",{className:"filter-pill ".concat("database"===v?"active":""),onClick:()=>N("database"),children:"\u2601\ufe0f Database"}),(0,p.jsx)("button",{className:"filter-pill ".concat("local"===v?"active":""),onClick:()=>N("local"),children:"\ud83d\udcbe Local"})]})]}),(0,p.jsxs)("div",{className:"filter-group-v2",children:[(0,p.jsx)("label",{children:"Time Period"}),(0,p.jsx)("div",{className:"filter-pills",children:["today","week","month","all"].map(e=>(0,p.jsx)("button",{className:"filter-pill ".concat(x===e?"active":""),onClick:()=>f(e),children:"today"===e?"Today":"week"===e?"7 Days":"month"===e?"30 Days":"All Time"},e))})]}),(0,p.jsxs)("div",{className:"filter-group-v2 search-group",children:[(0,p.jsx)("label",{children:"Search"}),(0,p.jsxs)("div",{className:"search-input-wrapper",children:[(0,p.jsxs)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,p.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,p.jsx)("path",{d:"M21 21l-4.35-4.35"})]}),(0,p.jsx)("input",{type:"text",className:"search-input-v2",placeholder:"Search operator, machine, order...",value:y,onChange:e=>b(e.target.value)})]})]})]}),(0,p.jsxs)("div",{className:"history-stats-v2",children:[(0,p.jsxs)("div",{className:"stat-card-v2",children:[(0,p.jsx)("span",{className:"stat-value-v2",children:O.count}),(0,p.jsx)("span",{className:"stat-label-v2",children:"Submissions"})]}),(0,p.jsxs)("div",{className:"stat-card-v2 waste",children:[(0,p.jsxs)("span",{className:"stat-value-v2",children:[O.totalWaste.toFixed(1),(0,p.jsx)("small",{children:"kg"})]}),(0,p.jsx)("span",{className:"stat-label-v2",children:"Total Waste"})]}),(0,p.jsxs)("div",{className:"stat-card-v2 downtime",children:[(0,p.jsxs)("span",{className:"stat-value-v2",children:[Math.floor(O.totalDowntime/60),"h ",O.totalDowntime%60,"m"]}),(0,p.jsx)("span",{className:"stat-label-v2",children:"Total Downtime"})]}),(0,p.jsxs)("div",{className:"stat-card-v2",children:[(0,p.jsxs)("span",{className:"stat-value-v2",children:[O.avgWaste.toFixed(1),(0,p.jsx)("small",{children:"kg"})]}),(0,p.jsx)("span",{className:"stat-label-v2",children:"Avg per Shift"})]})]}),(0,p.jsx)("div",{className:"history-table-container-v2",children:0===t.length?(0,p.jsxs)("div",{className:"empty-state-v2",children:[(0,p.jsx)("div",{className:"empty-icon",children:(0,p.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:(0,p.jsx)("path",{d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})})}),(0,p.jsx)("h3",{children:"No submissions found"}),(0,p.jsx)("p",{children:"There are no shift submissions for the selected time period."})]}):(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("div",{className:"table-wrapper",children:(0,p.jsxs)("table",{className:"history-table-v2",children:[(0,p.jsx)("thead",{children:k.getHeaderGroups().map(e=>(0,p.jsx)("tr",{children:e.headers.map(e=>(0,p.jsx)("th",{onClick:e.column.getToggleSortingHandler(),className:e.column.getCanSort()?"sortable":"",children:(0,p.jsxs)("div",{className:"th-content",children:[(0,m.Kv)(e.column.columnDef.header,e.getContext()),e.column.getIsSorted()&&(0,p.jsx)("span",{className:"sort-indicator",children:"asc"===e.column.getIsSorted()?"\u2191":"\u2193"})]})},e.id))},e.id))}),(0,p.jsx)("tbody",{children:(0,p.jsx)(l.N,{children:k.getRowModel().rows.map(e=>(0,p.jsx)(d.P.tr,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:e.getVisibleCells().map(e=>(0,p.jsx)("td",{children:(0,m.Kv)(e.column.columnDef.cell,e.getContext())},e.id))},e.id))})})]})}),(0,p.jsxs)("div",{className:"table-pagination-v2",children:[(0,p.jsxs)("div",{className:"pagination-info-v2",children:["Showing ",k.getState().pagination.pageIndex*k.getState().pagination.pageSize+1," to"," ",Math.min((k.getState().pagination.pageIndex+1)*k.getState().pagination.pageSize,t.length)," ","of ",t.length," entries"]}),(0,p.jsxs)("div",{className:"pagination-controls-v2",children:[(0,p.jsx)("button",{className:"page-btn",onClick:()=>k.previousPage(),disabled:!k.getCanPreviousPage(),children:"\u2190 Previous"}),(0,p.jsxs)("span",{className:"page-indicator-v2",children:[k.getState().pagination.pageIndex+1," / ",k.getPageCount()]}),(0,p.jsx)("button",{className:"page-btn",onClick:()=>k.nextPage(),disabled:!k.getCanNextPage(),children:"Next \u2192"})]})]})]})})]})]})}},8283:(e,t,a)=>{a.d(t,{Bh:()=>l,D$:()=>h,F$:()=>j,GF:()=>I,Hc:()=>x,IN:()=>v,LO:()=>N,Rg:()=>_,Rn:()=>k,Yn:()=>J,bR:()=>b,mg:()=>u,nN:()=>d,nt:()=>W,te:()=>C,zl:()=>M});var s=a(7051),n=a(6451),r=a(1737);const o="waste_downtime_history",i="machines_data",c="failed_submissions_queue",l=()=>{const e=localStorage.getItem(c);if(!e)return[];try{return JSON.parse(e)}catch(t){return[]}},d=(e,t)=>{const a=l(),s={id:"failed_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:(new Date).toISOString(),retryCount:0,maxRetries:3,data:e,error:t};a.push(s),localStorage.setItem(c,JSON.stringify(a))},m=e=>{const t=l().filter(t=>t.id!==e);localStorage.setItem(c,JSON.stringify(t))},h=async()=>{if(!r.$G)return{succeeded:0,failed:0,remaining:l().length};const e=l();let t=0,a=0;for(const o of e)if(o.retryCount>=o.maxRetries)a++;else try{await(0,r.jw)(o.data.shiftData,o.data.wasteEntries,o.data.downtimeEntries,o.data.speedEntries,o.data.sachetMassEntries,o.data.looseCasesEntries,o.data.palletScanEntries),m(o.id),t++}catch(n){const e=l().map(e=>e.id===o.id?(0,s.A)((0,s.A)({},e),{},{retryCount:e.retryCount+1,error:String(n)}):e);localStorage.setItem(c,JSON.stringify(e)),a++}return{succeeded:t,failed:a,remaining:l().length}},u=()=>{const e="last_storage_cleanup",t=localStorage.getItem(e),a=new Date;if(t){const e=new Date(t);if((a.getTime()-e.getTime())/36e5<24)return}const s=(()=>{const e=N(),t=new Date,a=new Date(t.getTime()-7776e6);let s=e.filter(e=>new Date(e.date)>=a);s.length>1e3&&(s=s.slice(0,1e3));const n=e.length-s.length;return n>0&&(localStorage.setItem(o,JSON.stringify(s)),console.log("Cleaned up ".concat(n," old history entries"))),{removed:n,remaining:s.length}})();localStorage.setItem(e,a.toISOString()),s.removed>0&&console.log("Storage cleanup: removed ".concat(s.removed," entries, ").concat(s.remaining," remaining"))};let g=!0,p=null,w=[];const S=e=>({id:e.id,name:e.name,status:e.status,currentOperator:e.current_operator,currentOrder:e.current_order,currentShift:e.current_shift,lastSubmission:e.last_submission,todayWaste:e.today_waste,todayDowntime:e.today_downtime,subMachineCount:e.sub_machine_count}),y=e=>({id:e.id,name:e.name,status:e.status,current_operator:e.currentOperator,current_order:e.currentOrder,current_shift:e.currentShift,last_submission:e.lastSubmission,today_waste:e.todayWaste,today_downtime:e.todayDowntime,sub_machine_count:e.subMachineCount}),b=async()=>{try{const e=await(0,r.Dn)();if(e.length>0)return p=e.map(S),localStorage.setItem(i,JSON.stringify(p)),localStorage.setItem("machines_last_sync",(new Date).toISOString()),p;{console.log("No machines in Supabase, syncing defaults...");const e=n.PY.map(y);return await(0,r.ri)(e),p=n.PY,localStorage.setItem(i,JSON.stringify(n.PY)),n.PY}}catch(e){return console.error("Failed to initialize from Supabase, using localStorage:",e),g=!1,f()}},x=e=>{w.push(e);const t=(0,r.RS)(e=>{p=e.map(S),localStorage.setItem(i,JSON.stringify(p)),w.forEach(e=>e(p))},()=>(p||f()).map(y));return()=>{w=w.filter(t=>t!==e),0===w.length&&t()}},f=()=>{const e=localStorage.getItem(i);if(!e)return localStorage.setItem(i,JSON.stringify(n.PY)),n.PY;try{return JSON.parse(e)}catch(t){return n.PY}},v=e=>{const t=N();t.unshift(e),localStorage.setItem(o,JSON.stringify(t)),D(e.machine,e.submittedAt.toISOString())},N=()=>{const e=localStorage.getItem(o);if(!e)return[];try{return JSON.parse(e).map(e=>(0,s.A)((0,s.A)({},e),{},{submittedAt:new Date(e.submittedAt),wasteEntries:e.wasteEntries.map(e=>(0,s.A)((0,s.A)({},e),{},{timestamp:new Date(e.timestamp)})),downtimeEntries:e.downtimeEntries.map(e=>(0,s.A)((0,s.A)({},e),{},{timestamp:new Date(e.timestamp)}))}))}catch(t){return[]}},j=()=>{const e=(new Date).toISOString().split("T")[0],t=N().filter(t=>t.date===e);return{totalWaste:t.reduce((e,t)=>e+t.totalWaste,0),totalDowntime:t.reduce((e,t)=>e+t.totalDowntime,0),submissionCount:t.length}},D=(e,t)=>{const a=_(),s=a.findIndex(t=>t.name===e);-1!==s&&(a[s].lastSubmission=O(new Date(t))),localStorage.setItem(i,JSON.stringify(a))},_=()=>p||f(),C=async(e,t)=>{const a=_(),n=a.findIndex(t=>t.id===e);if(-1!==n&&(a[n]=(0,s.A)((0,s.A)({},a[n]),t),p=a,localStorage.setItem(i,JSON.stringify(a)),g))try{await(0,r.hx)(y(a[n]))}catch(o){console.error("Failed to sync machine update to Supabase:",o)}},M=async e=>{const t=_();if(t.push(e),p=t,localStorage.setItem(i,JSON.stringify(t)),g)try{await(0,r.hx)(y(e))}catch(a){console.error("Failed to sync new machine to Supabase:",a)}},k=async e=>{const t=_().filter(t=>t.id!==e);if(p=t,localStorage.setItem(i,JSON.stringify(t)),g)try{await(0,r._T)(e)}catch(a){console.error("Failed to delete machine from Supabase:",a)}},O=e=>{const t=(new Date).getTime()-e.getTime(),a=Math.floor(t/6e4),s=Math.floor(a/60),n=Math.floor(s/24);return a<1?"Just now":a<60?"".concat(a," min ago"):s<24?"".concat(s," hour").concat(s>1?"s":""," ago"):"".concat(n," day").concat(n>1?"s":""," ago")},I=(e,t)=>{const a=[];e.forEach(e=>{const t=[e.date,e.shift,e.operatorName,e.machine,e.orderNumber,e.product,e.batchNumber],s=new Date(e.submittedAt).toLocaleString();e.wasteEntries&&e.wasteEntries.length>0&&e.wasteEntries.forEach(e=>{a.push([...t,"Waste",e.wasteType,e.waste.toFixed(2),"","",s])}),e.downtimeEntries&&e.downtimeEntries.length>0&&e.downtimeEntries.forEach(e=>{a.push([...t,"Downtime","","",e.downtimeReason,e.downtime.toString(),s])}),e.wasteEntries&&0!==e.wasteEntries.length||e.downtimeEntries&&0!==e.downtimeEntries.length||a.push([...t,"Summary","",e.totalWaste.toFixed(2),"",e.totalDowntime.toString(),s])});const s=[["Date","Shift","Operator","Machine","Order Number","Product","Batch Number","Entry Type","Waste Type","Waste (kg)","Downtime Reason","Downtime (min)","Submitted At"].join(","),...a.map(e=>e.map(e=>'"'.concat(e,'"')).join(","))].join("\n"),n=new Blob([s],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),o=URL.createObjectURL(n);r.setAttribute("href",o),r.setAttribute("download","".concat(t,".csv")),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)},E="line_speed_",P=e=>{const t=e.match(/^(.+?)\s*-\s*Machine\s*\d+$/i);return t?t[1].trim():e},A=(e,t,a)=>"".concat(E).concat(e,"_").concat(t,"_").concat(a),W=(e,t,a,s)=>{const n=P(e),r=A(n,t,a),o={speed:s,updatedAt:(new Date).toISOString(),updatedBy:e};localStorage.setItem(r,JSON.stringify(o)),console.log("\ud83d\udcbe Saved line speed ".concat(s," PPM for ").concat(n))},J=(e,t,a)=>{const s=P(e),n=A(s,t,a),r=localStorage.getItem(n);if(!r)return null;try{const e=JSON.parse(r);return console.log("\ud83d\udcd6 Loaded line speed ".concat(e.speed," PPM for ").concat(s," (set by ").concat(e.updatedBy,")")),e}catch(o){return null}}}}]);
//# sourceMappingURL=206.73d852b9.chunk.js.map