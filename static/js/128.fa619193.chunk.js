"use strict";(self.webpackChunkwaste_and_downtime_dashboard=self.webpackChunkwaste_and_downtime_dashboard||[]).push([[128],{6316:(e,t,a)=>{a.d(t,{$C:()=>g,CJ:()=>b,Cf:()=>N,Fd:()=>f,KW:()=>l,PX:()=>w,RU:()=>y,WA:()=>c,ZX:()=>S,b6:()=>u,fetchLiveSessionByMachine:()=>d,ii:()=>v,rC:()=>D,yw:()=>m});var s=a(7051),n=a(1737);const r=(e,t,a)=>"".concat(e,"_").concat(t,"_").concat(a);let o=new Map,i=0;const c=async e=>{const t=r(e.machineName,e.shift,e.date),a={id:t,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()};if(o.set(t,a),n.$G)try{const{error:a}=await n.ND.from("live_sessions").upsert({id:t,machine_name:e.machineName,operator_name:e.operatorName,order_number:e.orderNumber,product:e.product,batch_number:e.batchNumber,shift:e.shift,session_date:e.date,is_locked:e.locked,total_waste:e.totalWaste||0,total_downtime:e.totalDowntime||0,updated_at:(new Date).toISOString()},{onConflict:"id"});return a?(console.error("Failed to upsert live session:",a.message),!1):(console.log("\u2705 Live session synced to Supabase:",t),!0)}catch(s){return console.error("Failed to upsert live session:",s),!1}return!0},l=async(e,t,a)=>{const s=r(e,t,a);if(o.delete(s),n.$G)try{const{error:e}=await n.ND.from("live_sessions").delete().eq("id",s);return!e||(console.error("Failed to delete live session:",e.message),!1)}catch(i){return console.error("Failed to delete live session:",i),!1}return!0},m=async()=>{const e=Date.now(),t=(new Date).toISOString().split("T")[0],a=e-i<3e4;if(n.$G)try{const{data:a,error:s}=await n.ND.from("live_sessions").select("*").eq("session_date",t).eq("is_locked",!0);return s?(console.error("Failed to fetch live sessions:",s.message),Array.from(o.values()).filter(e=>e.session_date===t&&e.is_locked)):(o.clear(),(a||[]).forEach(e=>{o.set(e.id,e)}),i=e,console.log("\ud83d\udccb Fetched active sessions from Supabase:",(a||[]).length,null===a||void 0===a?void 0:a.map(e=>e.machine_name)),a||[])}catch(s){return console.error("Failed to fetch live sessions:",s),Array.from(o.values()).filter(e=>e.session_date===t&&e.is_locked)}return a?Array.from(o.values()).filter(e=>e.session_date===t&&e.is_locked):[]},d=async(e,t,a)=>{const s=r(e,t,a);if(o.has(s))return o.get(s)||null;if(!n.$G)return null;try{const{data:t,error:a}=await n.ND.from("live_sessions").select("*").eq("id",s).eq("is_locked",!0).maybeSingle();return a?(console.error("Failed to fetch session:",a.message),null):(t&&(o.set(s,t),console.log("\ud83d\udccb Restored session from Supabase:",e)),t)}catch(i){return console.error("Failed to fetch session by machine:",i),null}},u=e=>{if(!n.$G)return()=>{};(new Date).toISOString().split("T")[0];const t=n.ND.channel("live-sessions-changes").on("postgres_changes",{event:"*",schema:"public",table:"live_sessions"},async t=>{console.log("\ud83d\udd04 Real-time session update received:",t.eventType);const a=await m();e(a)}).subscribe(e=>{console.log("\ud83d\udce1 Session subscription status:",e)});return()=>{n.ND.removeChannel(t)}};let p=[];let h=[];const g=e=>{h.push(e),e([...p]);let t=null;return n.$G&&(t=n.ND.channel("activity-broadcast").on("broadcast",{event:"activity"},e=>{const t=e.payload,a=(0,s.A)((0,s.A)({},t),{},{timestamp:new Date(t.timestamp)});p.some(e=>e.id===a.id)||(p=[a,...p].slice(0,50),h.forEach(e=>e([...p])))}).subscribe()),()=>{h=h.filter(t=>t!==e),t&&n.ND.removeChannel(t)}},w=async(e,t,a,s)=>{if(!n.$G)return!1;const o=r(e,t,a),i=JSON.stringify(s);try{const{error:e}=await n.ND.from("live_sessions").update({entries_json:i,updated_at:(new Date).toISOString()}).eq("id",o);return e?(e.message.includes("entries_json")||e.message.includes("column")||console.error("Failed to sync entries:",e.message),!1):(console.log("\ud83d\udce6 Entries synced to Supabase:",o),!0)}catch(c){return!1}},f=async(e,t,a)=>{if(!n.$G)return null;const s=r(e,t,a);try{const{data:e,error:t}=await n.ND.from("live_sessions").select("entries_json").eq("id",s).maybeSingle();if(t)return t.message.includes("entries_json")||t.message.includes("column")||console.error("Failed to fetch entries:",t.message),null;if(null!==e&&void 0!==e&&e.entries_json){const t=JSON.parse(e.entries_json);return console.log("\ud83d\udce6 Entries restored from Supabase:",s),t}return null}catch(o){return null}},S=(e,t,a,s)=>{if(!n.$G)return()=>{};const o=r(e,t,a),i=n.ND.channel("entries-".concat(o)).on("postgres_changes",{event:"UPDATE",schema:"public",table:"live_sessions",filter:"id=eq.".concat(o)},e=>{const t=e.new;if(t.entries_json)try{const e=JSON.parse(t.entries_json);console.log("\ud83d\udd04 Real-time entries update received:",o),s(e)}catch(a){console.error("Failed to parse entries update:",a)}}).subscribe(e=>{console.log("\ud83d\udce1 Entry sync subscription status:",e,o)});return()=>{n.ND.removeChannel(i)}},_=e=>"string"===typeof e?e:e instanceof Date?e.toISOString():new Date(e).toISOString(),y=(e,t,a,s,n,r)=>({wasteEntries:e.map(e=>({id:e.id,waste:e.waste,wasteType:e.wasteType,timestamp:_(e.timestamp)})),downtimeEntries:t.map(e=>({id:e.id,downtime:e.downtime,downtimeReason:e.downtimeReason,timestamp:_(e.timestamp)})),speedEntries:a.map(e=>({id:e.id,speed:e.speed,timestamp:_(e.timestamp)})),sachetMassEntries:s.map(e=>({id:e.id,mass:e.mass,timestamp:_(e.timestamp)})),looseCasesEntries:n.map(e=>({id:e.id,batchNumber:e.batchNumber,cases:e.cases,timestamp:_(e.timestamp)})),palletScanEntries:r.map(e=>({id:e.id,qrCode:e.qrCode,batchNumber:e.batchNumber,palletNumber:e.palletNumber,casesCount:e.casesCount,timestamp:_(e.timestamp),ignored:e.ignored}))}),b=e=>({wasteEntries:e.wasteEntries.map(e=>({id:e.id,waste:e.waste,wasteType:e.wasteType,timestamp:new Date(e.timestamp)})),downtimeEntries:e.downtimeEntries.map(e=>({id:e.id,downtime:e.downtime,downtimeReason:e.downtimeReason,timestamp:new Date(e.timestamp)})),speedEntries:e.speedEntries.map(e=>({id:e.id,speed:e.speed,timestamp:new Date(e.timestamp)})),sachetMassEntries:e.sachetMassEntries.map(e=>({id:e.id,mass:e.mass,timestamp:new Date(e.timestamp)})),looseCasesEntries:e.looseCasesEntries.map(e=>({id:e.id,batchNumber:e.batchNumber,cases:e.cases,timestamp:new Date(e.timestamp)})),palletScanEntries:e.palletScanEntries.map(e=>({id:e.id,qrCode:e.qrCode,batchNumber:e.batchNumber,palletNumber:e.palletNumber,casesCount:e.casesCount,timestamp:new Date(e.timestamp),ignored:e.ignored}))}),N=async(e,t,a,s)=>{const r="current_machine_order_".concat(e),o={machine_name:e,order_number:t,product:a,batch_number:s,updated_at:(new Date).toISOString()};if(localStorage.setItem(r,JSON.stringify(o)),n.$G)try{const{error:r}=await n.ND.from("current_machine_orders").upsert({machine_name:e,order_number:t,product:a,batch_number:s,updated_at:(new Date).toISOString()},{onConflict:"machine_name"});if(r)return console.log("Current order saved to localStorage (Supabase table may not exist)"),!0;console.log("\u2705 Current machine order synced to Supabase:",e)}catch(i){}return!0},D=async e=>{if(n.$G)try{const{data:t,error:a}=await n.ND.from("current_machine_orders").select("*").eq("machine_name",e).maybeSingle();if(!a&&t)return console.log("\ud83d\udccb Current machine order loaded from Supabase:",e),t}catch(s){}const t="current_machine_order_".concat(e),a=localStorage.getItem(t);if(a)try{const t=JSON.parse(a);return console.log("\ud83d\udccb Current machine order loaded from localStorage:",e),t}catch(s){}return null},v=async e=>{const t="current_machine_order_".concat(e);if(localStorage.removeItem(t),n.$G)try{await n.ND.from("current_machine_orders").delete().eq("machine_name",e)}catch(a){}}},6451:(e,t,a)=>{a.d(t,{PY:()=>s,rE:()=>n,wK:()=>r});const s=[],n=["Start-up Waste","Changeover Waste","Defective Product","Material Spillage"],r=["Machine Breakdown","Scheduled Maintenance","Changeover","Material Shortage"]},8283:(e,t,a)=>{a.d(t,{Bh:()=>l,D$:()=>u,F$:()=>v,GF:()=>F,Hc:()=>y,IN:()=>N,LO:()=>D,Rg:()=>O,Rn:()=>A,Yn:()=>$,bR:()=>_,mg:()=>p,nN:()=>m,nt:()=>k,te:()=>I,zl:()=>C});var s=a(7051),n=a(6451),r=a(1737);const o="waste_downtime_history",i="machines_data",c="failed_submissions_queue",l=()=>{const e=localStorage.getItem(c);if(!e)return[];try{return JSON.parse(e)}catch(t){return[]}},m=(e,t)=>{const a=l(),s={id:"failed_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:(new Date).toISOString(),retryCount:0,maxRetries:3,data:e,error:t};a.push(s),localStorage.setItem(c,JSON.stringify(a))},d=e=>{const t=l().filter(t=>t.id!==e);localStorage.setItem(c,JSON.stringify(t))},u=async()=>{if(!r.$G)return{succeeded:0,failed:0,remaining:l().length};const e=l();let t=0,a=0;for(const o of e)if(o.retryCount>=o.maxRetries)a++;else try{await(0,r.jw)(o.data.shiftData,o.data.wasteEntries,o.data.downtimeEntries,o.data.speedEntries,o.data.sachetMassEntries,o.data.looseCasesEntries,o.data.palletScanEntries),d(o.id),t++}catch(n){const e=l().map(e=>e.id===o.id?(0,s.A)((0,s.A)({},e),{},{retryCount:e.retryCount+1,error:String(n)}):e);localStorage.setItem(c,JSON.stringify(e)),a++}return{succeeded:t,failed:a,remaining:l().length}},p=()=>{const e="last_storage_cleanup",t=localStorage.getItem(e),a=new Date;if(t){const e=new Date(t);if((a.getTime()-e.getTime())/36e5<24)return}const s=(()=>{const e=D(),t=new Date,a=new Date(t.getTime()-7776e6);let s=e.filter(e=>new Date(e.date)>=a);s.length>1e3&&(s=s.slice(0,1e3));const n=e.length-s.length;return n>0&&(localStorage.setItem(o,JSON.stringify(s)),console.log("Cleaned up ".concat(n," old history entries"))),{removed:n,remaining:s.length}})();localStorage.setItem(e,a.toISOString()),s.removed>0&&console.log("Storage cleanup: removed ".concat(s.removed," entries, ").concat(s.remaining," remaining"))};let h=!0,g=null,w=[];const f=e=>({id:e.id,name:e.name,status:e.status,currentOperator:e.current_operator,currentOrder:e.current_order,currentShift:e.current_shift,lastSubmission:e.last_submission,todayWaste:e.today_waste,todayDowntime:e.today_downtime,subMachineCount:e.sub_machine_count}),S=e=>({id:e.id,name:e.name,status:e.status,current_operator:e.currentOperator,current_order:e.currentOrder,current_shift:e.currentShift,last_submission:e.lastSubmission,today_waste:e.todayWaste,today_downtime:e.todayDowntime,sub_machine_count:e.subMachineCount}),_=async()=>{try{const e=await(0,r.Dn)();if(e.length>0)return g=e.map(f),localStorage.setItem(i,JSON.stringify(g)),localStorage.setItem("machines_last_sync",(new Date).toISOString()),g;{console.log("No machines in Supabase, syncing defaults...");const e=n.PY.map(S);return await(0,r.ri)(e),g=n.PY,localStorage.setItem(i,JSON.stringify(n.PY)),n.PY}}catch(e){return console.error("Failed to initialize from Supabase, using localStorage:",e),h=!1,b()}},y=e=>{w.push(e);const t=(0,r.RS)(e=>{g=e.map(f),localStorage.setItem(i,JSON.stringify(g)),w.forEach(e=>e(g))},()=>(g||b()).map(S));return()=>{w=w.filter(t=>t!==e),0===w.length&&t()}},b=()=>{const e=localStorage.getItem(i);if(!e)return localStorage.setItem(i,JSON.stringify(n.PY)),n.PY;try{return JSON.parse(e)}catch(t){return n.PY}},N=e=>{const t=D();t.unshift(e),localStorage.setItem(o,JSON.stringify(t)),E(e.machine,e.submittedAt.toISOString())},D=()=>{const e=localStorage.getItem(o);if(!e)return[];try{return JSON.parse(e).map(e=>(0,s.A)((0,s.A)({},e),{},{submittedAt:new Date(e.submittedAt),wasteEntries:e.wasteEntries.map(e=>(0,s.A)((0,s.A)({},e),{},{timestamp:new Date(e.timestamp)})),downtimeEntries:e.downtimeEntries.map(e=>(0,s.A)((0,s.A)({},e),{},{timestamp:new Date(e.timestamp)}))}))}catch(t){return[]}},v=()=>{const e=(new Date).toISOString().split("T")[0],t=D().filter(t=>t.date===e);return{totalWaste:t.reduce((e,t)=>e+t.totalWaste,0),totalDowntime:t.reduce((e,t)=>e+t.totalDowntime,0),submissionCount:t.length}},E=(e,t)=>{const a=O(),s=a.findIndex(t=>t.name===e);-1!==s&&(a[s].lastSubmission=J(new Date(t))),localStorage.setItem(i,JSON.stringify(a))},O=()=>g||b(),I=async(e,t)=>{const a=O(),n=a.findIndex(t=>t.id===e);if(-1!==n&&(a[n]=(0,s.A)((0,s.A)({},a[n]),t),g=a,localStorage.setItem(i,JSON.stringify(a)),h))try{await(0,r.hx)(S(a[n]))}catch(o){console.error("Failed to sync machine update to Supabase:",o)}},C=async e=>{const t=O();if(t.push(e),g=t,localStorage.setItem(i,JSON.stringify(t)),h)try{await(0,r.hx)(S(e))}catch(a){console.error("Failed to sync new machine to Supabase:",a)}},A=async e=>{const t=O().filter(t=>t.id!==e);if(g=t,localStorage.setItem(i,JSON.stringify(t)),h)try{await(0,r._T)(e)}catch(a){console.error("Failed to delete machine from Supabase:",a)}},J=e=>{const t=(new Date).getTime()-e.getTime(),a=Math.floor(t/6e4),s=Math.floor(a/60),n=Math.floor(s/24);return a<1?"Just now":a<60?"".concat(a," min ago"):s<24?"".concat(s," hour").concat(s>1?"s":""," ago"):"".concat(n," day").concat(n>1?"s":""," ago")},F=(e,t)=>{const a=[];e.forEach(e=>{const t=[e.date,e.shift,e.operatorName,e.machine,e.orderNumber,e.product,e.batchNumber],s=new Date(e.submittedAt).toLocaleString();e.wasteEntries&&e.wasteEntries.length>0&&e.wasteEntries.forEach(e=>{a.push([...t,"Waste",e.wasteType,e.waste.toFixed(2),"","",s])}),e.downtimeEntries&&e.downtimeEntries.length>0&&e.downtimeEntries.forEach(e=>{a.push([...t,"Downtime","","",e.downtimeReason,e.downtime.toString(),s])}),e.wasteEntries&&0!==e.wasteEntries.length||e.downtimeEntries&&0!==e.downtimeEntries.length||a.push([...t,"Summary","",e.totalWaste.toFixed(2),"",e.totalDowntime.toString(),s])});const s=[["Date","Shift","Operator","Machine","Order Number","Product","Batch Number","Entry Type","Waste Type","Waste (kg)","Downtime Reason","Downtime (min)","Submitted At"].join(","),...a.map(e=>e.map(e=>'"'.concat(e,'"')).join(","))].join("\n"),n=new Blob([s],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),o=URL.createObjectURL(n);r.setAttribute("href",o),r.setAttribute("download","".concat(t,".csv")),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)},M="line_speed_",R=e=>{const t=e.match(/^(.+?)\s*-\s*Machine\s*\d+$/i);return t?t[1].trim():e},T=(e,t,a)=>"".concat(M).concat(e,"_").concat(t,"_").concat(a),k=(e,t,a,s)=>{const n=R(e),r=T(n,t,a),o={speed:s,updatedAt:(new Date).toISOString(),updatedBy:e};localStorage.setItem(r,JSON.stringify(o)),console.log("\ud83d\udcbe Saved line speed ".concat(s," PPM for ").concat(n))},$=(e,t,a)=>{const s=R(e),n=T(s,t,a),r=localStorage.getItem(n);if(!r)return null;try{const e=JSON.parse(r);return console.log("\ud83d\udcd6 Loaded line speed ".concat(e.speed," PPM for ").concat(s," (set by ").concat(e.updatedBy,")")),e}catch(o){return null}}}}]);
//# sourceMappingURL=128.fa619193.chunk.js.map