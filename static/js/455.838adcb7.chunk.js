"use strict";(self.webpackChunkwaste_and_downtime_dashboard=self.webpackChunkwaste_and_downtime_dashboard||[]).push([[455],{1455:(e,t,n)=>{n.r(t),n.d(t,{default:()=>u});var s=n(7051),a=n(5043),i=n(8163),r=n(9570),o=n(6446),c=n(1737),l=n(8283),d=n(9216),m=n(6886),h=n(579);const u=()=>{const e=(0,i.Zp)(),[t,n]=(0,a.useState)(""),[u,g]=(0,a.useState)(""),[p,x]=(0,a.useState)(""),[f,b]=(0,a.useState)(""),[v,j]=(0,a.useState)(""),[w,N]=(0,a.useState)([]),[y,S]=(0,a.useState)(!1),[C,k]=(0,a.useState)("bulk"),[E,O]=(0,a.useState)([]),[A,I]=(0,a.useState)({}),[M,_]=(0,a.useState)(!0),[D,P]=(0,a.useState)(!1),[q,B]=(0,a.useState)(null),[T,W]=(0,a.useState)((0,d.PM)()),[R,F]=(0,a.useState)(!1),L=(e,t)=>{B({message:e,type:t}),setTimeout(()=>B(null),4e3)},J=(0,a.useCallback)(async()=>{_(!0);try{const e=(0,l.Rg)();if(O(e),e.length>0&&!t&&n(e[0].id),c.$G){const t=await(0,c._D)(),n={};e.forEach(e=>{n[e.id]=t.filter(t=>t.machine_id===e.id)}),I(n)}}catch(e){console.error("Error loading data:",e),L("Failed to load data","error")}finally{_(!1)}},[t]);(0,a.useEffect)(()=>{J()},[J]);const z=(0,a.useCallback)(e=>{const t=e.trim().toLowerCase();return E.find(e=>e.name.toLowerCase()===t||e.name.toLowerCase().includes(t)||t.includes(e.name.toLowerCase()))},[E]),Y=(0,a.useCallback)(e=>{if(!e.trim())return[];const t=e.split("\n").filter(e=>e.trim()),n=[];for(const s of t){let e=s.split("\t");if(e.length<4&&(e=s.split(",")),e=e.map(e=>e.trim()),e.length>=4){const[t,s,a,i]=e,r=z(t);n.push({machineName:t,machineId:(null===r||void 0===r?void 0:r.id)||"",orderNumber:s,product:a,batchNumber:i,valid:!!r&&!!s&&!!a&&!!i,error:r?s?a?i?void 0:"Missing batch":"Missing product":"Missing order number":'Machine "'.concat(t,'" not found')})}else e.length>0&&e[0]&&n.push({machineName:e[0]||"Unknown",machineId:"",orderNumber:e[1]||"",product:e[2]||"",batchNumber:e[3]||"",valid:!1,error:"Invalid format. Expected: Machine, Order, Product, Batch"})}return n},[z]),U=async(e,t,n)=>{const a=A[e]||[],i=a.findIndex(e=>e.id===t);if(-1===i)return;const r="up"===n?i-1:i+1;if(r<0||r>=a.length)return;const o=[...a];[o[i],o[r]]=[o[r],o[i]],I(t=>(0,s.A)((0,s.A)({},t),{},{[e]:o}));try{const t=o.map(e=>e.id);await(0,c.tj)(e,t)}catch(l){console.error("Error updating order priorities:",l),await J(),L("Failed to reorder","error")}},H=w.filter(e=>e.valid).length,$=w.filter(e=>!e.valid).length;return M?(0,h.jsxs)("div",{className:"admin-console loading",children:[(0,h.jsx)("div",{className:"spinner-v2"}),(0,h.jsx)("p",{children:"Loading order queues..."})]}):(0,h.jsxs)(o.P.div,{className:"admin-console",initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},children:[(0,h.jsx)(r.N,{children:q&&(0,h.jsx)(o.P.div,{className:"toast-container-v2",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},children:(0,h.jsxs)("div",{className:"toast-message-v2 ".concat(q.type),children:[(0,h.jsx)("span",{className:"toast-icon",children:"success"===q.type?"\u2713":"!"}),q.message]})})}),(0,h.jsxs)("header",{className:"admin-header",children:[(0,h.jsxs)("button",{className:"back-btn-v2",onClick:()=>e("/"),children:[(0,h.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:(0,h.jsx)("path",{d:"M19 12H5M12 19l-7-7 7-7"})}),"Back"]}),(0,h.jsxs)("div",{className:"admin-title",children:[(0,h.jsx)("h1",{children:"Admin Console"}),(0,h.jsx)("span",{className:"admin-subtitle",children:"Machine Order Queues"})]})]}),(0,h.jsxs)("main",{className:"admin-main",children:[(0,h.jsxs)("section",{className:"admin-form-section",children:[(0,h.jsxs)("div",{className:"admin-tabs",children:[(0,h.jsxs)("button",{className:"admin-tab ".concat("bulk"===C?"active":""),onClick:()=>k("bulk"),children:[(0,h.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"18",height:"18",children:(0,h.jsx)("path",{d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),"Bulk Import"]}),(0,h.jsxs)("button",{className:"admin-tab ".concat("single"===C?"active":""),onClick:()=>k("single"),children:[(0,h.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"18",height:"18",children:(0,h.jsx)("path",{d:"M12 5v14M5 12h14"})}),"Single Order"]})]}),"bulk"===C?(0,h.jsxs)("div",{className:"admin-form bulk-form",children:[(0,h.jsxs)("div",{className:"form-field",children:[(0,h.jsxs)("label",{className:"form-label",children:["Paste Orders (one per line)",(0,h.jsx)("span",{className:"form-hint",children:"Format: Machine, Order Number, Product, Batch Number"})]}),(0,h.jsx)("textarea",{className:"form-textarea",placeholder:"Example:\nCanline, ORD-001, Product A, BATCH001\nSachet Line, ORD-002, Product B, BATCH002\nCanline, ORD-003, Product C, BATCH003",value:v,onChange:e=>(e=>{j(e);const t=Y(e);N(t),S(t.length>0)})(e.target.value),rows:8})]}),y&&(0,h.jsxs)("div",{className:"bulk-preview",children:[(0,h.jsx)("div",{className:"preview-header",children:(0,h.jsxs)("h3",{children:["Preview (",H," valid, ",$," invalid)"]})}),(0,h.jsx)("div",{className:"preview-list",children:w.map((e,t)=>(0,h.jsxs)("div",{className:"preview-item ".concat(e.valid?"valid":"invalid"),children:[(0,h.jsx)("span",{className:"preview-priority",children:t+1}),(0,h.jsxs)("div",{className:"preview-details",children:[(0,h.jsx)("span",{className:"preview-machine",children:e.machineName}),(0,h.jsx)("span",{className:"preview-order",children:e.orderNumber}),(0,h.jsx)("span",{className:"preview-product",children:e.product}),(0,h.jsx)("span",{className:"preview-batch",children:e.batchNumber})]}),!e.valid&&(0,h.jsx)("span",{className:"preview-error",children:e.error})]},t))})]}),(0,h.jsxs)("div",{className:"admin-actions",children:[(0,h.jsx)("button",{className:"admin-save-btn",onClick:async()=>{const e=w.filter(e=>e.valid);if(0!==e.length){P(!0);try{const t={};e.forEach(e=>{t[e.machineId]||(t[e.machineId]=[]),t[e.machineId].push(e)});for(const e of Object.keys(t)){const n=t[e];for(const e of n)await(0,c.z8)(e.machineId,e.orderNumber,e.product,e.batchNumber)}await J(),L("Successfully imported ".concat(e.length," orders"),"success"),j(""),N([]),S(!1)}catch(t){console.error("Error importing orders:",t),L("Failed to import orders","error")}finally{P(!1)}}else L("No valid orders to import","error")},disabled:D||0===H,children:D?"Importing...":"Import ".concat(H," Orders")}),v&&(0,h.jsx)("button",{className:"admin-clear-btn",onClick:()=>{j(""),N([]),S(!1)},children:"Clear"})]})]}):(0,h.jsxs)("div",{className:"admin-form",children:[(0,h.jsxs)("div",{className:"form-field",children:[(0,h.jsx)("label",{className:"form-label",children:"Machine"}),(0,h.jsxs)("select",{className:"form-input",value:t,onChange:e=>n(e.target.value),children:[(0,h.jsx)("option",{value:"",children:"Select a machine..."}),E.map(e=>(0,h.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,h.jsxs)("div",{className:"form-field",children:[(0,h.jsx)("label",{className:"form-label",children:"Order Number"}),(0,h.jsx)("input",{type:"text",className:"form-input",placeholder:"Enter order number",value:u,onChange:e=>g(e.target.value)})]}),(0,h.jsxs)("div",{className:"form-field",children:[(0,h.jsx)("label",{className:"form-label",children:"Product"}),(0,h.jsx)("input",{type:"text",className:"form-input",placeholder:"Enter product name",value:p,onChange:e=>x(e.target.value)})]}),(0,h.jsxs)("div",{className:"form-field",children:[(0,h.jsx)("label",{className:"form-label",children:"Batch Number"}),(0,h.jsx)("input",{type:"text",className:"form-input",placeholder:"Enter batch number",value:f,onChange:e=>b(e.target.value)})]}),(0,h.jsx)("div",{className:"admin-actions",children:(0,h.jsx)("button",{className:"admin-save-btn",onClick:async()=>{if(t)if(u.trim()&&p.trim()&&f.trim()){P(!0);try{c.$G?(await(0,c.z8)(t,u,p,f),await J(),L("Order added successfully","success"),g(""),x(""),b("")):L("Supabase not configured","error")}catch(e){console.error("Error adding order:",e),L("Failed to add order","error")}finally{P(!1)}}else L("Please fill in all fields","error");else L("Please select a machine","error")},disabled:D,children:D?"Adding...":"Add to Queue"})})]})]}),(0,h.jsxs)("section",{className:"admin-queues-section",children:[(0,h.jsxs)("h2",{className:"section-heading",children:[(0,h.jsx)("span",{className:"section-icon",children:"#"}),"Order Queues by Machine"]}),0===E.length?(0,h.jsxs)("div",{className:"info-card",children:[(0,h.jsx)("span",{className:"info-icon",children:"!"}),(0,h.jsx)("p",{children:"No machines configured. Add machines in Machine Settings first."})]}):(0,h.jsx)("div",{className:"machine-queues-grid",children:E.map(e=>{const t=A[e.id]||[];return(0,h.jsxs)("div",{className:"machine-queue-card",children:[(0,h.jsxs)("div",{className:"machine-queue-header",children:[(0,h.jsx)("h3",{children:e.name}),(0,h.jsxs)("span",{className:"queue-count",children:[t.length," orders"]}),t.length>0&&(0,h.jsx)("button",{className:"clear-queue-btn",onClick:()=>(async e=>{const t=E.find(t=>t.id===e);if(window.confirm("Clear all orders for ".concat((null===t||void 0===t?void 0:t.name)||e,"?")))try{await(0,c.Yc)(e),await J(),L("Orders cleared","success")}catch(n){console.error("Error clearing orders:",n),L("Failed to clear orders","error")}})(e.id),title:"Clear all orders",children:"Clear"})]}),0===t.length?(0,h.jsx)("div",{className:"empty-queue",children:(0,h.jsx)("p",{children:"No orders in queue"})}):(0,h.jsx)("div",{className:"queue-list",children:t.map((n,s)=>(0,h.jsxs)(o.P.div,{className:"queue-item",initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:.05*s},children:[(0,h.jsx)("div",{className:"queue-item-priority",children:s+1}),(0,h.jsxs)("div",{className:"queue-item-details",children:[(0,h.jsx)("div",{className:"queue-order-number",children:n.order_number}),(0,h.jsx)("div",{className:"queue-product",children:n.product}),(0,h.jsxs)("div",{className:"queue-batch",children:["Batch: ",n.batch_number]})]}),(0,h.jsxs)("div",{className:"queue-item-actions",children:[(0,h.jsx)("button",{className:"queue-move-btn",onClick:()=>U(e.id,n.id,"up"),disabled:0===s,title:"Move up",children:(0,h.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:(0,h.jsx)("path",{d:"M18 15l-6-6-6 6"})})}),(0,h.jsx)("button",{className:"queue-move-btn",onClick:()=>U(e.id,n.id,"down"),disabled:s===t.length-1,title:"Move down",children:(0,h.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:(0,h.jsx)("path",{d:"M6 9l6 6 6-6"})})}),(0,h.jsx)("button",{className:"queue-remove-btn",onClick:()=>(async e=>{if(window.confirm("Remove this order from the queue?"))try{await(0,c.mv)(e),await J(),L("Order removed","success")}catch(t){console.error("Error removing order:",t),L("Failed to remove order","error")}})(n.id),title:"Remove order",children:(0,h.jsx)("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",width:"16",height:"16",children:(0,h.jsx)("path",{d:"M18 6L6 18M6 6l12 12"})})})]})]},n.id))})]},e.id)})})]}),(0,h.jsx)("section",{className:"admin-info-section",children:(0,h.jsxs)("div",{className:"info-card",children:[(0,h.jsx)("span",{className:"info-icon",children:"i"}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Bulk Import:"})," Paste from Excel or CSV. Each line: Machine, Order, Product, Batch. Top to bottom = priority order (1st line = highest priority)."]})]})}),(0,h.jsxs)("section",{className:"admin-settings-section",children:[(0,h.jsxs)("div",{className:"settings-header",onClick:()=>F(!R),children:[(0,h.jsxs)("h2",{className:"section-heading",children:[(0,h.jsx)("span",{className:"section-icon",children:"\u2699"}),"Facility Settings"]}),(0,h.jsx)("span",{className:"expand-icon ".concat(R?"expanded":""),children:R?"\u2212":"+"})]}),(0,h.jsx)(r.N,{children:R&&(0,h.jsxs)(o.P.div,{className:"settings-panel",initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},children:[(0,h.jsxs)("div",{className:"settings-grid",children:[(0,h.jsxs)("div",{className:"settings-group",children:[(0,h.jsx)("h3",{children:"Shift Times"}),(0,h.jsxs)("div",{className:"settings-row",children:[(0,h.jsx)("label",{children:"Day Shift Start"}),(0,h.jsx)("select",{value:T.dayShiftStart,onChange:e=>W(t=>(0,s.A)((0,s.A)({},t),{},{dayShiftStart:parseInt(e.target.value)})),children:Array.from({length:24},(e,t)=>(0,h.jsxs)("option",{value:t,children:[t.toString().padStart(2,"0"),":00"]},t))})]}),(0,h.jsxs)("div",{className:"settings-row",children:[(0,h.jsx)("label",{children:"Day Shift End"}),(0,h.jsx)("select",{value:T.dayShiftEnd,onChange:e=>W(t=>(0,s.A)((0,s.A)({},t),{},{dayShiftEnd:parseInt(e.target.value)})),children:Array.from({length:24},(e,t)=>(0,h.jsxs)("option",{value:t,children:[t.toString().padStart(2,"0"),":00"]},t))})]}),(0,h.jsxs)("div",{className:"settings-preview",children:["Current: Day ",(0,d.sX)().day,", Night ",(0,d.sX)().night]})]}),(0,h.jsxs)("div",{className:"settings-group",children:[(0,h.jsx)("h3",{children:"Timezone"}),(0,h.jsxs)("div",{className:"settings-row",children:[(0,h.jsx)("label",{children:"UTC Offset"}),(0,h.jsx)("select",{value:T.timezoneOffset,onChange:e=>W(t=>(0,s.A)((0,s.A)({},t),{},{timezoneOffset:parseInt(e.target.value)})),children:Array.from({length:25},(e,t)=>t-12).map(e=>(0,h.jsxs)("option",{value:e,children:["UTC",e>=0?"+":"",e]},e))})]})]}),(0,h.jsxs)("div",{className:"settings-group",children:[(0,h.jsx)("h3",{children:"Submission Window"}),(0,h.jsxs)("div",{className:"settings-row",children:[(0,h.jsx)("label",{children:"Window Size (minutes)"}),(0,h.jsx)("input",{type:"number",min:"5",max:"60",value:T.submissionWindowMinutes,onChange:e=>W(t=>(0,s.A)((0,s.A)({},t),{},{submissionWindowMinutes:parseInt(e.target.value)||15}))})]}),(0,h.jsx)("div",{className:"settings-hint",children:"Time before/after shift end when submissions are allowed"})]}),(0,h.jsxs)("div",{className:"settings-group",children:[(0,h.jsx)("h3",{children:"Session Locking"}),(0,h.jsx)("div",{className:"settings-row checkbox-row",children:(0,h.jsxs)("label",{children:[(0,h.jsx)("input",{type:"checkbox",checked:T.sessionLockingEnabled,onChange:e=>W(t=>(0,s.A)((0,s.A)({},t),{},{sessionLockingEnabled:e.target.checked}))}),"Enable session locking"]})}),(0,h.jsx)("div",{className:"settings-hint",children:"Prevents multiple users from editing the same shift"})]}),(0,h.jsxs)("div",{className:"settings-group",children:[(0,h.jsx)("h3",{children:"Facility Info"}),(0,h.jsxs)("div",{className:"settings-row",children:[(0,h.jsx)("label",{children:"Name"}),(0,h.jsx)("input",{type:"text",value:T.facilityName,onChange:e=>W(t=>(0,s.A)((0,s.A)({},t),{},{facilityName:e.target.value}))})]}),(0,h.jsxs)("div",{className:"settings-row",children:[(0,h.jsx)("label",{children:"Location"}),(0,h.jsx)("input",{type:"text",value:T.facilityLocation,onChange:e=>W(t=>(0,s.A)((0,s.A)({},t),{},{facilityLocation:e.target.value}))})]})]})]}),(0,h.jsxs)("div",{className:"settings-actions",children:[(0,h.jsx)("button",{className:"admin-save-btn",onClick:()=>{try{const e=(0,d.W8)(T);W(e),(0,m.Te)("Facility settings saved"),F(!1)}catch(e){(0,m.Qg)("Failed to save settings")}},children:"Save Settings"}),(0,h.jsx)("button",{className:"admin-clear-btn",onClick:()=>{if(window.confirm("Reset all facility settings to defaults?")){const e=(0,d.K6)();W(e),(0,m.Te)("Settings reset to defaults")}},children:"Reset to Defaults"})]})]})})]})]}),(0,h.jsx)("style",{children:'\n                .admin-settings-section {\n                    margin-top: 2rem;\n                    background: #1a1a2e;\n                    border-radius: 12px;\n                    border: 1px solid rgba(255, 255, 255, 0.1);\n                    overflow: hidden;\n                }\n\n                .settings-header {\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: center;\n                    padding: 1rem 1.5rem;\n                    cursor: pointer;\n                    transition: background 0.2s;\n                }\n\n                .settings-header:hover {\n                    background: rgba(255, 255, 255, 0.05);\n                }\n\n                .settings-header .section-heading {\n                    margin: 0;\n                    font-size: 1.1rem;\n                }\n\n                .expand-icon {\n                    font-size: 1.5rem;\n                    color: #20C997;\n                    transition: transform 0.2s;\n                }\n\n                .expand-icon.expanded {\n                    transform: rotate(180deg);\n                }\n\n                .settings-panel {\n                    border-top: 1px solid rgba(255, 255, 255, 0.1);\n                    padding: 1.5rem;\n                    overflow: hidden;\n                }\n\n                .settings-grid {\n                    display: grid;\n                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n                    gap: 1.5rem;\n                }\n\n                .settings-group {\n                    background: rgba(0, 0, 0, 0.2);\n                    padding: 1rem;\n                    border-radius: 8px;\n                }\n\n                .settings-group h3 {\n                    margin: 0 0 1rem 0;\n                    font-size: 0.9rem;\n                    color: #20C997;\n                    text-transform: uppercase;\n                    letter-spacing: 0.05em;\n                }\n\n                .settings-row {\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: center;\n                    margin-bottom: 0.75rem;\n                }\n\n                .settings-row label {\n                    color: rgba(255, 255, 255, 0.8);\n                    font-size: 0.9rem;\n                }\n\n                .settings-row select,\n                .settings-row input[type="number"],\n                .settings-row input[type="text"] {\n                    background: #16213e;\n                    border: 1px solid rgba(255, 255, 255, 0.2);\n                    border-radius: 4px;\n                    padding: 0.5rem;\n                    color: #fff;\n                    min-width: 100px;\n                }\n\n                .settings-row select:focus,\n                .settings-row input:focus {\n                    outline: none;\n                    border-color: #20C997;\n                }\n\n                .checkbox-row label {\n                    display: flex;\n                    align-items: center;\n                    gap: 0.5rem;\n                    cursor: pointer;\n                }\n\n                .checkbox-row input[type="checkbox"] {\n                    width: 18px;\n                    height: 18px;\n                    accent-color: #20C997;\n                }\n\n                .settings-preview {\n                    font-size: 0.8rem;\n                    color: rgba(255, 255, 255, 0.5);\n                    margin-top: 0.5rem;\n                }\n\n                .settings-hint {\n                    font-size: 0.75rem;\n                    color: rgba(255, 255, 255, 0.4);\n                    margin-top: 0.25rem;\n                }\n\n                .settings-actions {\n                    display: flex;\n                    gap: 1rem;\n                    margin-top: 1.5rem;\n                    padding-top: 1rem;\n                    border-top: 1px solid rgba(255, 255, 255, 0.1);\n                }\n            '})]})}},6451:(e,t,n)=>{n.d(t,{PY:()=>s,rE:()=>a,wK:()=>i});const s=[],a=["Start-up Waste","Changeover Waste","Defective Product","Material Spillage"],i=["Machine Breakdown","Scheduled Maintenance","Changeover","Material Shortage"]},8283:(e,t,n)=>{n.d(t,{Bh:()=>l,D$:()=>h,F$:()=>S,GF:()=>M,Hc:()=>j,IN:()=>N,LO:()=>y,Rg:()=>k,Rn:()=>A,bR:()=>v,mg:()=>u,nN:()=>d,te:()=>E,zl:()=>O});var s=n(7051),a=n(6451),i=n(1737);const r="waste_downtime_history",o="machines_data",c="failed_submissions_queue",l=()=>{const e=localStorage.getItem(c);if(!e)return[];try{return JSON.parse(e)}catch(t){return[]}},d=(e,t)=>{const n=l(),s={id:"failed_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:(new Date).toISOString(),retryCount:0,maxRetries:3,data:e,error:t};n.push(s),localStorage.setItem(c,JSON.stringify(n))},m=e=>{const t=l().filter(t=>t.id!==e);localStorage.setItem(c,JSON.stringify(t))},h=async()=>{if(!i.$G)return{succeeded:0,failed:0,remaining:l().length};const e=l();let t=0,n=0;for(const r of e)if(r.retryCount>=r.maxRetries)n++;else try{await(0,i.jw)(r.data.shiftData,r.data.wasteEntries,r.data.downtimeEntries,r.data.speedEntries,r.data.sachetMassEntries,r.data.looseCasesEntries,r.data.palletScanEntries),m(r.id),t++}catch(a){const e=l().map(e=>e.id===r.id?(0,s.A)((0,s.A)({},e),{},{retryCount:e.retryCount+1,error:String(a)}):e);localStorage.setItem(c,JSON.stringify(e)),n++}return{succeeded:t,failed:n,remaining:l().length}},u=()=>{const e="last_storage_cleanup",t=localStorage.getItem(e),n=new Date;if(t){const e=new Date(t);if((n.getTime()-e.getTime())/36e5<24)return}const s=(()=>{const e=y(),t=new Date,n=new Date(t.getTime()-7776e6);let s=e.filter(e=>new Date(e.date)>=n);s.length>1e3&&(s=s.slice(0,1e3));const a=e.length-s.length;return a>0&&(localStorage.setItem(r,JSON.stringify(s)),console.log("Cleaned up ".concat(a," old history entries"))),{removed:a,remaining:s.length}})();localStorage.setItem(e,n.toISOString()),s.removed>0&&console.log("Storage cleanup: removed ".concat(s.removed," entries, ").concat(s.remaining," remaining"))};let g=!0,p=null,x=[];const f=e=>({id:e.id,name:e.name,status:e.status,currentOperator:e.current_operator,currentOrder:e.current_order,currentShift:e.current_shift,lastSubmission:e.last_submission,todayWaste:e.today_waste,todayDowntime:e.today_downtime,subMachineCount:e.sub_machine_count}),b=e=>({id:e.id,name:e.name,status:e.status,current_operator:e.currentOperator,current_order:e.currentOrder,current_shift:e.currentShift,last_submission:e.lastSubmission,today_waste:e.todayWaste,today_downtime:e.todayDowntime,sub_machine_count:e.subMachineCount}),v=async()=>{try{const e=await(0,i.Dn)();if(e.length>0)return p=e.map(f),localStorage.setItem(o,JSON.stringify(p)),localStorage.setItem("machines_last_sync",(new Date).toISOString()),p;{console.log("No machines in Supabase, syncing defaults...");const e=a.PY.map(b);return await(0,i.ri)(e),p=a.PY,localStorage.setItem(o,JSON.stringify(a.PY)),a.PY}}catch(e){return console.error("Failed to initialize from Supabase, using localStorage:",e),g=!1,w()}},j=e=>{x.push(e);const t=(0,i.RS)(e=>{p=e.map(f),localStorage.setItem(o,JSON.stringify(p)),x.forEach(e=>e(p))},()=>(p||w()).map(b));return()=>{x=x.filter(t=>t!==e),0===x.length&&t()}},w=()=>{const e=localStorage.getItem(o);if(!e)return localStorage.setItem(o,JSON.stringify(a.PY)),a.PY;try{return JSON.parse(e)}catch(t){return a.PY}},N=e=>{const t=y();t.unshift(e),localStorage.setItem(r,JSON.stringify(t)),C(e.machine,e.submittedAt.toISOString())},y=()=>{const e=localStorage.getItem(r);if(!e)return[];try{return JSON.parse(e).map(e=>(0,s.A)((0,s.A)({},e),{},{submittedAt:new Date(e.submittedAt),wasteEntries:e.wasteEntries.map(e=>(0,s.A)((0,s.A)({},e),{},{timestamp:new Date(e.timestamp)})),downtimeEntries:e.downtimeEntries.map(e=>(0,s.A)((0,s.A)({},e),{},{timestamp:new Date(e.timestamp)}))}))}catch(t){return[]}},S=()=>{const e=(new Date).toISOString().split("T")[0],t=y().filter(t=>t.date===e);return{totalWaste:t.reduce((e,t)=>e+t.totalWaste,0),totalDowntime:t.reduce((e,t)=>e+t.totalDowntime,0),submissionCount:t.length}},C=(e,t)=>{const n=k(),s=n.findIndex(t=>t.name===e);-1!==s&&(n[s].lastSubmission=I(new Date(t))),localStorage.setItem(o,JSON.stringify(n))},k=()=>p||w(),E=async(e,t)=>{const n=k(),a=n.findIndex(t=>t.id===e);if(-1!==a&&(n[a]=(0,s.A)((0,s.A)({},n[a]),t),p=n,localStorage.setItem(o,JSON.stringify(n)),g))try{await(0,i.hx)(b(n[a]))}catch(r){console.error("Failed to sync machine update to Supabase:",r)}},O=async e=>{const t=k();if(t.push(e),p=t,localStorage.setItem(o,JSON.stringify(t)),g)try{await(0,i.hx)(b(e))}catch(n){console.error("Failed to sync new machine to Supabase:",n)}},A=async e=>{const t=k().filter(t=>t.id!==e);if(p=t,localStorage.setItem(o,JSON.stringify(t)),g)try{await(0,i._T)(e)}catch(n){console.error("Failed to delete machine from Supabase:",n)}},I=e=>{const t=(new Date).getTime()-e.getTime(),n=Math.floor(t/6e4),s=Math.floor(n/60),a=Math.floor(s/24);return n<1?"Just now":n<60?"".concat(n," min ago"):s<24?"".concat(s," hour").concat(s>1?"s":""," ago"):"".concat(a," day").concat(a>1?"s":""," ago")},M=(e,t)=>{const n=[];e.forEach(e=>{const t=[e.date,e.shift,e.operatorName,e.machine,e.orderNumber,e.product,e.batchNumber],s=new Date(e.submittedAt).toLocaleString();e.wasteEntries&&e.wasteEntries.length>0&&e.wasteEntries.forEach(e=>{n.push([...t,"Waste",e.wasteType,e.waste.toFixed(2),"","",s])}),e.downtimeEntries&&e.downtimeEntries.length>0&&e.downtimeEntries.forEach(e=>{n.push([...t,"Downtime","","",e.downtimeReason,e.downtime.toString(),s])}),e.wasteEntries&&0!==e.wasteEntries.length||e.downtimeEntries&&0!==e.downtimeEntries.length||n.push([...t,"Summary","",e.totalWaste.toFixed(2),"",e.totalDowntime.toString(),s])});const s=[["Date","Shift","Operator","Machine","Order Number","Product","Batch Number","Entry Type","Waste Type","Waste (kg)","Downtime Reason","Downtime (min)","Submitted At"].join(","),...n.map(e=>e.map(e=>'"'.concat(e,'"')).join(","))].join("\n"),a=new Blob([s],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),r=URL.createObjectURL(a);i.setAttribute("href",r),i.setAttribute("download","".concat(t,".csv")),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}}}]);
//# sourceMappingURL=455.838adcb7.chunk.js.map